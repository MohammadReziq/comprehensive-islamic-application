# خطة: الابن في مسجدين · الملاحظات vs الإعلانات · المسابقة والإمام

> **الإصدار:** 1.2  
> **الهدف:** توحيد التعامل مع (1) ابن مشارك في مسجدين وتجربة مستخدم واضحة لكل ابن، (2) **مشرف مشارك بأكثر من مسجد** وواجهة متسقة له، (3) فصل تسمية الملاحظات عن الإعلانات، (4) سلوك الواجهة عند لم تبدأ المسابقة / جارية / انتهت وترابطها مع لوحة الإمام، (5) **تحكم الإمام الكامل بالمسابقة** (إنشاء، تعديل، تأجيل، تفعيل، إيقاف، حذف — كل شيء)، (6) **اتساق المنطق** بحيث لا يرى المشرف "سجّل الحضور" والمسابقة لسا ما بلشت، (7) فصل كامل للأدوار، (8) تحديث البيانات عند العودة، (9) مراجعة لما قد لا يعمل أو يُغفل عنه.

---

## 1. الابن المشارك في مسجدين — تجربة مستخدم مناسبة

### 1.1 الوضع الحالي

- الابن يمكن أن يكون مرتبطاً بأكثر من مسجد (جدول `mosque_children` مع `type`: أساسي / إضافي).
- في **الصفحة الرئيسية لولي الأمر** (`HomeScreen`): حالة المسابقة تُجلب من **أي** مسجد لأي ابن — أول مسابقة غير `noCompetition` تُعرض (جارية أو قادمة أو منتهية). لا تمييز بين أبناء ولا بين مساجد.
- في **بطاقة الابن** (`ChildCardScreen`): يتم التحقق من وجود مسابقة جارية في **أي** مسجد مرتبط بالابن؛ إن وُجدت تظهر "طلب تصحيح". لا يُعرض لكل مسجد على حدة (مسابقة جارية في مسجد أ ولا شيء في مسجد ب).
- في **طلب التصحيح** (`RequestCorrectionScreen`): يختار ولي الأمر الابن ثم المسجد ثم الصلاة — أي مسجد مرتبط بالابن يظهر. المنطق سليم لكن التوجيه من الشاشات السابقة قد يسبب التباساً إذا كان ابن في مسجدين وواحدة فقط فيها مسابقة.

### 1.2 المبادئ المستهدفة

| المبدأ | الوصف |
|--------|--------|
| **وضوح لكل ابن** | ولي الأمر يفهم من أول نظرة: هذا الابن في أي مسجد/مساجد، وفي أي منها مسابقة (لم تبدأ / جارية / انتهت). |
| **عدم الخلط بين المساجد** | الإعلانات والملاحظات والمسابقة تُربط دائماً بمسجد معيّن أو بابن (وبالتالي مسجده/مساجده). |
| **طلب التصحيح دقيق** | يظهر فقط عندما يكون للابن على الأقل مسجد فيه مسابقة **جارية**؛ النص يوضح أن التصحيح للمسابقة الحالية. |

### 1.3 خطة التعامل (ولي الأمر)

1. **الصفحة الرئيسية (Home):**
   - **بانر المسابقة:** بدل عرض حالة مسابقة واحدة غامضة، يمكن:
     - **خيار أ (بسيط):** الإبقاء على العرض الحالي (أول مسابقة من مساجد الأبناء) مع تحسين النص: مثلاً "مسابقة [اسم المسجد] فعّالة الآن" أو "مسابقة قادمة في [اسم المسجد]" حتى يعرف ولي الأمر لأي مسجد الخبر.
     - **خيار ب (واضح أكثر):** عرض ملخص يجمّع: "لديك ابن في مسابقة جارية (مسجد X)" و/أو "ابن في مسابقة قادمة (مسجد Y)" مع روابط سريعة لأبنائي أو لطلب التصحيح.
   - **زر "طلب تصحيح":** يظهر فقط إذا وُجد على الأقل ابن له مسجد بمسابقة **جارية**. النص يمكن أن يبقى "طلب تصحيح" أو يُصاغ "طلب تصحيح (للمسابقة الجارية)" لتوضيح السياق.

2. **شاشة أبنائي (ChildrenScreen):**
   - كل **بطاقة ابن** تعرض بشكل مختصر:
     - المسجد/المساجد المرتبطة (اسم أو "مرتبط بمسجدين" مع تفاصيل عند الضغط).
     - إن أمكن: حالة المسابقة **لهذا الابن** (مثلاً: "مسابقة جارية في مسجد النور" أو "لا مسابقة حالياً" أو "مسابقة قادمة في مسجد الرحمة").
   - هذا يقلل الالتباس عندما يكون ابن ما لم يبدأ المسابقة في مسجده وابن آخر في مسجد آخر بدأت فيه المسابقة.

3. **بطاقة الابن (ChildCardScreen):**
   - عند **مسجد واحد:** عرض حالة المسابقة لهذا المسجد (لا مسابقة / قادمة / جارية / منتهية) مع تاريخ بداية ونهاية إن وُجدت.
   - عند **مسجدين أو أكثر:** قائمة مساجد قابلة للتوسيع، **تحت كل مسجد**:
     - اسم المسجد، الرقم المحلي، وحالة المسابقة لهذا المسجد فقط (لا مسابقة، قادمة، جارية، منتهية).
   - **"طلب تصحيح":** يظهر فقط إذا كان هناك **على الأقل مسجد واحد** له مسابقة جارية، مع نص توضيحي مثل "طلب تصحيح حضور في مسابقة [اسم المسجد]".

4. **طلب التصحيح (RequestCorrectionScreen):**
   - في قائمة المساجد: عرض **فقط المساجد التي فيها مسابقة جارية** للابن المختار (إن وُجدت). إن كل مساجد الابن بدون مسابقة جارية، إظهار رسالة: "لا توجد مسابقة جارية لـ [اسم الابن] في أي مسجد مرتبط".
   - يحافظ على وضوح الربط: التصحيح للمسابقة الجارية في مسجد معيّن.

### 1.4 التبعيات التقنية

- **CompetitionRepository:** يوجد بالفعل `getCompetitionStatus(mosqueId)` و `getActiveForMosques(mosqueIds)`. كافي لدعم "حالة لكل مسجد".
- **ChildRepository / ChildCardScreen:** جلب مساجد الابن مع أسمائها موجود. يبقى إثراء كل مسجد بـ `getCompetitionStatus(mosqueId)` عند العرض (أو دالة واحدة تجلب كل الحالات لعدة مساجد دفعة واحدة لتفادي N+1).
- **HomeScreen:** حالياً `_loadCompetitionStatus` يمر على مساجد الأبناء ويأخذ أول نتيجة غير noCompetition. للتوسع لاحقاً: يمكن استبدالها بجلب كل الحالات ثم اختيار ما يُعرض في البانر (مثلاً أول مسابقة جارية، ثم قادمة، ثم منتهية) مع ذكر اسم المسجد في النص.

---

## 2. تسمية "الرسائل" → "الملاحظات" فقط (منع تكرار الإعلانات)

### 2.1 الوضع الحالي

- في **الصفحة الرئيسية لولي الأمر:** يوجد إجراءان:
  - **"الرسائل"** (أيقونة forum) → يفتح `/parent/inbox` = `ParentInboxScreen`.
  - **"الإعلانات"** (أيقونة campaign) → يفتح `/parent/announcements` = `ParentAnnouncementsScreen`.
- `ParentInboxScreen` يعرض **كل شيء معاً**: تبويبات "الكل" و"إعلانات" و"ملاحظات" — أي الإعلانات تظهر هنا **وفي** شاشة الإعلانات، مما يسبب تكراراً وتشويشاً.

### 2.2 القرار المستهدف

- **"الرسائل"** في الرئيسية تُعاد تسميتها إلى **"الملاحظات"** وتصبح **للملاحظات فقط** (ملاحظات المشرف/الإمام لأبنائي)، دون خلط مع الإعلانات.
- **"الإعلانات"** تبقى شاشة مستقلة للإعلانات فقط.
- منع تكرار الإعلانات: ألا تظهر الإعلانات داخل نفس القائمة التي نسميها "الملاحظات".

### 2.3 خطة التنفيذ

| الخطوة | الوصف |
|--------|--------|
| 1 | في **HomeScreen:** تغيير نص الإجراء من "الرسائل" إلى **"الملاحظات"**، وتغيير الوجهة من `/parent/inbox` إلى **`/parent/notes`** (شاشة `NotesInboxScreen` — ملاحظات فقط). |
| 2 | تحديث **عداد غير المقروء:** عداد "الملاحظات" يبقى عدد الملاحظات غير المقروءة فقط (لا يدخل فيه الإعلانات). هذا متحقق حالياً إن كان `_unreadCount` من الملاحظات فقط. |
| 3 | **مصير ParentInboxScreen (/parent/inbox):** إما (أ) إزالة الرابط من الواجهة وإبقاء المسار للتوافق الخلفي أو إعادة توجيهه إلى `/parent/notes`، أو (ب) حذف الشاشة والمسار لاحقاً إن لم تُعد هناك حاجة لصندوق "الكل". يفضّل (أ) في البداية: لا نفتح "الرسائل" من أي مكان في واجهة ولي الأمر، ونوجّه "الملاحظات" إلى `/parent/notes`. |
| 4 | التأكد أن **NotesInboxScreen** يعرض عنواناً مثل "الملاحظات" أو "ملاحظات المشرف" وليس "الرسائل" حتى لا يختلط مع الإعلانات في ذهن المستخدم. |

### 2.4 ملخص التسميات بعد التعديل

| المكان | قبل | بعد |
|--------|-----|-----|
| الرئيسية — إجراء أول | الرسائل | **الملاحظات** (→ ملاحظات فقط) |
| الرئيسية — إجراء ثاني | الإعلانات | الإعلانات (بدون تغيير) |
| شاشة الملاحظات | ملاحظات المشرف / الرسائل | **الملاحظات** (واضح أنها من المشرف/الإمام عن الأبناء) |

---

## 3. تعامل تجربة المستخدم مع حالة المسابقة (لم تبدأ / جارية / انتهت) والترابط مع الإمام

### 3.1 حالات المسابقة من منظور النظام

| الحالة | المعنى | من يحددها |
|--------|--------|-----------|
| **لا مسابقة** (`noCompetition`) | لا توجد مسابقات لهذا المسجد. | عدم إنشاء مسابقة أو عدم تفعيل أي منها. |
| **قادمة** (`upcoming`) | توجد مسابقة بوقت بدء في المستقبل، وغير مفعّلة بعد. | الإمام ينشئ المسابقة ولا يفعّلها حتى موعد البدء. |
| **جارية** (`running`) | مسابقة مفعّلة (`is_active = true`) واليوم ضمن [start_date, end_date]. | الإمام يفعّل المسابقة (RPC `activate_competition`). |
| **منتهية** (`finished`) | انتهى وقت المسابقة (أو أُوقفت يدوياً). | مرور الوقت أو إيقاف الإمام (`deactivate`). |

### 3.2 تجربة ولي الأمر حسب الحالة

- **لا مسابقة:** لا يظهر زر "طلب تصحيح". يمكن عرض رسالة توجيهية في بطاقة الابن أو في "أبنائي": "لا توجد مسابقة حالياً في مسجد [الاسم]" أو ببساطة عدم إظهار بانر مسابقة في الرئيسية.
- **مسابقة قادمة:** عرض بانر/نص مثل "مسابقة قادمة في [اسم المسجد] — تبدأ في [التاريخ]". لا يظهر "طلب تصحيح" (لأن التصحيح للحضور خلال المسابقة فقط).
- **مسابقة جارية:** عرض "المسابقة فعّالة الآن — حتى [نهاية المسابقة]" مع زر "طلب تصحيح". في بطاقة الابن: توضيح أن هذا المسجد فيه مسابقة جارية.
- **مسابقة منتهية:** عرض "انتهت المسابقة" مع تاريخ أو "انتظر الموسم القادم". لا زر تصحيح. يمكن لاحقاً إضافة رابط لنتائج المسابقة أو لوحة الشرف النهائية إن وُجدت.

### 3.3 تجربة الإمام — تحكم كامل بالمسابقة والترابط مع الحالات

- **إنشاء مسابقة:** الإمام ينشئ مسابقة (اسم، تاريخ بداية، تاريخ نهاية) دون تفعيلها → تظهر كـ **قادمة** لولي الأمر والابن حتى يتم التفعيل.
- **تفعيل المسابقة:** عند موعد البدء (أو عندما يقرر الإمام)، يفعّل المسابقة → تصبح **جارية**. من هذه اللحظة الحضور يُحسب ضمن المسابقة وولي الأمر يرى "طلب تصحيح".
- **إيقاف المسابقة:** الإمام يمكنه إيقاف المسابقة قبل انتهاء الموعد → تصبح **منتهية** (لا تصحيح، لا إضافة حضور للمسابقة).
- **بعد انتهاء الموعد:** تلقائياً المسابقة تصبح منتهية (حسب `getCompetitionStatus`).

#### 3.3.1 تحكم الإمام بكل شيء في المسابقة (كل شيء كل شيء كل شيء)

الإمام يتحكم **بالكامل** بدورة حياة المسابقة — لا يقتصر على إنشاء وتفعيل وإيقاف، بل:

| الإجراء | الوصف |
|---------|--------|
| **إنشاء** | إنشاء مسابقة جديدة (اسم، تاريخ بداية، تاريخ نهاية). |
| **تعديل** | تعديل الاسم، أو **تأجيل** المسابقة بتعديل تاريخ البداية و/أو النهاية (قبل أو بعد التفعيل). |
| **تفعيل** | جعل المسابقة نشطة (`is_active = true`) بحيث يُحسب الحضور ضمنها. |
| **إيقاف** | إيقاف المسابقة قبل انتهاء الموعد (`is_active = false`). |
| **حذف** | حذف المسابقة من النظام (مع مراعاة وجود سجلات حضور مرتبطة — إما منع الحذف إن وُجدت أو حذف منطقي/أرشفة). |

المطلوب في الخطة والتنفيذ لاحقاً:

- واجهة الإمام توفّر **كل** هذه الإجراءات: إنشاء، تعديل (وتأجيل عبر تعديل التواريخ)، تفعيل، إيقاف، **وحذف** إن كان منطقياً في المنتج.
- أي قيد (مثلاً عدم حذف مسابقة فيها حضور مسجّل) يُحدد في المواصفات ويُطبّق في الـ API والواجهة بشكل متسق.
- النص والترتيب في الشاشة يجعل واضحاً أن الإمام "صاحب القرار الكامل" على المسابقة في مسجده.

### 3.4 صعوبة التجربة — تبسيط الواجهة

- **الرئيسية:** عدم تحميل ولي الأمر بمعلومات كثيرة: بانر واحد واضح (جارية أو قادمة أو منتهية) مع اسم المسجد إن أمكن، وزر واحد لطلب التصحيح عند الجارية فقط.
- **بطاقة الابن:** عند أكثر من مسجد — قائمة مساجد مع حالة كل مسجد تحت اسمه؛ لا داعي لتفاصيل إضافية إلا عند النقر أو التوسيع.
- **طلب التصحيح:** خطوات بسيطة: اختيار الابن → اختيار المسجد (فقط المساجد ذات المسابقة الجارية) → اختيار الصلاة → إرسال. رسائل الخطأ واضحة: "لا توجد مسابقة جارية لهذا الابن في أي مسجد".

---

## 6. فصل الأدوار بشكل كامل (إمام · مشرف · سوبر أدمن)

### 6.1 المبدأ

- **الإمام** يتحكم بكل ما يخص المسجد: المسابقة، المشرفين، الإعلانات، إعدادات المسجد، نقاط الصلوات، تقارير الحضور، طلبات التصحيح. مع ذلك **لا نريد أن نوجع رأسه** بعمل المشرف اليومي؛ نريده يركّز على الإدارة.
- **المشرف** شغله الأساسي: تسجيل الحضور، إرسال الملاحظات، (وربما عرض طلبات التصحيح للمسجد). لا يتحكم بالمسابقة ولا بالإعلانات ولا بإعدادات المسجد — هذه للإمام.
- **السوبر أدمن** يتحكم بكل ما يناسبه: مساجد، موافقات، تعليق، تغيير إمام، إلخ.

### 6.2 الإمام ووظيفة المشرف

- **القرار:** الإمام يبقى قادراً على أن يشتغل شغل المشرف إذا احتاج (نفس الصلاحيات من ناحية البيانات)، لكن في الواجهة **نخفّف عليه**:
  - **إخفاء أو تخفيف تسجيل الحضور:** في لوحة الإمام لا نعرض زر "تسجيل الحضور" / السكانر بشكل بارز — أو نضعه في قسم ثانوي (مثلاً "أدوات مساعدة" أو "تسجيل حضور كمساعد"). الهدف: المشرف هو من يسجّل الحضور عادة؛ الإمام يشرف ولا يُربَك بعرض نفس واجهة المشرف كأمر أساسي.
  - **الاحتفاظ بإمكانية الوصول:** إن رغب الإمام بتسجيل الحضور بنفسه، يمكن أن يصل إلى شاشة التسجيل من مكان واحد واضح (رابط ثانوي أو من قائمة)، دون أن يكون هذا هو المحور في لوحته.
- **لوحة الإمام تركّز على:** المسابقة، المشرفين، الإعلانات، إعدادات المسجد، تقارير الحضور، طلبات التصحيح. لا نجعله يرى "سجّل حضور" كإجراء رئيسي في الصفحة الأولى.

### 6.3 المشرف

- **يظهر له بوضوح:** تسجيل الحضور (سكانر)، الطلاب، الملاحظات، (طلبات التصحيح إن كانت الصلاحيات تسمح). لا يظهر له إدارة المسابقة ولا الإعلانات ولا إعدادات المسجد — هذه تبقى تحت مسارات الإمام فقط أو يُمنع وصوله لها من الروتر/الواجهة حسب الدور.

### 6.4 السوبر أدمن

- يتحكم بكل ما هو مناسب لمسؤول النظام: قائمة المساجد، الموافقة/الرفض، التعليق، تغيير إمام المسجد، تحديث الموقع، إلخ. لا خلط بين واجهته وواجهة الإمام أو المشرف؛ كل دور له مساراته وواجهاته.

### 6.5 خطة التنفيذ (للتطوير لاحقاً)

| العنصر | الوصف |
|--------|--------|
| **تمييز الدور في الروتر** | التأكد أن المسارات التي تخص الإمام فقط (إدارة المسابقة، الإعلانات، إعدادات المسجد) لا تُعرض أو لا تُفتح للمشرف إلا إن كان نفس الشخص إماماً ومشرفاً. |
| **لوحة الإمام** | إزالة أو تخفيف "تسجيل الحضور" من الإجراءات الرئيسية؛ نقله إلى قسم ثانوي أو رابط "تسجيل حضور (كمساعد)" حتى لا نوجع رأس الإمام. |
| **لوحة المشرف** | الإبقاء على تسجيل الحضور والطلاب والملاحظات كأساس؛ منع الوصول إلى إدارة المسابقة والإعلانات وإعدادات المسجد إن كان دوره مشرف فقط. |
| **السوبر أدمن** | مراجعة أن كل الصلاحيات المنطقية موجودة في لوحته دون تعارض مع أدوار المسجد. |

### 6.6 المشرف المشارك بأكثر من مسجد

- **الواقع:** المشرف قد يكون عضواً في أكثر من مسجد (جدول `mosque_members` يربط المستخدم بعدة مساجد بدور مشرف أو مالك). واجهته يجب أن تتعامل مع هذا بشكل واضح ومنطقي.
- **المبادئ:**
  - **سياق مسجد واحد في كل مرة:** عند تسجيل الحضور أو إرسال ملاحظة أو عرض الطلاب أو طلبات التصحيح، يجب أن يكون واضحاً **أي مسجد** المعني — إما باختيار مسجد حالي (مُختار) أو بدخول من لوحة تعرض قائمة المساجد ثم الدخول إلى مسجد معيّن.
  - **لا خلط بين المساجد:** لا نعرض "سجّل حضور" بدون سياق مسجد؛ لا نعرض طلاب مسجد أ مع إعلانات مسجد ب دون تمييز.
- **خطة التعامل:**
  1. **لوحة المشرف (الداشبورد):** إن كان المشرف في مسجد واحد — عرض مباشر لهذا المسجد مع الإجراءات (تسجيل حضور، طلاب، ملاحظات، طلبات تصحيح إن وُجدت). إن كان في **أكثر من مسجد** — عرض قائمة المساجد (أو بطاقات مساجد) مع اسم كل مسجد وحالة المسابقة له إن أمكن؛ عند النقر على مسجد ننتقل إلى "وضع هذا المسجد" (نفس الشاشات لكن بسياق mosqueId واضح).
  2. **تسجيل الحضور:** دائماً مرتبط بمسجد مُختار. إن دخل من قائمة مساجد → يختار المسجد ثم يفتح شاشة التسجيل لهذا المسجد. إن دخل مباشرة وكان له مسجد واحد → يُفترض هذا المسجد. لا يفتح شاشة "سجّل حضور" بدون معرفة المسجد.
  3. **الطلاب والملاحظات وطلبات التصحيح:** نفس المنطق — كلها في سياق مسجد معيّن. عند تعدد المساجد: إما تبويبات/قائمة مساجد ثم محتوى حسب الاختيار، أو شاشة واحدة تطلب "اختر المسجد" أولاً.
  4. **اتساق مع حالة المسابقة:** في المسجد الذي **المسابقة فيه لم تبدأ بعد** لا نبرز "تسجيل الحضور" كإجراء رئيسي دون توضيح (انظر القسم 9 — اتساق المنطق). يمكن إظهار رسالة مثل "لا توجد مسابقة جارية في هذا المسجد — يمكنك تسجيل الحضور لاحقاً عند بدء المسابقة" أو إظهار تسجيل الحضور مع تنبيه أن الحضور سيُحسب عند بدء المسابقة، حسب قرار المنتج.
- **التبعيات التقنية:** جلب مساجد المشرف (من `mosque_members` حيث دور المستخدم مشرف أو مالك)؛ تخزين أو تمرير `mosqueId` الحالي في التنقل؛ شاشة اختيار المسجد عند الدخول إن كان عدد المساجد > 1.

---

## 7. تحديث البيانات عند العودة (صحة الحساب وغيرها)

### 7.1 المشكلة الموصوفة

- ولي الأمر يربط ابنه بمسجد من شاشة الحساب/إضافة ابن أو من بطاقة الابن، ويظهر له "احسنت ربطته". عند الرجوع إلى **صفحة البروفايل** يجد قسم **"صحة الحساب"** لا يزال يطلب "أن تربط ابنك بمسجد" — أي أن الحالة لم تتحدّث حتى يعمل reload للحساب أو يخرج ويدخل من جديد.

### 7.2 السبب الجذري (للتوثيق)

- قسم **صحة الحساب** (`_AccountHealthSection` في `ParentProfileScreen`) يقيّم الحالة مرة واحدة في **`initState`** عبر استدعاء `_evaluate()` الذي يجلب الأبناء وارتباطات المساجد ويبني قائمة `_items`. عند العودة من شاشة أخرى (مثلاً بطاقة الابن أو شاشة أبنائي) الشاشة قد تكون ما زالت في الذاكرة (مثلاً داخل `IndexedStack` في الصفحة الرئيسية لولي الأمر)، فلا يُستدعى `initState` مرة ثانية، ولا تُعاد `_evaluate()` — فتبقى البيانات القديمة.

### 7.3 المطلوب (ضمن الخطة)

- **عند العودة إلى شاشة البروفايل:** إعادة تقييم "صحة الحساب" (إعادة جلب الأبناء وارتباط المساجد وتحديث العرض) عندما تصبح الشاشة ظاهرة مرة أخرى، دون الاعتماد على `initState` فقط.
- **أماكن أخرى قد تعاني نفس المشكلة:** أي شاشة تعتمد على بيانات تُحمّل مرة واحدة عند الدخول ولا تُحدّث عند الرجوع (مثلاً قائمة الأبناء في البروفايل، أو أي عداد في الصفحة الرئيسية يعتمد على بيانات قديمة بعد ربط ابن أو إضافة مسجد). توحيد النمط: "عند ظهور الشاشة/التاب من جديد نحدّث البيانات اللازمة" حيث يلزم.

### 7.4 خيارات التنفيذ (للمرجع لاحقاً)

- استخدام **`RouteAware`** أو **`WidgetsBindingObserver`** لمعرفة متى عاد المستخدم للشاشة ثم استدعاء `_evaluate()` (أو ما يعادلها).
- أو: عند اختيار تاب "الملف الشخصي" في الـ `IndexedStack`، إطلاق حدث أو استدعاء يُحدّث صحة الحساب وقسم الأبناء.
- أو: رفع حالة "تم ربط ابن بمسجد" عبر BLoC/Provider بحيث البروفايل يشترك ويحدّث عند تغييرها (أثقل قليلاً لكن يوحّد مصدر الحقيقة).

---

## 8. مراجعة — ما قد لا يعمل بشكل صحيح أو يُغفل عنه

### 8.1 تحديث البيانات بعد التنقل

- **صحة الحساب في بروفايل ولي الأمر:** لا تتحدّث بعد ربط الابن بمسجد حتى إعادة تحميل (مذكور أعلاه).
- **أي شاشة تستخدم `FutureBuilder` أو تحميل مرة واحدة في `initState`** دون إعادة تحميل عند الرجوع قد تعطي انطباعاً أن "التطبيق لم يتحدّث". مراجعة: البروفايل، شاشة أبنائي، الصفحة الرئيسية (عدادات، حالة المسابقة)، وبعد أي إجراء يغيّر البيانات (ربط مسجد، إضافة ابن، طلب تصحيح) التأكد أن الشاشة التي سيعود إليها المستخدم تُحدّث عند الظهور.

### 8.2 فصل الأدوار والصلاحيات

- التأكد أن **المشرف** لا يصل لواجهات إدارة المسابقة أو الإعلانات أو إعدادات المسجد إن كانت مقتصرة على الإمام (من ناحية الروتر والواجهة).
- التأكد أن **الإمام** لا يُربَك بتسجيل الحضور كإجراء رئيسي؛ إخفاء أو تخفيفه كما في القسم 6.

### 8.3 تجربة ولي الأمر

- **الملاحظات vs الإعلانات:** عدم تكرار الإعلانات في شاشة "الملاحظات" بعد تطبيق التسمية الجديدة.
- **طلب التصحيح:** يظهر فقط عند وجود مسابقة جارية؛ قائمة المساجد في طلب التصحيح تعرض فقط المساجد التي فيها مسابقة جارية للابن المختار (حسب الخطة السابقة).
- **مواقيت الصلاة:** تم إصلاح التعليق عند انتظار الموقع (timeout + التحقق من تفعيل خدمة الموقع) في جلسة سابقة.

### 8.4 أماكن أخرى للمراجعة (اختياري)

- **ChildrenError** في الصفحة الرئيسية: التأكد أن الواجهة تعرض رسالة الخطأ وزر "إعادة المحاولة" ولا تترك شاشة فارغة.
- **عدادات غير المقروء** (ملاحظات، إعلانات): أن تُحدّث بعد العودة من شاشة الملاحظات/الإعلانات أو عند وصول بيانات جديدة (Real-time إن وُجد).
- **حذف المستخدم:** تم تنفيذ `delete_user_and_all_related` في migration منفصلة؛ التأكد أن واجهة حذف الحساب تستدعيها إن وُجدت.

---

## 9. اتساق المنطق في الواجهة (كل شيء منطقي)

### 9.1 المبدأ

- كل عنصر واجهة يظهر في **سياق منطقي**: لا نعرض إجراءاً أو محتوى يتعارض مع حالة البيانات أو دور المستخدم. مثال: **المشرف يفتح ويرى "سجّل الحضور" والمسابقة لسا ما بلشت** — هذا غير منطقي إن كان تسجيل الحضور يُقصد به "حضور ضمن المسابقة". الواجهة يجب أن تكون متسقة مع حالة المسابقة والسياق.

### 9.2 المشرف وتسجيل الحضور وحالة المسابقة

- **المشكلة:** لو المشرف يدخل ويشوف "تسجيل الحضور" بشكل بارز والمسابقة في هذا المسجد **لم تبدأ بعد**، يصير التباس: هل يسجّل حضور؟ وعلى أي أساس؟ الحضور يُحسب للمسابقة أم لا؟
- **القرار المستهدف (ضمن الخطة):**
  - **خيار أ:** إبراز "تسجيل الحضور" **فقط عندما تكون هناك مسابقة جارية** في المسجد المُختار. إن لم تكن هناك مسابقة جارية نعرض رسالة توجيهية: "لا توجد مسابقة جارية في [اسم المسجد] — سجّل الحضور عند بدء المسابقة" أو "المسابقة قادمة — تبدأ في [التاريخ]".
  - **خيار ب:** الإبقاء على إظهار "تسجيل الحضور" دائماً (لأن الحضور قد يُسجّل حتى خارج المسابقة لسجلات عامة)، لكن مع **نص واضح** حسب الحالة: "مسابقة جارية — الحضور يُحسب في المسابقة" أو "لا مسابقة جارية حاليًا — الحضور للتسجيل فقط" حتى لا يظن المشرف أن الحضور يُحسب في مسابقة لم تبدأ.
- **التوصية:** خيار أ أنسب لمنتج تركز فيه المسابقة على الحضور؛ خيار ب إن كان تسجيل الحضور مستقلًا عن المسابقة. في كل الأحوال **لا نترك المشرف أمام شاشة تسجيل حضور بدون توضيح حالة المسابقة** في هذا المسجد.

### 9.3 أماكن أخرى للاتساق

- **ولي الأمر — طلب التصحيح:** يظهر فقط عند مسابقة جارية (مذكور سابقاً). قائمة المساجد في طلب التصحيح تحتوي فقط مساجد فيها مسابقة جارية.
- **الإمام — إدارة المسابقة:** كل الإجراءات (إنشاء، تعديل، تأجيل، تفعيل، إيقاف، حذف) متاحة وواضحة؛ لا إجراء "مخفي" أو غير متوقع.
- **المشرف — مسجد مُختار:** لا إجراء يتعلق بمسجد دون أن يكون المسجد معروفًا (عند تعدد المساجد: اختيار المسجد أولاً ثم الإجراءات في سياقه).
- **عرض "المسابقة" في أي لوحة:** النص يعكس الحالة فعليًا (لا مسابقة / قادمة / جارية / منتهية) ولا يعرض أزرارًا لا تنطبق (مثلاً "طلب تصحيح" عند لا مسابقة أو مسابقة منتهية).

### 9.4 خطة التنفيذ (للتطوير لاحقاً)

| العنصر | الوصف |
|--------|--------|
| **حالة المسابقة في لوحة المشرف** | عند الدخول لمسجد معيّن (أو عند مسجد واحد افتراضي)، جلب حالة المسابقة لهذا المسجد؛ إظهار تسجيل الحضور بشكل بارز فقط إن كانت المسابقة جارية، وإلا رسالة توجيهية أو نص توضيحي (حسب خيار أ أو ب أعلاه). |
| **اختيار المسجد عند تعدد المساجد** | المشرف في أكثر من مسجد: إما قائمة/بطاقات مساجد ثم كل الإجراءات في سياق المسجد المختار، أو طلب "اختر المسجد" قبل تسجيل الحضور والطلاب والملاحظات. |
| **مراجعة نصوص الواجهة** | التأكد أن كل لافتة وزر ورسالة تتوافق مع حالة المسابقة ودور المستخدم — لا شيء "يوجع الراس" أو يبدو غير منطقي. |

---

## 4. خارطة تنفيذ مقترحة (مرتبطة بهذه الخطة)

| الأولوية | المهمة | الملاحظات |
|----------|--------|------------|
| 1 | تسمية "الرسائل" → "الملاحظات" وتوجيهها لـ `/parent/notes` | تغيير في HomeScreen + التأكد من العداد. |
| 2 | إظهار اسم المسجد في بانر المسابقة بالرئيسية (إن أمكن) | يحتاج تمرير اسم المسجد مع حالة المسابقة من _loadCompetitionStatus. |
| 3 | في ChildCardScreen: عرض حالة المسابقة **لكل مسجد** عند وجود مسجدين أو أكثر | جلب getCompetitionStatus لكل mosqueId وعرضه تحت اسم المسجد. |
| 4 | في RequestCorrectionScreen: تصفية المساجد لعرض التي فيها مسابقة جارية فقط | منع اختيار مسجد لا مسابقة جارية فيه. |
| 5 | **تحديث صحة الحساب عند العودة للبروفايل** | إعادة _evaluate() عند ظهور الشاشة/التاب (RouteAware أو عند اختيار تاب البروفايل). |
| 6 | **فصل الأدوار:** تخفيف تسجيل الحضور من لوحة الإمام؛ منع المشرف من إدارة المسابقة/الإعلانات/الإعدادات | مراجعة الروتر والواجهة حسب الدور. |
| 7 | **المشرف في أكثر من مسجد:** لوحة تعرض المساجد أو تطلب اختيار مسجد؛ كل إجراء (حضور، طلاب، ملاحظات) في سياق المسجد المختار | جلب مساجد المشرف؛ تخزين/تمرير mosqueId. |
| 8 | **اتساق المنطق:** المشرف لا يرى "سجّل الحضور" بارزًا والمسابقة لسا ما بلشت — إما إبراز التسجيل فقط عند مسابقة جارية أو نص توضيحي حسب الحالة | جلب حالة المسابقة للمسجد في لوحة المشرف؛ رسالة توجيهية أو شرط ظهور. |
| 9 | **تحكم الإمام الكامل بالمسابقة:** واجهة تعديل (الاسم، التواريخ/التأجيل)، حذف، تفعيل، إيقاف — كل الإجراءات متاحة وواضحة | مراجعة CompetitionRepository والـ API؛ إضافة update + delete إن لزم. |
| 10 | (اختياري) إثراء شاشة أبنائي بحالة مسابقة مختصرة لكل ابن | يعتمد على 3؛ يمكن لاحقاً. |
| 11 | (اختياري) مراجعة أماكن أخرى تحتاج تحديثاً عند الرجوع | FutureBuilder / initState فقط في البروفايل وأبنائي والرئيسية. |

---

## 5. ملخص سريع

- **ابن في مسجدين:** تجربة لكل ابن ووضوح لكل مسجد (ارتباط، مسابقة: لا/قادمة/جارية/منتهية). طلب التصحيح فقط عند مسابقة جارية، مع ربط واضح بالمسجد.
- **المشرف في أكثر من مسجد:** سياق مسجد واحد في كل مرة؛ اختيار المسجد ثم الإجراءات (حضور، طلاب، ملاحظات) في سياقه؛ لا خلط بين المساجد.
- **الملاحظات vs الإعلانات:** "الرسائل" تصبح "الملاحظات" وتفتح شاشة الملاحظات فقط؛ الإعلانات تبقى شاشة منفصلة دون تكرار.
- **المسابقة والإمام:** نفس الحالات (لا مسابقة، قادمة، جارية، منتهية) تحكم لوحة الإمام وواجهة ولي الأمر. **تحكم الإمام الكامل:** إنشاء، تعديل (الاسم، التأجيل عبر التواريخ)، تفعيل، إيقاف، **حذف** — كل شيء متاح وواضح في الواجهة.
- **اتساق المنطق:** المشرف لا يفتح ويرى "سجّل الحضور" والمسابقة لسا ما بلشت بدون توضيح — إما إبراز التسجيل فقط عند مسابقة جارية أو نص واضح حسب الحالة. كل إجراء وزر ولافتة تتوافق مع حالة المسابقة ودور المستخدم.
- **فصل الأدوار:** الإمام يتحكم بالمسابقة والمشرفين والإعلانات والإعدادات دون أن نربكه بتسجيل الحضور كأمر رئيسي. المشرف يركز على التسجيل والملاحظات دون إدارة المسابقة/الإعلانات. السوبر أدمن يتحكم بكل ما يناسبه.
- **تحديث البيانات عند العودة:** صحة الحساب في بروفايل ولي الأمر (وأي شاشة مشابهة) يجب أن تتحدّث عند الرجوع من ربط الابن بمسجد أو إضافة ابن، دون الحاجة لـ reload يدوي.
- **مراجعة:** التأكد من عرض الأخطاء (مثل ChildrenError)، وتحديث العدادات بعد الرجوع، وربط واجهة حذف الحساب بـ delete_user_and_all_related إن وُجدت.

تم إعداد هذه الخطة لاستخدامها كمرجع عند تنفيذ التعديلات في الكود والواجهات.
