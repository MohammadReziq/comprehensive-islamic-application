# خطة تحسينات ولي الأمر والابن — تفصيلية ومتكاملة

> **الهدف:** تجربة متماسكة لولي الأمر والابن، مع منطق المسابقة كمركز، وRealtime + Caching، وواجهات واضحة بدون تكرار.

---

## المرحلة 0: أساسيات منطق المسابقة (Competition Context)

### 0.1 حالة نظام مركزية للمسابقة

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | تعريف حالة واحدة للمسابقة تُقرأ مرة وتُستخدم في كل واجهات ولي الأمر والابن. |
| **القيم** | `no_competition` \| `upcoming` \| `running` \| `finished` |
| **المصدر** | جدول `competitions`: المسابقة النشطة للمسجد عبر `CompetitionRepository.getActive(mosqueId)` + التحقق من `CompetitionModel.isOngoing` |
| **الملفات** | إنشاء `lib/app/features/competitions/domain/competition_context.dart` (أو استخدام CompetitionBloc مع state جديد) |
| **الخطوات** | 1) إضافة enum أو sealed class `CompetitionStatus`. 2) خدمة أو BLoC يجلب المسابقة النشطة لمساجد ولي الأمر (من أبنائه) أو مسجد الابن. 3) تعرض الحالة في مكان مركزي (مثلاً عبر Provider أو BlocProvider في شجرة ولي الأمر/الابن). |

**ملاحظة:** ولي الأمر قد يكون له أبناء في مساجد مختلفة — نعتمد "مسابقة نشطة إن وُجدت في أي مسجد لأبنائه" أو "المسابقة النشطة لمسجد الابن الحالي" حسب تصميم المنتج.

---

### 0.2 إخفاء/تعطيل "طلب تصحيح" و"طلباتي" عند عدم وجود مسابقة

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | لا تظهر واجهات التصحيح إلا عندما توجد مسابقة نشطة (`running`). |
| **الملفات** | `home_screen.dart` (شبكة الإجراءات)، `app_router.dart` (اختياري: إعادة توجيه `/parent/corrections` إذا لا مسابقة). |
| **الخطوات** | 1) في Home ولي الأمر: قراءة حالة المسابقة (من CompetitionBloc أو من Repository مباشرة لمساجد أبنائه). 2) إن لم توجد مسابقة نشطة: إزالة زرّي "طلب تصحيح" و"طلباتي" من الشبكة، أو استبدالهما بعنصر واحد: "تصحيحات الحفظ" يفتح شاشة تعرض رسالة "لا توجد مسابقة حالياً — التصحيحات متاحة أثناء المسابقة فقط" مع أرشيف الطلبات السابقة (إن وُجد). 3) دمج "طلب تصحيح" و"طلباتي" في شاشة واحدة بتبويبين: "طلب جديد" و"طلباتي". |

**حالات التصحيح:**
- **لا مسابقة:** إظهار رسالة واضحة + أرشيف الطلبات (إن وُجد) بدون زر "طلب جديد".
- **مسابقة نشطة:** إظهار التبويبين كاملين.

---

### 0.3 شاشة "عن المسابقة الحالية"

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | شاشة صغيرة توضّح: هل توجد مسابقة الآن؟ المدة، آلية النقاط. |
| **الملفات** | إنشاء `parent/competition_info_screen.dart` و `child/competition_info_screen.dart` (أو شاشة مشتركة). |
| **الخطوات** | 1) جلب المسابقة النشطة لمسجد الابن/ولي الأمر. 2) عرض الاسم، `dateRangeAr`، وصف مختصر. 3) ربط الشاشة بزر "عن المسابقة" في الهيرو أو في القائمة. |

---

### 0.4 تفعيل/إخفاء عناصر الـ UI حسب حالة المسابقة

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | في Home ولي الأمر والابن: Banner أو Badge يوضح "المسابقة فعّالة حتى X" أو "لا توجد مسابقة حالياً". الشارتس تُعرض فقط أثناء المسابقة. |
| **الملفات** | `home_screen.dart`، شاشة الابن الرئيسية، شاشات التقارير/الشارتس. |
| **الخطوات** | 1) إضافة Banner أعلى المحتوى يعتمد على حالة المسابقة. 2) في شاشة التقارير/الشارتس: إن لم توجد مسابقة، عرض رسالة "الشارتات متاحة أثناء فترة المسابقة فقط" بدل رسم فارغ. |

---

## المرحلة 1: تجربة ولي الأمر (Dashboard + Inbox + Badges)

### 1.1 Dashboard واحد يدمج: المسابقة + الأبناء + الجديد

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | أعلى الشاشة الرئيسية لولي الأمر: 3 كروت (أو أقسام): حالة المسابقة، ملخص الأبناء، "جديد لم تقرأه". |
| **الملفات** | `home_screen.dart` — إعادة تنظيم الـ Hero أو القسم الأول. |
| **الخطوات** | 1) إضافة قسم "حالة المسابقة" (نص + لون حسب الحالة). 2) قسم "ملخص أبنائك" (عدد الأبناء، أفضل ابن هذا الأسبوع إن وُجد). 3) قسم "جديد": عدد الإعلانات + الملاحظات غير المقروءة مع زر "عرض الآن". |

---

### 1.2 Badge للأشياء غير المقروءة + شريط "لديك جديد"

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | شارة رقمية على أيقونة Inbox (إعلانات + ملاحظات). Banner أعلى الصفحة: "لديك X رسائل جديدة وY إعلاناً غير مقروء". |
| **المصادر** | `announcement_reads` (عدد الإعلانات غير المقروءة)، جدول `notes` (عدد الملاحظات حيث `is_read = false` لأبناء ولي الأمر). |
| **الملفات** | `home_screen.dart`، خدمة أو BLoC يجمع عدد غير المقروء (أو توسيع AnnouncementBloc + NotesBloc). |
| **الخطوات** | 1) في بداية تحميل Home: جلب عدد الإعلانات غير المقروءة (من خلال قائمة الإعلانات + readIds). 2) جلب عدد الملاحظات غير المقروءة (من NotesRepository أو استعلام مباشر). 3) عرض Badge على زر "الرسائل" أو على أيقونة Inbox في الشبكة. 4) إن كان المجموع > 0: عرض Banner مع النص وزر "استعراض الآن" يفتح Inbox الموحّد. |

---

### 1.3 Inbox موحّد (إعلانات + ملاحظات + تنبيهات حضور)

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | شاشة واحدة تجمع: الإعلانات، ملاحظات المشرف، و(اختياري) تنبيهات الحضور/الغياب. |
| **الملفات** | إنشاء `parent/presentation/screens/parent_inbox_screen.dart`، تعديل الروتر: مسار واحد مثل `/parent/inbox`. |
| **الخطوات** | 1) تبويبات أو فلاتر: "الكل"، "إعلانات"، "ملاحظات المشرف"، "تنبيهات الحضور". 2) "الكل": دمج الإعلانات والملاحظات في قائمة واحدة مرتبة بالتاريخ، مع تمييز النوع (أيقونة/لون). 3) كل عنصر: حالة مقروء/غير مقروء، ربط بابن (للملاحظات)، وقت. 4) الضغط يفتح Bottom Sheet أو صفحة تفاصيل ويستدعي markAsRead للملاحظة أو الإعلان. 5) في Home: استبدال زرّي "ملاحظات المشرف" و"الإعلانات" بزر واحد "الرسائل والإعلانات" يفتح Inbox الموحّد. |

---

### 1.4 Realtime لولي الأمر (بدون Push)

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | عند إضافة إعلان أو ملاحظة أو تسجيل حضور لأحد الأبناء، تتحدّث قوائم ولي الأمر فوراً. |
| **الملفات** | `RealtimeService` (إن وُجد)، `ParentAnnouncementsScreen`، `NotesInboxScreen` أو الـ Inbox الموحّد، BLoCات الإعلانات والملاحظات. |
| **الخطوات** | 1) الاشتراك في Realtime لجدول `announcements` (للمساجد المرتبطة بأبنائه). 2) الاشتراك في `notes` (لـ child_id ضمن أبنائه). 3) الاشتراك في `attendance` (لـ child_id ضمن أبنائه) إن أردت عرض "تنبيهات الحضور" في Inbox. 4) عند حدث INSERT/UPDATE: إعادة جلب القائمة أو تحديث الـ BLoC (إضافة العنصر الجديد أو تحديث الحالة) ثم إعادة حساب الـ Badge. |

---

### 1.5 تقارير ولي الأمر مرتبطة بالموسم + الشارتس الذكية

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | شاشة التقارير تعرض افتراضياً فترة المسابقة الحالية؛ الشارتس (fl_chart) تُعرض فقط أثناء المسابقة أو لفترة محددة. |
| **الملفات** | شاشة تقارير ولي الأمر (إن وُجدت)، أو إنشاء `parent/reports_screen.dart`. |
| **الخطوات** | 1) جلب المسابقة النشطة لمساجد الأبناء. 2) الفترة الافتراضية للرسم: من تاريخ بداية المسابقة إلى نهايتها (أو "آخر 7 أيام" إن لم توجد مسابقة). 3) خيارات فلترة: "فترة المسابقة"، "آخر 7 أيام"، "هذا الشهر"، "مسابقات سابقة". 4) رسم بياني أسبوعي/شهري لمقارنة المسجد vs البيت. |

---

### 1.6 تحسين تجربة "إضافة ابن وربطه بالمسجد"

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | بعد إنشاء حساب الابن، خطوة واضحة لربطه بمسجد (أو لاحقاً) مع رسالة نجاح وتحديث فوري للـ Realtime والـ Inbox. |
| **الملفات** | `add_child_screen.dart`، شاشة ربط بالمسجد (أو خطوة داخل نفس الشاشة). |
| **الخطوات** | 1) في نهاية إنشاء الابن: إما اختيار مسجد فوراً أو "سأربطه لاحقاً". 2) عند الربط: رسالة "تم ربط ابنك بالمسجد — ستصل إليه الإعلانات والتقارير". 3) بعد الربط: إطلاق تحميل بيانات الإعلانات/الملاحظات وربط Realtime للابن الجديد. |

---

### 1.7 إصلاح رقم الهاتف وتجربة البروفايل

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | ضمان حفظ `phone` في `users` وعرضه بشكل صحيح؛ تحسين واجهة الحقل (تنسيق، تحقق، رسالة خطأ). |
| **الملفات** | `auth_repository.dart` (updateUserProfile)، `profile_screen.dart`. |
| **الخطوات** | 1) التحقق من أن `updateUserProfile` يحدّث عمود `phone` ويدعم null/empty. 2) في البروفايل: تعبئة الحقل من `user.phone` وعدم مسحه بعد الحفظ. 3) إضافة validator لرقم الهاتف (الطول، الشكل الأساسي) ورسالة خطأ تحت الحقل. |

---

### 1.8 شاشة "صحة الحساب" (Account Health)

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | قسم في البروفايل يوضح: رقم الهاتف مضاف/غير مضاف، مسجد مرتبط/غير مرتبط، أبناء مضافون/لا. |
| **الملفات** | `profile_screen.dart` أو widget منفصل `account_health_section.dart`. |
| **الخطوات** | 1) قراءة user.phone، وجود أبناء، وجود مساجد (من خلال أبناءه). 2) عرض قائمة عناصر مع أيقونة ✔/✖ وزر "إكمال" يوجّه للشاشة المناسبة. |

---

## المرحلة 2: تجربة الابن

### 2.1 Home الابن مرتبطة بالمسابقة

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | أعلى صفحة الابن: حالة المسابقة (فعّالة / منتهية / غير موجودة) والهدف اليومي إن كانت فعّالة. |
| **الملفات** | شاشة الابن الرئيسية (ChildView أو ما يعادل Home للابن). |
| **الخطوات** | 1) جلب المسابقة النشطة لمسجد الابن. 2) عرض Banner: "المسابقة فعّالة حتى X" أو "لا توجد مسابقة حالياً — واصل الصلاة". 3) إن كانت المسابقة فعّالة: عرض الهدف اليومي (صلاة، حضور، نقاط). |

---

### 2.2 شارت للابن خلال المسابقة فقط

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | رسم بياني أسبوعي لحضور الابن خلال فترة المسابقة (مسجد vs بيت). خارج المسابقة: إخفاء أو رسالة توضيحية. |
| **الملفات** | شاشة نقاط/تقارير الابن. |
| **الخطوات** | 1) التحقق من وجود مسابقة نشطة. 2) إن وُجدت: رسم بيانات الحضور من بداية المسابقة إلى نهايتها. 3) إن لم توجد: إما إخفاء الشارت أو عرض "الشارتات متاحة أثناء المسابقة". |

---

### 2.3 Realtime للابن (حضور ونقاط)

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | عند تسجيل حضور الابن من المشرف/الإمام، تتحدّث شاشة الابن فوراً (نقاط، رسالة "تم تسجيل حضور صلاة X"). |
| **الملفات** | شاشة الابن، BLoC أو خدمة الحضور/النقاط. |
| **الخطوات** | 1) الاشتراك في Realtime لجدول `attendance` حيث `child_id = الابن الحالي`. 2) عند INSERT: تحديث النقاط أو عرض SnackBar/شارة "تم تسجيل حضور صلاة المغرب اليوم". |

---

### 2.4 Inbox صغير للابن

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | شاشة تعرض للابن الملاحظات المرتبطة به فقط (وإن أردت رسائل تشجيعية). |
| **الملفات** | إنشاء `child/notes_or_inbox_screen.dart`، إضافة مسار في الروتر. |
| **الخطوات** | 1) استعلام ملاحظات حيث child_id = الابن الحالي. 2) عرض قائمة مع markAsRead عند الفتح. 3) ربط Realtime لجدول notes للابن. |

---

### 2.5 Badge "مشارك في المسابقة" في قائمة أبناء ولي الأمر

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | في شاشة "أبنائي" لولي الأمر: لكل ابن شارة "مشارك في المسابقة الحالية" أو "لا توجد مسابقة حالياً" حسب مسجد الابن. |
| **الملفات** | `children_screen.dart` أو قائمة البطاقات في Home. |
| **الخطوات** | 1) لكل ابن: جلب مسجده ثم المسابقة النشطة لهذا المسجد. 2) عرض Badge صغير على بطاقة الابن. |

---

## المرحلة 3: Realtime + Caching

### 3.1 استراتيجية Caching مع Realtime

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | عند فتح شاشة مهمة: عرض آخر بيانات مخزّنة محلياً فوراً، ثم في الخلفية طلب من السيرفر + Realtime؛ عند أول تغيير نحدّث الواجهة ونلغي الاعتماد على الكاش القديم. |
| **الملفات** | طبقة تخزين محلي (مثلاً Hive أو SharedPreferences + JSON للقوائم البسيطة)، أو استخدام BLoC مع state أولي من cache. |
| **الخطوات** | 1) عند فتح Home/Inbox/التقارير: قراءة آخر snapshot من cache (إن وُجد) وعرضه فوراً. 2) تشغيل طلب شبكة + الاشتراك في Realtime. 3) عند وصول بيانات جديدة (من الطلب أو Realtime): تحديث الـ state وحفظ snapshot جديد في الـ cache. 4) عدم الاعتماد على الكاش كـ "مصدر الحقيقة" — Realtime والـ API هما المصدر. |

---

### 3.2 انقضاء الكاش وتجربة المستخدم

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | لا نعرض خيار "مسح الكاش" للمستخدم العادي. نستخدم timestamp للـ snapshot؛ إن مر وقت طويل بدون فتح التطبيق نعرض "جارٍ تحديث البيانات…" حتى ينتهي التحديث. |
| **الملفات** | نفس طبقة الـ cache، وواجهة الشاشات التي تعتمد على الـ cache. |
| **الخطوات** | 1) حفظ وقت آخر تحديث مع كل snapshot. 2) عند الفتح: إن كان العمر أكبر من حد (مثلاً 24 ساعة): اعتبار البيانات "قديمة" وعرض مؤشر تحديث حتى ننتهي من الطلب/Realtime. 3) عدم إظهار قائمة إعدادات "مسح الكاش" في الواجهة العادية. |

---

## المرحلة 4: تنظيم الكود والـ UX النهائي

### 4.1 تنظيم الكود (Parent / Child Experience)

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | فصل واضح لـ features ولي الأمر والابن مع مشاركة الخدمات المشتركة. |
| **الملفات** | هيكل مثل: `features/parent/`, `features/child/`, `features/competitions/`, `core/services/realtime_service.dart`, `core/cache/`. |
| **الخطوات** | 1) تجميع شاشات ولي الأمر تحت `parent/` (home, inbox, reports, children, corrections). 2) تجميع شاشات الابن تحت `child/` (home, points, inbox). 3) BLoCات واضحة للمسابقة، الحضور، الرسائل، التقارير. 4) Realtime وAuth وRepositories في core أو features مشتركة. |

---

### 4.2 إزالة التكرار في شبكة الإجراءات (Home ولي الأمر)

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | شبكة واحدة واضحة: أبنائي، إضافة ابن، تصحيحات الحفظ (تبويبان)، الرسائل والإعلانات، تقارير الصلاة، مسجدي/انضم لمسجد، بطاقات الأبناء. |
| **الخطوات** | 1) دمج "طلب تصحيح" و"طلباتي" في عنصر واحد "تصحيحات الحفظ" يفتح شاشة بتبويبين. 2) إخفاء "تصحيحات الحفظ" أو استبداله برسالة عندما لا توجد مسابقة. 3) دمج "ملاحظات المشرف" و"الإعلانات" في "الرسائل والإعلانات" يفتح Inbox الموحّد. 4) الإبقاء على 6–7 أزرار كحد أقصى. |

---

### 4.3 حالات فارغة ورسائل واضحة

| المهمة | التفاصيل |
|--------|----------|
| **الفكرة** | في كل مكان: لا مسجد، لا أبناء، لا إعلانات، لا مسابقة — رسالة مصمّمة + زر إجراء إن أمكن. |
| **الملفات** | جميع الشاشات المعنية (Inbox، التقارير، التصحيحات، شاشة الابن). |
| **الخطوات** | 1) قائمة بالحالات: "لا مسجد"، "لا أبناء"، "لا إعلانات"، "لا مسابقة"، "لا طلبات". 2) لكل حالة: نص + أيقونة + زر (مثلاً "انضم لمسجد"، "أضف ابناً"). |

---

## ملخص الترتيب المقترح للتنفيذ

| المرحلة | الأولوية | المهام الرئيسية |
|---------|----------|------------------|
| **0** | 1 | حالة المسابقة، إخفاء/إظهار التصحيحات والشارتس، Banner المسابقة |
| **1.1–1.4** | 2 | Dashboard ولي الأمر، Badge + Inbox موحّد، Realtime |
| **1.5–1.8** | 3 | تقارير ومسابقة، إضافة ابن، هاتف، صحة الحساب |
| **2** | 4 | Home الابن، شارت، Realtime، Inbox، Badge مشاركة مسابقة |
| **3** | 5 | Caching + Realtime، انقضاء الكاش |
| **4** | 6 | تنظيم الكود، إزالة التكرار، حالات فارغة |

---

## ملاحظات تقنية سريعة

- **المسابقة النشطة لولي الأمر:** استدعاء `CompetitionRepository.getActive(mosqueId)` لكل مسجد من مساجد أبنائه (من `ChildRepository.getChildMosqueIds` لكل ابن)، ثم أخذ أول مسابقة نشطة أو اعتماد مسجد "رئيسي" واحد.
- **عدد غير المقروء:** إعلانات: من `getForParent` + `getReadIds` ثم عدّ الفرق. ملاحظات: استعلام `notes` حيث `child_id IN (أبناء ولي الأمر)` و `is_read = false`.
- **Realtime:** التأكد من أن الجداول `announcements`, `notes`, `attendance` مضافة إلى `supabase_realtime` (التحقق من الـ migrations).

---

*آخر تحديث: الخطة تشمل كل ما نُوقش: المسابقة، ولي الأمر، الابن، Realtime، Caching، وواجهات موحّدة مع تجربة مستخدم واضحة.*
