# برومبت دراسة الجدوى واختبار الضغط — منصة قُرب (Qurb / صلاتي حياتي)

> **الهدف:** إنتاج تحليل استقصائي طويل (~2000+ سطر) يغطي المنطق، قاعدة البيانات، تجربة المستخدم، الثغرات، وبرج التحكم لمدير النظام. النبرة: مهنية، تحليلية، ونقدية بدون مجاملة.

---

## خلفية المشروع

- **اسم التطبيق:** قُرب (Qurb) — في الكود الحالي يُشار إليه أيضاً باسم "صلاتي حياتي".
- **الغرض:** منصة إسلامية لمحاسبة الصلاة وربط المجتمع بالمسجد (أولياء أمور، أبناء، أئمة، مشرفون).
- **التقنيات المعتمدة:** Flutter (تطبيق موبايل)، Supabase (قاعدة بيانات، مصادقة، Realtime، RLS).

---

## الميزات المطلوب تحليلها

### 1. نظام المسجدين (Primary / Secondary)

- الابن يمكن أن يكون مسجّلاً في **مسجد أساسي (Primary)** و**مسجد إضافي (Secondary)**.
- في قاعدة البيانات الحالية: جدول `mosque_children` يحتوي عمود `type` بقيم `primary` و `secondary`.
- المطلوب: تحليل كيف تتعامل الاستعلامات والتقارير والمسابقات مع الابن الذي له مسجدان — أي مسجد يُعتبر "الرئيسي" للترتيب؟ كيف تُحسب النقاط إن كانت المسابقة في مسجد واحد فقط؟

### 2. طلبات التصحيح (Correction Requests)

- إذا صلّى الابن في مسجد **غير المسجدين المسجّلين** (مسجد ثالث)، يمكن لولي الأمر تقديم **طلب تصحيح** لإثبات الحضور.
- الجدول الحالي: `correction_requests` (child_id, parent_id, mosque_id, prayer, prayer_date, status, note, reviewed_by).
- **من يراجع الطلب؟** إمام/مشرفو المسجد الذي وُجد فيه الحضور (`mosque_id` في الطلب) — وليس بالضرورة مسجد الابن الأساسي.
- المطلوب: تحليل دورة حياة الطلب من الإنشاء حتى القبول/الرفض، ومن يرى ماذا، وكيف يُمنع الإساءة (سبام، تزوير).

### 3. تسلسل الأدوار والقيود

| الدور | القيد في المنتج |
|-------|------------------|
| **إمام (Imam)** | مسؤول عن **مسجد واحد فقط** (مالك المسجد). |
| **مشرف (Supervisor / Moushrif)** | يمكنه إدارة **حد أقصى مسجدين**. |
| **ولي أمر (Parent)** | يراقب أبناءه فقط. |
| **مدير النظام (Super Admin)** | إدارة المنصة بالكامل. |

- في قاعدة البيانات الحالية **لا يوجد** قيد CHECK أو trigger يفرض "المشرف مسجدين كحد أقصى" — القيد منطق تطبيقي.
- المطلوب: تحليل ماذا يحدث إذا احتاج مسجد لثلاثة مشرفين؟ أو إذا أراد مشرف الانتقال من مسجد لآخر؟ وحالات الحافة (edge cases).

### 4. الواجهة المشروطة (Competition vs Normal)

- ميزات مثل **"طلب تصحيح"** و**"طلباتي"** وبعض لوحات المسابقة **يجب إخفاؤها** عندما لا توجد مسابقة نشطة، لتجنب ازدحام الواجهة واختلاط المنطق.
- المطلوب: تحليل الانتقال من "وضع عادي" إلى "وضع مسابقة" — كيف لا تكون التجربة مفاجئة؟ وما التوصيات لتنفيذ ذلك في Flutter (حالة من الـ API، إخفاء/إظهار بناءً عليها).

---

## ما يجب أن تغطيه الدراسة (بالتفصيل)

### القسم 1 — متاهة المنطق (الخلفية وقاعدة البيانات)

1. **قاعدة البيانات والمسجدين**
   - كيف تتعامل الاستعلامات مع ابن مرتبط بمسجدين؟ (أداء، فهارس، JOINات).
   - هل نحتاج فهارس إضافية أو views مادية لتحسين لوحات ولي الأمر والإمام؟
   - تحليل تأثير وجود `primary` و `secondary` على: الحضور، المسابقات، طلبات التصحيح.

2. **سير عمل طلب التصحيح (من البداية للنهاية)**
   - من يقدّم الطلب؟ (ولي الأمر فقط).
   - كيف يُختار المسجد في الطلب؟ (المسجد الذي صلّى فيه الابن — قد يكون ثالثاً).
   - من يتحقق من الطلب؟ (إمام/مشرفو **ذلك** المسجد).
   - كيف يُمنع السبام؟ (حدّ عدد طلبات معلقة لكل ابن/ولي؟ تأخير زمني؟).
   - ماذا يحدث عند القبول؟ (إنشاء سجل حضور؟ ربطه بمسابقة إن وُجدت؟).
   - تقديم **مخطط نصي** (flowchart) لدورة حياة الطلب.

3. **قيد "المشرف مسجدين كحد أقصى"**
   - أين يُطبَّق؟ (تطبيق فقط أم قاعدة بيانات؟).
   - ماذا لو احتاج مسجد لثلاثة مشرفين؟ (هل نرفع الحد؟ أم نقدّم "مشرف بديل"؟).
   - ماذا لو أراد مشرف ترك مسجد والانتقال لآخر؟ (تحرير العضوية، حدود الانتقال، سجلات التدقيق).
   - جدول يلخّص صلاحيات كل دور على الجداول المعنية (قراءة، إدراج، تحديث، حذف).

### القسم 2 — نقد تجربة المستخدم (حسب الدور)

#### تركيز خاص: تحسين تجربة ولي الأمر — منطق العرض و Real-time

- **مبدأ "البيانات تظهر بشكل منطقي":**
  - كل عنصر واجهة يظهر فقط عندما يكون له معنى في السياق الحالي. مثلاً: **طلب التصحيح** و**طلباتي** لا يظهران إلا أثناء **المسابقة النشطة**؛ خارج المسابقة إخفاؤهما أو استبدالهما برسالة واضحة ("التصحيحات متاحة أثناء المسابقة فقط") مع إمكانية عرض أرشيف الطلبات السابقة فقط للاطلاع.
  - الشارتات والتقارير المرتبطة بالمسابقة تُعرض فقط في فترة المسابقة؛ خارجها إما إخفاء أو رسالة توضيحية.
  - تصميم كل شاشة بحيث المستخدم لا يرى أزراراً أو مسارات "ميتة" (لا تفعل شيئاً مفيداً في اللحظة الحالية).

- **مبدأ "كل ما يتأثر فيه ولي الأمر أو الطالب يظهر عليهما فوراً (Real-time)":**
  - أي حدث يهم ولي الأمر (حضور ابن، قبول/رفض طلب تصحيح، ملاحظة من المشرف، إعلان من المسجد) يجب أن ينعكس على واجهته **مباشرة** دون حاجة لتحديث يدوي أو إعادة فتح الشاشة.
  - أي حدث يهم الطالب/الابن (تسجيل حضوره، نقاط، ملاحظة من المشرف) يجب أن يظهر في تطبيق الابن **فوراً**.
  - التوصية التقنية: استخدام **Supabase Realtime** على الجداول المعنية (`attendance`, `correction_requests`, `notes`, `announcements`) مع اشتراك حسب دور المستخدم (ولي أمر ← أبناؤه ومساجدهم؛ طالب ← سجله فقط)، وتحديث الـ state في التطبيق (مثلاً BLoC) عند كل حدث INSERT/UPDATE ثم إعادة بناء الواجهة.
  - تجنب الاعتماد على "اسحب للتحديث" كمصدر وحيد — يجب أن يكون التحديث المباشر هو الأساس، مع إمكانية السحب كتحسين إضافي.

1. **الابن**
   - كيف نجعل "التسجيل في مسجدين" واضحاً وغير مربك؟ (شاشة واحدة بتبويبين؟ قائمة مساجدي؟).
   - كيف يفرّق بين حضوره في المسجد الأساسي vs الإضافي في واجهته؟

2. **ولي الأمر**
   - كيف يرى الفرق بين صلاة "معتمدة" (في المسجد المسجّل) وصلاة "قيد المراجعة" (طلب تصحيح)؟
   - كيف نعرض له مصدر الحضور (مسجد أساسي / إضافي / تصحيح مقبول) في التقارير والشارتات؟

3. **الإمام والمشرف**
   - هما مستخدمان مشغولان. إذا أُعطيا "قائمة طلبات تصحيح" طويلة بدون تنظيم، سيكرهان التطبيق.
   - تحليل **إجهاد الإشعارات (Notification Fatigue)** واقتراح حلول: تجميع، أولوية، تفويض، أو تقليص الخطوات.

4. **الواجهة المشروطة (تصميم منطقي)**
   - تحليل الانتقال من "وضع عادي" إلى "وضع مسابقة": ما الذي يظهر/يختفي؟ هل نعتمد على تحميل حالة واحدة من API (مثلاً `CompetitionStatus`: no_competition | upcoming | running | finished) ثم إخفاء/إظهار عناصر الواجهة بناءً عليها؟
   - **قاعدة التصميم:** لا يظهر "طلب تصحيح" ولا "طلباتي" ولا لوحات ترتيب المسابقة إلا عندما تكون المسابقة في حالة `running` (أو حسب سياسة المنتج: أيضاً `upcoming` لتهيئة المستخدم). كل شيء يتأثر فيه ولي الأمر أو الطالب يجب أن يصل إليه **مباشرة (Real-time)** عند حدوث أي تغيير في الخلفية.
   - كيف نتجنب قفزات بصرية عند ظهور/اختفاء العناصر؟ (مثلاً تحري ناعم، أو رسالة انتقالية قصيرة).

### القسم 3 — نقد قاسٍ ونقاط فشل محتملة

1. **لماذا قد يفشل النظام في الشهر الأول؟**
   - أمثلة: تكاسل الإمام عن مراجعة الطلبات، تزوير GPS، تعارضات قاعدة بيانات (deadlocks)، استعلامات ثقيلة على جداول الحضور والتصحيحات.
   - لكل نقطة: احتمال الحدوث، التأثير، وتوصية تخفيف.

2. **ثغرات أمنية في نظام طلب التصحيح**
   - من يستطيع إنشاء طلب؟ هل يمكن إنشاء طلب لمسجد لا يظهر في واجهة ولي الأمر؟
   - هل RLS الحالية كافية لمنع وصول غير مصرح؟ تحليل سياسات `correction_requests` والجداول المرتبطة.
   - إساءة محتملة: ولي أمر يرسل طلبات وهمية لمسجد بعيد — من يتحقق وكيف؟

3. **أين المنطق "معقّد جداً" للمستخدم العادي؟**
   - تحديد الشاشات أو المسارات التي قد تُربك مستخدماً عادياً (مثلاً: اختيار مسجد للتصحيح، فهم "مسجد ثالث"، فهم من سيراجع).

### القسم 4 — برج تحكم مدير النظام (Super Admin)

1. **متطلبات لوحة مدير النظام**
   - إدارة المساجد (قائمة، اعتماد، رفض، تعطيل).
   - حل النزاعات بين أئمة وأولياء أمور (مثلاً خلاف على طلب تصحيح — هل نعرض سجل الطلبات والمراجعين؟).
   - مراقبة إساءة طلبات التصحيح: مؤشرات (عدد طلبات معلقة لكل مسجد، عدد الطلبات المرفوضة لكل ولي أمر، تكرار الطلبات لنفس اليوم/الصلاة).
   - جداول مقترحة للمراقبة وتقارير يجب أن يراها مدير النظام.

### القسم 5 — نقد فكرة "المسجد الثانوي"

- **هل المسجد الإضافي ضروري فعلاً أم مجرد تعقيد؟**
- مقارنة مع بدائل: مثلاً **Geofencing** — تسجيل الحضور تلقائياً عند دخول نطاق مسجد معروف دون حاجة لربط الابن بعدة مساجد.
- التوصية: الإبقاء على المسجدين كما هو، أو تبسيط (مسجد واحد + طلبات تصحيح للمساجد الأخرى فقط)، مع تبرير واضح.

---

## إضافات يفضّل أن تشملها الدراسة (لتتماشى مع التطبيق الحالي)

1. **التسمية والهوية**
   - توحيد الاسم: "قُرب" vs "صلاتي حياتي" في الواجهة والوثائق — وتأثير ذلك على العلامة التجارية والترجمة (i18n).

2. **نافذة الحضور (Attendance Window)**
   - جدول `mosques` يحتوي `attendance_window_minutes` (افتراضي 60). الإمام لا يُقيَّد به؛ المشرف يُقيَّد.
   - تحليل تأثير ذلك على سيناريوهات "تسجيل متأخر" و"طلب تصحيح" — متى نوجّه ولي الأمر لطلب التصحيح بدل السماح بتسجيل عادي؟

3. **المسابقات (Competitions)**
   - جدول `competitions` مرتبط بمسجد واحد؛ مسابقة نشطة واحدة فقط لكل مسجد (`is_active = true`).
   - عمود `attendance.competition_id` يربط الحضور بالمسابقة.
   - تحليل: كيف نعرض "حالة المسابقة" لولي أمر له أبناء في أكثر من مسجد؟ (لا مسابقة / قادمة / جارية / منتهية) — ومصدر الحقيقة (API) لاستخدامه في إخفاء/إظهار عناصر الواجهة.

4. **Realtime والإشعارات**
   - الجداول المشمولة في Realtime حالياً (مثلاً `attendance`, `notes`, `announcements`).
   - كيف نربط وصول طلب تصحيح جديد بإشعار للإمام/المشرف دون إرهاقهم؟ (تجميع يومي؟ إشعار فوري مع تجميع في الشاشة؟).

5. **التصحيح والمسجد الثالث**
   - في التطبيق الحالي: ولي الأمر يختار مسجداً من قائمة (مثلاً مساجد معتمدة) عند إنشاء طلب التصحيح. المسجد المختار = المسجد الذي صلّى فيه الابن.
   - تحليل: هل القائمة يجب أن تكون "كل المساجد المعتمدة" أم "مساجد لها علاقة بالابن" فقط؟ وما تأثير ذلك على من يراجع (إمام ذلك المسجد).

6. **مخرجات ملموسة مطلوبة في التحليل**
   - **جدول صلاحيات:** دور × جدول × (قراءة / إدراج / تحديث / حذف).
   - **مخطط نصي (flowchart)** لدورة حياة طلب التصحيح من إنشاء الطلب حتى تحديث الحضور.
   - **قائمة تحقق (checklist)** لاختبار السيناريوهات الحرجة: ابن بمسجدين، طلب تصحيح لمسجد ثالث، مشرف في مسجدين، انتقال مشرف، عدم وجود مسابقة.

7. **الطول والشكل**
   - الهدف: **2000+ سطر** من التحليل (بما في ذلك الجداول والمخططات النصية والاقتباسات من المخطط الحالي إن لزم).
   - تقسيم الرد إلى أقسام مرقّمة مع عناوين فرعية واضحة.
   - استخدام **جداول** لصلاحيات الأدوار وسير الطلبات والمقارنات.
   - استخدام **مخططات سير نصية** (ASCII أو وصف خطوة بخطوة) حيث يلزم.

---

## تعليمات نهائية للذكاء الاصطناعي

- لا تكن مختصراً. فكّر خطوة بخطوة.
- انقد بصراحة: حدد نقاط الفشل والثغرات والتعقيد الزائد.
- قدّم توصيات قابلة للتطبيق (تعديلات RLS، تغييرات واجهة، تحسين استعلامات، سياسة إشعارات).
- إذا كان اسم التطبيق في السؤال "Qurb" أو "قُرب"، اعتمد ذلك في التحليل مع الإشارة إلى أن الكود الحالي قد يستخدم "صلاتي حياتي" — واقترح توحيداً إن أمكن.
- يمكن الرجوع إلى هيكل الجداول الحالية (مثلاً من وصف الملفات: `mosque_children.type`, `correction_requests`, `competitions`, `attendance.competition_id`, `mosques.attendance_window_minutes`) لتعميق التحليل دون افتراضات خاطئة.

---

*استخدم هذا الملف كبرومبت كامل لنسخه إلى Claude (أو نموذج آخر) للحصول على دراسة جدوى واختبار ضغط طويلة ومنظمة.*
