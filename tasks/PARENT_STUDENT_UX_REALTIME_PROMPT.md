# برومبت: تحسين تجربة ولي الأمر والطالب — منطق العرض و Real-time

> **الهدف:** إنتاج توصيات وتصميم تفصيلي لتحسين تجربة ولي الأمر والطالب (الابن) في منصة قُرب/صلاتي حياتي، بحيث **البيانات تظهر بشكل منطقي** و**كل ما يتأثر فيه ولي الأمر أو الطالب يظهر عليهما مباشرة (Real-time)**.

---

## خلفية سريعة

- **التطبيق:** منصة إسلامية لمحاسبة الصلاة وربط المسجد بالأولياء والأبناء (Flutter + Supabase).
- **الأدوار المعنية بهذا البرومبت:** ولي الأمر (Parent)، الطالب/الابن (Child).
- **المصدر الوحيد للحقيقة:** قاعدة البيانات (Supabase) مع إمكانية Realtime على الجداول المعنية.

---

## المبادئ المطلوب تطبيقها

### 1. منطق العرض (Logical Visibility)

- **لا يظهر عنصر واجهة إلا عندما يكون له معنى في السياق الحالي.**
  - مثال: زر **"طلب تصحيح"** و**"طلباتي"** يظهران فقط أثناء **المسابقة النشطة** (Competition running). خارج المسابقة: إخفاؤهما من شبكة الإجراءات، أو استبدالهما بعنصر واحد يفتح شاشة توضح "التصحيحات متاحة أثناء المسابقة فقط" مع إمكانية عرض أرشيف الطلبات السابقة للاطلاع فقط.
  - الشارتات والتقارير المرتبطة بالمسابقة (ترتيب، نقاط المسابقة) تُعرض فقط في فترة المسابقة؛ خارجها إما إخفاء أو رسالة مثل "الشارتات متاحة أثناء المسابقة".
  - لا نعرض أزراراً أو مسارات "ميتة" لا تقدم فائدة في اللحظة الحالية.

- **مصدر حالة "هل هناك مسابقة؟":**
  - API (مثلاً استدعاء يجلب المسابقة النشطة لمسجد/مساجد الابن أو ولي الأمر).
  - حالة التطبيق (مثلاً `CompetitionStatus`: `no_competition` | `upcoming` | `running` | `finished`) تُحدَّث عند دخول الشاشة وعند الحاجة من الخلفية، وتُستخدم في إخفاء/إظهار العناصر.

- **توصيات تنفيذية لـ Flutter:**
  - أين نخزن `CompetitionStatus`؟ (مثلاً في BLoC أو Provider في شجرة ولي الأمر/الابن.)
  - كيف نحدّثها؟ (عند فتح Home، وعند عودة المستخدم من شاشة أخرى إن لزم.)
  - قائمة عناصر الواجهة التي تُخفى/تُظهر حسب الحالة مع جدول: العنصر | يظهر عندما | يختفي عندما.

### 2. Real-time لكل ما يهم ولي الأمر والطالب

- **كل حدث في الخلفية يهم ولي الأمر يجب أن ينعكس على واجهته فوراً، بدون تحديث يدوي.**
  - أمثلة: تسجيل حضور لأحد أبنائه، قبول أو رفض طلب تصحيح قدّمه، وصول ملاحظة من المشرف عن ابنه، إعلان جديد من مسجد أحد أبنائه.
  - التقنية: الاشتراك في Supabase Realtime على الجداول المناسبة مع فلترة حسب `child_id` (أبناء ولي الأمر) أو `mosque_id` (مساجد أبنائه)، وعند كل حدث INSERT/UPDATE إعادة جلب البيانات ذات الصلة أو تحديث الـ state (مثلاً في BLoC) ثم إعادة بناء الواجهة.

- **كل حدث يهم الطالب/الابن يجب أن يظهر في تطبيق الابن فوراً.**
  - أمثلة: تسجيل حضوره من المشرف، منح نقاط، وصول ملاحظة من المشرف.
  - التقنية: Realtime على `attendance` (حيث child_id = الابن الحالي)، و`notes` (حيث child_id = الابن الحالي)، وتحديث الشاشة مباشرة.

- **جداول مقترحة للـ Realtime حسب الدور:**

| الدور     | الجداول المقترحة للاشتراك        | الفلتر / النطاق                          |
|----------|-----------------------------------|------------------------------------------|
| ولي أمر  | attendance, correction_requests, notes, announcements | child_id IN (أبناؤه)، mosque_id IN (مساجد أبنائه) |
| طالب/ابن | attendance, notes                 | child_id = الابن الحالي                  |

- **سلوك الواجهة عند وصول حدث:**
  - تحديث القائمة/البطاقات دون إعادة تحميل كامل الصفحة.
  - إمكانية إظهار مؤشر خفيف (مثلاً "تم التحديث") أو تحديث Badge (عدد غير المقروء) دون إزعاج.
  - عدم الاعتماد على "اسحب للتحديث" كمصدر وحيد — Real-time هو الأساس.

### 3. وضوح مصدر البيانات لولي الأمر

- **كيف يفرّق ولي الأمر بين:**
  - صلاة **معتمدة** (سُجّلت من المسجد مباشرة — مسجد أساسي أو إضافي).
  - صلاة **قيد المراجعة** (طلب تصحيح معلق).
  - صلاة **ناتجة عن تصحيح مقبول** (بعد أن قبل الإمام/المشرف الطلب).
- **التوصية:** في قائمة الحضور أو التقارير عرض مصدر كل سجل (مثلاً أيقونة أو تسمية: "مسجد"، "طلب تصحيح مقبول"، "قيد المراجعة") حتى لا يلتبس الأمر.

### 4. انتقال سلس بين "وضع عادي" و"وضع مسابقة"

- عند بدء مسابقة: ظهور عناصر جديدة (طلب تصحيح، طلباتي، ترتيب، شارتات) دون أن يشعر المستخدم بأن الواجهة "قفزت".
- عند انتهاء المسابقة: إخفاء تلك العناصر أو استبدالها برسالة/أرشيف مع عدم ترك أزرار لا تعمل.
- اقتراح تحري ناعم (fade/slide) أو رسالة قصيرة ("المسابقة انتهت — يمكنك الاطلاع على النتائج السابقة") حيث يلزم.

---

## مخرجات مطلوبة من التحليل

1. **جدول عناصر الواجهة المشروطة**
   - اسم العنصر (مثلاً "طلب تصحيح"، "طلباتي"، "شارت المسابقة"، "ترتيب الأبناء").
   - في أي شاشة يظهر (Home ولي الأمر، شاشة الطالب، إلخ).
   - يظهر عندما (no_competition / upcoming / running / finished — أو تركيبة).
   - ماذا يعرض عندما لا يظهر (إخفاء كامل أم استبدال برسالة/أرشيف).

2. **مخطط تفصيلي لـ Realtime**
   - لكل دور (ولي أمر، طالب): الجداول المشترك فيها، نوع الحدث (INSERT/UPDATE)، وكيف يحدّث التطبيق الـ state (أي BLoC أو مكافئ، وأي شاشات تتأثر).

3. **توصيات تنفيذية لـ Flutter**
   - أين وكيف نخزن حالة المسابقة (CompetitionStatus) وكيف نقرأها في الشجرة.
   - كيف نربط Realtime بالـ BLoC (أو غيره) مع تجنب تكرار الاشتراكات وتسريب الذاكرة.

4. **قائمة تحقق UX**
   - سيناريوهات لاختبار يدوي: ولي أمر يفتح التطبيق بدون مسابقة، ثم تبدأ مسابقة — ماذا يرى؟ طالب سُجّل حضوره — متى يرى التحديث؟ ولي أمر قدّم طلب تصحيح وقُبل — متى يرى التحديث؟

---

## تعليمات للذكاء الاصطناعي

- ركّز على **تجربة ولي الأمر والطالب** فقط في هذا البرومبت؛ لا حاجة لتفصيل لوحة الإمام أو مدير النظام هنا.
- قدّم توصيات **قابلة للتطبيق في Flutter + Supabase** (أسماء جداول، نوع الاشتراك Realtime، وهيكل state مقترح).
- استخدم **جداول** و**قوائم مرقمة** لتوضيح العناصر المشروطة وسير التحديث المباشر.
- إذا لزم، أشر إلى ملفات التطبيق الحالي (مثلاً وجود `CompetitionStatus` أو `RealtimeService`) لاقتراح توسيعها دون إعادة اختراع العجلة.

---

*استخدم هذا البرومبت مع أو بعد برومبت "دراسة الجدوى واختبار الضغط" للحصول على توصيات مركزة على تحسين تجربة ولي الأمر والطالب ومنطق العرض والـ Real-time.*
