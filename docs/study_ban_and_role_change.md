# دراسة: فلسفة الحظر وتغيير الدور في النظام

## 1. الهدف من الوثيقة

توضيح **كيف يعمل الحظر وتغيير الدور حالياً**، وما **القيود والعلاقات** في قاعدة البيانات، وما **المخاطر** عند تغيير إمام → مشرف أو طفل → ولي أمر، واقتراح **فلسفة آمنة** وتوصيات تنفيذية.

---

## 2. الوضع الحالي في الكود وقاعدة البيانات

### 2.1 الحظر (Ban)

| الموقع | السلوك الفعلي |
|--------|----------------|
| **Admin UI** | زر "حظر" → تأكيد → استدعاء `BanUser(userId)` |
| **AdminBloc** | `_onBanUser` → `AdminRepository.banUser(userId)` |
| **AdminRepository.banUser** | **تحديث فقط:** `users.role = 'parent'` حيث `users.id = userId` |

**الخلاصة:** لا يوجد عمود `is_banned` ولا تعطيل لحساب Auth. "الحظر" يعني حرفياً: **تحويل دور المستخدم إلى ولي أمر (parent)**. المستخدم يبقى قادراً على تسجيل الدخول ويرى واجهة ولي الأمر.

### 2.2 تغيير الدور (Update Role)

| الموقع | السلوك الفعلي |
|--------|----------------|
| **Admin UI** | "تغيير الدور" → اختيار دور جديد (ولي أمر / إمام / مشرف / طفل) → `UpdateUserRole(userId, newRole)` |
| **AdminRepository.updateUserRole** | **تحديث فقط:** `users.role = newRole.value` حيث `users.id = userId` |

**الخلاصة:** لا يحدث أي شيء آخر: لا تحديث لـ `mosques.owner_id` ولا لـ `mosque_members` ولا لـ `children.login_user_id`. فقط عمود `users.role` يتغير.

### 2.3 العلاقات الأساسية في النظام

- **مسجد ↔ إمام (مالك):**
  - `mosques.owner_id` → `users.id` (NOT NULL)
  - `mosque_members(mosque_id, user_id, role)` حيث `role = 'owner'` للمالك
  - التطبيق يوجّه من له `users.role = imam` أو `supervisor` إلى `/mosque`؛ الصلاحيات الفعلية على الجداول تُحددها RLS بناءً على `owner_id` و`mosque_members` وليس على `users.role` وحده.

- **طفل ↔ ولي أمر:**
  - `children.parent_id` → `users.id` (NOT NULL، ولي الأمر الحقيقي)
  - `children.login_user_id` → `users.id` (nullable)، للحساب الذي يسجّل دخول الابن (دور `child`)

- **المستخدم:**
  - `users.role` من نوع `user_role`: `super_admin | imam | supervisor | parent | child`
  - جدول `users` فيه أيضاً `is_active` (افتراضي true) ولا يُستخدم حالياً في منطق الحظر.

---

## 3. فلسفة الحظر — المخاطر والثغرات

### 3.1 لو "حظرنا" إماماً (الوضع الحالي)

- **ما يحدث:** `users.role = 'parent'` فقط.
- **ما لا يحدث:**
  - `mosques.owner_id` يبقى يشير إلى نفس المستخدم.
  - `mosque_members` يبقى فيه نفس المستخدم كـ `owner` للمسجد.
  - لا تعطيل في Auth (المستخدم يستمر في تسجيل الدخول).

- **النتيجة:**
  - من ناحية **واجهة التطبيق**: المستخدم يُعامل كولي أمر ويُوجّه لواجهة ولي الأمر (لأن التوجيه يعتمد على `users.role`).
  - من ناحية **قاعدة البيانات**: المسجد ما زال "مالكه" هو نفس الشخص؛ أي منطق أو واجهة تعتمد على `owner_id` أو `mosque_members` ستراه مالكاً.
  - **المسجد يبقى بدون "إمام" من منظور الأدوار:** لا يوجد مستخدم آخر بصفة إمام لهذا المسجد، والمالك السابق لم يعد يحمل دور `imam` في النظام. أي قائمة أو تقرير يعتمد على "من هو الإمام" عبر `users.role = 'imam'` سيكون غير متسق مع واقع ملكية المسجد.

### 3.2 حظر ولي أمر أو مشرف أو طفل

- **ولي أمر:** تغيير دوره إلى parent لا يغيّر شيئاً فعلياً. لا توجد علاقة إضافية "مالك مسجد" مرتبطة به فقط.
- **مشرف:** نفس فكرة الإمام لكن أضعف: يبقى في `mosque_members` كـ supervisor وربما يبقى يمرّ من RLS لصلاحيات المشرف إن استُدعيت واجهاتها.
- **طفل:** تحويله إلى parent يعني أن `users.role = 'parent'` بينما قد يبقى نفس المستخدم مُشاراً إليه من `children.login_user_id`. يصبح لدينا مستخدم بدور "ولي أمر" وهو في الوقت نفسه حساب تسجيل دخول لطفل — تناقض في النموذج المنطقي (من هو ولي الأمر لهذا الطفل؟ من يسجّل دخولاً كابن؟).

---

## 4. فلسفة تغيير الدور — المخاطر

### 4.1 إمام → مشرف

- **الوضع الحالي:** فقط `users.role = 'supervisor'`.
- **المشكلة:**
  - المسجد يحتاج في النموذج الحالي إلى **مالك واحد** (`mosques.owner_id` NOT NULL).
  - إذا غيّرنا دور الإمام إلى مشرف دون نقل ملكية المسجد:
    - `mosques.owner_id` لا يزال يشير إليه → من ناحية البيانات هو ما زال "مالك المسجد".
    - لكن من ناحية الأدوار لا يوجد مستخدم بدور `imam` مرتبط بهذا المسجد (لو اعتمدنا على `users.role`).
  - النتيجة: **مسجد بدون إمام ظاهري (حسب الدور)** مع بقاء مالك في الجدول، وهذا يخالف قاعدة "لكل مسجد إمام واحد".

- **الخطر الإضافي:** لو غيّرنا لاحقاً منطق التطبيق ليعتمد على `users.role` لتحديد "من هو إمام المسجد"، قد نجد مساجد بدون إمام أو نعرض بيانات خاطئة.

### 4.2 إمام → ولي أمر (أو أي دور آخر غير مشرف)

- نفس مشكلة 4.1 مع تفاقم: المالك السابق يصبح "parent" في الواجهة لكن يبقى مالكاً في `mosques` و`mosque_members`. المسجد يبقى بدون إمام من منظور الأدوار.

### 4.3 طفل → ولي أمر

- **الوضع الحالي:** فقط `users.role = 'parent'`.
- **المشكلة:**
  - `children.login_user_id` يشير إلى هذا المستخدم (حساب تسجيل دخول الابن).
  - بعد التغيير: مستخدم بدور `parent` لكنه لا يظهر كـ `parent_id` لأي طفل (الـ `parent_id` هو ولي الأمر الحقيقي)، بينما هو ما زال "حساب الابن" لسجل في `children`.
  - النتيجة: **تناقض في النموذج:** نفس المستخدم يُفترض أن يكون "ولي أمر" و"حساب ابن" في آن واحد، مع احتمال أخطاء في واجهات الحضور والملاحظات والصلاحيات (مثلاً سياسات RLS التي تعتمد على `parent_id` أو `login_user_id`).

### 4.4 ولي أمر / مشرف → إمام

- تغيير الدور إلى إمام لا يجعله تلقائياً مالك أي مسجد. سيكون مستخدماً بدور إمام لكن بدون مسجد حتى ينشئ مسجداً أو يُعيَّن مالكاً عبر "تغيير إمام المسجد" (إن وُجدت في النظام).

### 4.5 ولي أمر / إمام / مشرف → طفل

- المستخدم يصبح `child` بينما قد يكون:
  - `mosques.owner_id` لمسجد (إمام سابق)، أو
  - موجوداً في `mosque_members`، أو
  - `children.parent_id` لطفل.
- كل ذلك يسبب تناقضات: "طفل" لا يمكن أن يكون مالك مسجد أو ولي أمر لطفل آخر في النموذج الحالي.

---

## 5. قيود قاعدة البيانات ذات الصلة

- **mosques.owner_id:** NOT NULL، مرجع إلى `users(id)`. لا يمكن ترك مسجد بدون مالك.
- **children.parent_id:** NOT NULL، مرجع إلى `users(id)`. كل طفل له ولي أمر واحد.
- **children.login_user_id:** NULL مسموح، مرجع إلى `users(id)`. عند الربط، يُفترض أن المستخدم المرتبط له دور `child`.
- **mosque_members:** يربط المستخدم بالمسجد ودوره فيه (owner / supervisor). لا يوجد تحقق من أن `users.role` مطابق لـ `mosque_members.role`.

---

## 6. التوصيات — فلسفة آمنة

### 6.1 الحظر

- **تعريف الحظر المقترح:** منع المستخدم من استخدام التطبيق (أو تقييد صلاحياته) وليس مجرد تغيير التسمية.
- **خياران:**
  1. **حظر "ناعم" (بدون تعطيل Auth):** إضافة عمود `users.is_banned` (أو `users.banned_at`). عند تسجيل الدخول، إذا كان المستخدم محظوراً يُرفض الدخول إلى التطبيق أو يُوجّه لصفحة "حسابك موقوف". لا نعتمد على تغيير الدور وحده.
  2. **حظر "قاسٍ":** تعطيل المستخدم في Supabase Auth (إن وُجدت واجهة لذلك) مع أو بدون `is_banned` في الجدول.
- **في كل الأحوال عند حظر إمام:**
  - يجب **أولاً** نقل ملكية المسجد إلى مستخدم آخر (إمام جديد) أو وضع سياسة واضحة للمساجد التي تُحظر حسابات أئمتها (مثلاً: تعليق المسجد حتى يُعيَّن إمام جديد). عدم فعل ذلك يترك المسجد في حالة غير متسقة (مالك محظور أو بدور parent).

### 6.2 تغيير الدور

- **مبدأ عام:** تغيير `users.role` يجب أن يكون متسقاً مع باقي الجداول؛ أي لا نغيّر الدور إلا بعد ضمان عدم ترك علاقات "معلقة" أو متناقضة.

- **إمام → أي دور آخر (مشرف / ولي أمر / …):**
  - **إما:** منع التغيير حتى يتم نقل ملكية المسجد (تغيير إمام المسجد) إلى مستخدم آخر.
  - **أو:** تنفيذ تغيير ملكية المسجد كجزء من نفس العملية (اختيار إمام جديد ثم تغيير دور القديم)، بحيث لا يبقى مسجد بدون إمام واضح ومتناسق مع `users.role`.

- **طفل → ولي أمر:**
  - **إما:** منع هذا التغيير من واجهة الأدمن (الأكثر أماناً) لأن تحويل "حساب ابن" إلى "ولي أمر" يتطلب قرارات عمل (هل يصبح ولي أمر لنفس الطفل؟ هل نربط أطفالاً آخرين؟).
  - **أو:** تنفيذ سيناريو واضح: فك ربط `children.login_user_id` لأي طفل مرتبط بهذا المستخدم (جعلها NULL)، ثم تغيير الدور إلى parent، مع وضوح أن هذا المستخدم سيصبح "ولي أمر" بدون أطفال مرتبطين حتى يربطهم لاحقاً.

- **أي دور → طفل:**
  - منع التحويل إذا كان المستخدم:
    - مالك مسجد (`mosques.owner_id`)، أو
    - موجوداً في `mosque_members`، أو
    - `parent_id` لأي طفل.
  - أو تنفيذ "تنظيف" هذه العلاقات أولاً (نقل ملكية، إزالة من أعضاء المسجد، إلخ) ثم السماح بتغيير الدور — وهذا معقد ويحتاج سيناريوهات واضحة.

- **ولي أمر → إمام / مشرف:** أقل خطورة من الناحية البيانات (لا يترك مسجد بدون مالك)، لكن يفضل أن يكون تعيين إمام لمسجد عبر "تغيير إمام المسجد" وليس مجرد تغيير دور عام.

### 6.3 واجهة الأدمن

- **الحظر:** عرض تحذير عند حظر إمام: "هذا المستخدم إمام مسجد. انقل ملكية المسجد أولاً أو سيصبح المسجد بدون إمام ظاهري."
- **تغيير الدور:**
  - عند اختيار "إمام → مشرف" أو "إمام → ولي أمر": إما منع الزر حتى يتم اختيار "إمام جديد" للمسجد، أو فتح تدفق "نقل ملكية المسجد" ثم تغيير الدور.
  - عند اختيار "طفل → ولي أمر": إما منع أو تحذير: "هذا الحساب مرتبط كحساب ابن. تغيير الدور سيفك الربط وسيصبح ولي أمر بدون أطفال حتى يربطهم."
  - منع أو تحذير صريح عند تحويل ولي أمر أو إمام أو مشرف إلى "طفل" دون إزالة علاقات المسجد والأطفال.

---

## 7. ملخص تنفيذي

| الموضوع | الوضع الحالي | الخطر | التوصية المختصرة |
|--------|--------------|-------|-------------------|
| **الحظر** | تغيير الدور إلى parent فقط؛ لا is_banned ولا تعطيل Auth | "حظر" إمام لا يزيل صلاحياته من قاعدة البيانات؛ المسجد يبقى بدون إمام من منظور الأدوار | إضافة حظر حقيقي (مثلاً is_banned)؛ عند حظر إمام إما نقل ملكية المسجد أولاً أو تعريف سياسة واضحة |
| **إمام → مشرف** | تغيير users.role فقط | مسجد بدون إمام (من حيث الدور)؛ ملكية المسجد ما زالت للمستخدم نفسه | منع التغيير حتى نقل ملكية المسجد، أو ربط التغيير بعملية "تغيير إمام المسجد" |
| **طفل → ولي أمر** | تغيير users.role فقط | تناقض: نفس المستخدم ولي أمر وحساب ابن؛ parent_id vs login_user_id | منع من الواجهة أو تنفيذ مع فك ربط login_user_id ورسالة واضحة |
| **أي دور → طفل** | مسموح من الواجهة | إمام/مشرف/ولي أمر يصبح "طفل" مع بقاء علاقات المسجد والأطفال | منع إذا كانت هناك علاقات (مالك مسجد، عضو مسجد، parent_id) أو تنفيذ "تنظيف" مع سيناريو واضح |

بهذا تكون فلسفة الحظر وتغيير الدور موثّقة، والمخاطر معرّفة، والتوصيات قابلة للاستخدام عند تطوير واجهة الأدمن أو إضافة قيود في قاعدة البيانات (triggers / checks) لاحقاً.

---

## 8. ملاحظات تنفيذية اختيارية (للمرحلة القادمة)

- **حظر حقيقي:** إضافة migration لعمود `users.is_banned BOOLEAN NOT NULL DEFAULT false`، وتعديل تسجيل الدخول (أو redirect بعد تحميل البروفايل) لرفض أو إعادة توجيه المستخدم المحظور. تحديث `AdminRepository.banUser` لتعيين `is_banned = true` بدلاً من (أو بالإضافة إلى) تغيير الدور حسب السياسة المختارة.
- **حظر إمام:** قبل تنفيذ الحظر، التحقق من وجود صفوف في `mosques` حيث `owner_id = userId`؛ إن وُجدت، إما منع الحظر أو فتح تدفق "تغيير إمام المسجد" ثم الحظر.
- **تغيير الدور إمام → غير إمام:** قبل التحديث، التحقق من `mosques.owner_id` و`mosque_members`؛ إن كان المستخدم مالك مسجد، إما منع التغيير أو استدعاء نفس منطق نقل الملكية (مثلاً استخدام أو توسيع `changeImam` في الـ repository).
- **تغيير الدور طفل → ولي أمر:** إما إخفاء أو تعطيل هذا الخيار في واجهة "تغيير الدور"، أو تنفيذ خطوة إضافية: تحديث `children SET login_user_id = NULL WHERE login_user_id = userId` (عبر خدمة أو RPC يسمح بها للأدمن) ثم تحديث `users.role`.
- **قيود في DB (اختياري):** يمكن لاحقاً إضافة CHECK أو trigger يمنع مثلاً أن يكون `users.role = 'child'` إذا كان المستخدم مذكوراً في `mosques.owner_id`، أو أن يكون `users.role = 'parent'` مع وجود `children.login_user_id = هذا المستخدم` دون سياسة واضحة.
