# خطة مفصّلة جداً لما هو قادم — صلاتي حياتي

هذه الوثيقة خطة **تنفيذية مفصّلة** لكل ما هو قادم (صغيراً وكبيراً)، مع ترتيب أولويات وخطوات واضحة.  
المرجع الاستراتيجي: `study_roles_integration.md`. التدفقات: `app_flows_simple.md`. الاختبار: `checklist_attendance_lifecycle.md`.

---

## 0. الحالة الحالية (ما تم إنجازه)

### الأدوار والمسارات
- [x] سوبر أدمن: طلبات المساجد → موافقة/رفض.
- [x] إمام: إنشاء مسجد → انتظار الموافقة → لوحة مدير المسجد (كود المسجد، كود الدعوة، طلبات الانضمام، المشرفون، التحضير، الطلاب، الإجراءات).
- [x] مشرف: تسجيل بدور "مشرف" → بوابة المسجد (انضم بكوْد فقط) → طلب انضمام بموافقة الإمام → لوحة المشرف (بدون إدارة مشرفين).
- [x] ولي أمر: الرئيسية، أطفالي، ربط بمسجد (كود المسجد)، حضور اليوم وتفاصيل الطفل.
- [x] طلبات انضمام المشرفين: كود الدعوة → طلب معلّق → الإمام يوافق/يرفض → أسماء المشرفين وطلبات الانضمام عبر RPC (بدون recursion على `users`).

### البنية التقنية
- [x] Migrations: 001–017 (مثلاً: مساجد، أعضاء، طلبات انضمام، RLS، دوال RPC للأسماء).
- [x] Realtime: migration 007 (نشر الجداول) — **لم يُربط بعد في كود Flutter**.

### إصلاح صلاحيات الحضور للمشرف (تم)
- **المشكلة:** المشرف لا يرى حضور الطلاب إذا سجّله الإمام؛ سياسة RLS على `attendance` كانت تسمح بالقراءة فقط لـ ولي الأمر أو لـ `recorded_by_id`.
- **الحل:** migration `018_attendance_mosque_members_read.sql`: إضافة سياسة تسمح لأعضاء المسجد (`mosque_members`) بقراءة كل حضور ذلك المسجد — فيرى المشرف والإمام كل السجلات.
- **بعد تطبيق الـ migration:** تشغيلها في Supabase (SQL Editor أو `supabase db push`) ثم إعادة اختبار دورة الحضور.

### دراور لكل دور (تم)
- **مشرف:** دراور من لوحة المشرف (لوحة المشرف، التحضير، الطلاب، طلبات التصحيح، الملاحظات، انضم لمسجد، تسجيل خروج).
- **إمام:** دراور من لوحة المدير (لوحة المدير، التحضير، الطلاب، طلبات التصحيح، الملاحظات، تسجيل خروج).
- **ولي أمر:** دراور من الرئيسية (الرئيسية، أطفالي، تسجيل خروج).
- **سوبر أدمن:** دراور من طلبات المساجد (طلبات المساجد، تسجيل خروج).
- ويدجت مشترك: `core/widgets/app_drawer.dart` (AppDrawer + AppDrawerItem).

### ما بقي ربطه أو تحسينه (ملخّص قبل التفصيل)
- التحديث المباشر (Realtime) في التطبيق.
- تحقق مواقيت الصلاة (من الأذان ولمدة ساعة).
- طلبات التصحيح والملاحظات (جداول جاهزة؛ واجهات وربط).
- طلب تسجيل صلاة من ولي الأمر.
- إشعارات FCM من الخادم عند الأحداث.
- مسجد أساسي + مساجد ثانوية (واجهة وحدّ).
- تحسينات واجهة (Skeleton، pull-to-refresh، رسائل خطأ).

---

## 1. المرحلة الأولى — الاستقرار والتحديث المباشر

### 1.1 التحقق من دورة الحضور (يدوي)
- [ ] تنفيذ **كل** خطوات `checklist_attendance_lifecycle.md` مرة واحدة على بيئة حقيقية (أو محاكي).
- [ ] التأكد: سوبر أدمن يوافق → إمام يرى لوحته → مشرف ينضم بكود الدعوة ويوافق الإمام → ولي أمر يربط طفل بكود المسجد → إمام/مشرف يسجّل حضور → ولي الأمر يرى "حضور اليوم".
- [ ] إن فشلت أي خطوة: توثيق رقم الخطوة والسلوك، ثم إصلاح الربط أو RLS قبل المتابعة.

### 1.2 Realtime — كود Flutter (أولوية عالية) — تم تنفيذ الجزء الأساسي
الـ migration (007) فعّلت النشر فقط؛ التطبيق لا يتحدّث تلقائياً بدون كود.

| المهمة | التفصيل | الحالة |
|--------|---------|--------|
| خدمة Realtime | إنشاء `RealtimeService` تشترك في `postgres_changes` لـ `attendance` و `mosques`. | تم: `lib/app/core/services/realtime_service.dart` |
| اشتراك الحضور | الشاشة الرئيسية لولي الأمر: اشتراك في `attendance` مرشّح بـ `child_id` لأطفال المستخدم؛ عند حدث → إعادة جلب "حضور اليوم". | تم: `HomeScreen` + إلغاء اشتراك في `dispose` |
| اشتراك موافقة المسجد | بوابة المسجد ولوحة الإمام: اشتراك في `mosques`؛ عند حدث → إعادة جلب المساجد (MosqueLoadMyMosques). | تم: `MosqueGateScreen`، `ImamDashboardScreen` + إلغاء في `dispose` |
| إلغاء الاشتراك | عند `dispose` إلغاء الاشتراك. | تم |
| سحب يدوي (بديل) | Pull-to-refresh في "حضور اليوم" وطلبات المساجد. | لاحقاً |
| correction_requests، notes | اشتراك لاحق عند تنفيذ شاشات التصحيح والملاحظات. | لاحقاً |

### 1.3 تحقق مواقيت الصلاة (أولوية عالية)
| المهمة | التفصيل |
|--------|----------|
| مصدر المواقيت | التأكد من استخدام مصدر مواقيت الصلاة الحالي (حزمة أو API) في المشروع؛ إن لم يكن موجوداً إضافته. |
| قبل الأذان | في واجهة التحضير (تسجيل الحضور): قبل حفظ الحضور التحقق من أن الوقت الحالي **ليس قبل** وقت أذان الصلاة المختارة. إن كان قبل الأذان → رفض مع رسالة واضحة ("لا يمكن تسجيل الحضور قبل وقت الأذان"). |
| نافذة الساعة | السماح بتسجيل الحضور **من وقت الأذان ولمدة ساعة** (قيمة قابلة للتعديل، مثلاً من إعدادات أو ثابت). بعد مرور الساعة → إما رفض أو اعتبار التسجيل "متأخر" حسب السياسة المختارة. |
| واجهة التحضير | عرض وقت الأذان الحالي (أو الصلاة الحالية) وربط منطق التحقق به. |

---

## 2. المرحلة الثانية — التصحيحات والملاحظات والإشعارات

### 2.1 طلبات التصحيح (Corrections)
- الجدول `correction_requests` والـ RLS موجودان (مرجع: الدراسة والـ migrations).
- [ ] **شاشة ولي الأمر:** من تفاصيل الطفل (أو من قائمة) إمكانية "طلب تصحيح" (وصف المشكلة، اختيار تاريخ/صلاة إن لزم). حفظ الطلب في `correction_requests`.
- [ ] **شاشة المشرف/الإمام:** قسم "طلبات التصحيح" يعرض الطلبات المعلقة للمسجد. إجراءات: عرض التفاصيل، تسجيل تصحيح (تعديل حضور أو إضافة)، أو رفض/إغلاق مع رسالة.
- [ ] (اختياري) Realtime على `correction_requests` لظهور طلبات جديدة فوراً للمشرف/الإمام.

### 2.2 الملاحظات (Notes)
- الجدول `notes` موجود.
- [ ] **شاشة المشرف/الإمام:** من تفاصيل طفل أو من قائمة الطلاب إمكانية "إرسال ملاحظة" لولي الأمر (نص قصير، ربما قوالب جاهزة مثل "تلاوته اليوم رائعة").
- [ ] **شاشة ولي الأمر:** قسم أو شاشة "ملاحظات المشرف" تعرض الملاحظات الواردة عن أطفاله (مرتبة حسب التاريخ).
- [ ] (اختياري) Realtime على `notes` لظهور الملاحظة فوراً عند ولي الأمر.

### 2.3 الإشعارات (FCM من الخادم)
- التوثيق في الدراسة (قسم 6 مكرر): متى نرسل ولمن.
- [ ] حفظ FCM token ومواضيع الاشتراك موجودان؛ المتبقي: **إرسال** الإشعار من الخادم (أو Supabase Edge Function) عند الأحداث.
- [ ] جدول تنفيذ مقترح:
  - حدث: تسجيل حضور طفل → إرسال FCM لولي الأمر (موضوع الطفل أو العائلة).
  - حدث: موافقة سوبر أدمن على مسجد → إرسال FCM للإمام.
  - حدث: طلب تصحيح جديد → إرسال FCM لمشرف/إمام المسجد.
  - حدث: ملاحظة من المشرف للطفل → إرسال FCM لولي الأمر.
- [ ] ربط Edge Function (أو Cron + دالة) بجدول `attendance` و`mosques` و`correction_requests` و`notes` (بعد INSERT/UPDATE) لاستدعاء FCM.

---

## 3. المرحلة الثالثة — طلب تسجيل صلاة من ولي الأمر ومسجد ثانوي

### 3.1 طلب تسجيل صلاة من ولي الأمر
- الحالة: ولي الأمر صلّى بالبيت أو المشرف نسي أو تأخر عن نافذة الساعة.
- [ ] **خيار التصميم:** استخدام جدول `correction_requests` بنوع "طلب إضافة حضور" أو إنشاء جدول `attendance_requests` لتمييز طلب "إضافة حضور" عن "تصحيح خطأ". (يُحدَّد عند التنفيذ.)
- [ ] **شاشة ولي الأمر:** من تفاصيل الطفل إمكانية "طلب تسجيل صلاة" (اختيار الصلاة، التاريخ، تعليق اختياري). حفظ الطلب.
- [ ] **شاشة المشرف/الإمام:** عرض طلبات "تسجيل صلاة" وقبول (تسجيل الحضور نيابةً) أو رفض.

### 3.2 مسجد أساسي + مساجد ثانوية
- الداتابيس: `mosque_children.type` (primary/secondary) جاهز.
- [ ] **قاعدة:** حدّ مسجد واحد أساسي + اثنان ثانويان (أو عدد يُحدَّد) لكل طفل.
- [ ] **واجهة ولي الأمر:** عند ربط الطفل بمسجد: اختيار "مسجد أساسي" أو "مسجد ثانوي" مع التحقق من الحدّ.
- [ ] **واجهة التحضير:** عند تسجيل الحضور التأكد من أن الطفل مرتبط بهذا المسجد (أساسي أو ثانوي) وربط الحضور بالمسجد الصحيح.
- [ ] **التقارير والنقاط:** توحيد منطق الحضور والنقاط سواء من المسجد الأساسي أو الثانوي (حسب المواصفات).

---

## 4. المرحلة الرابعة — تحسينات وتجربة مستخدم

### 4.1 تحسينات واجهة
- [ ] **Skeleton / تحميل أنيق:** عرض هيكل تحميل (Skeleton) بدل شاشة فارغة أو spinner فقط في الرئيسية و"حضور اليوم".
- [ ] **Pull-to-refresh:** في قوائم الحضور، طلبات المساجد، طلبات التصحيح، الملاحظات (كبديل أو مكمّل لـ Realtime).
- [ ] **رسائل خطأ واضحة:** عند فشل الربط (كود مسجد خاطئ، انقطاع شبكة، رفض طلب) عرض رسالة مفهومة للمستخدم.
- [ ] **توحيد العبارات:** استخدام "إمام (مدير المسجد)" و"كود المسجد" / "كود الدعوة" بشكل موحّد في كل الشاشات.

### 4.2 إدارة المشرفين (تفصيل)
- [ ] لوحة الإمام تحتوي بالفعل على قسم "المشرفون" مع إزالة مشرف.
- [ ] التأكد من تفريق واضح: المدير (owner) يرى إدارة المشرفين وكود الدعوة؛ المشرف (supervisor) لا يرى إدارة المشرفين.

### 4.3 النبض الفوري (Attendance Pulse)
- [ ] عند تسجيل حضور من المشرف: إشعار أو اهتزاز فوري لولي الأمر (عبر Realtime داخل التطبيق أو FCM).
- [ ] (اختياري) اهتزاز خفيف للمشرف عند نجاح التسجيل كتأكيد.

### 4.4 الهالة الديناميكية (Dynamic Spirit Aura)
- [ ] حساب "معدل إيماني" من الحضور/النقاط للطفل.
- [ ] تغيير لون/توهج الملف الشخصي للطفل (في واجهة ولي الأمر أو تفاصيل الطفل) حسب هذا المعدل.

### 4.5 رسائل تشجيع سريعة
- [ ] قوالب رسائل جاهزة من المشرف لولي الأمر (مثلاً "تلاوته اليوم رائعة")؛ يمكن ربطها بجدول `notes` أو نوع مخصّص.

---

## 5. المرحلة الخامسة — الوضع المحلي والمزامنة (Offline)

- [ ] تصميم تخزين محلي للحضور (عند انقطاع الإنترنت في المسجد).
- [ ] عند عودة الاتصال: مزامنة السجلات المحلية مع Supabase دون ضياع بيانات.
- [ ] سياسة حل التعارضات (مثلاً last-write-wins أو دمج حسب الطابع الزمني).

---

## 6. ترتيب تنفيذ مقترح (خلاصة)

| الترتيب | المحتوى |
|---------|---------|
| 1 | تنفيذ checklist دورة الحضور كاملاً وإصلاح أي ثغرة. |
| 2 | Realtime في Flutter (حضور اليوم، موافقة المسجد) + Pull-to-refresh كبديل. |
| 3 | تحقق مواقيت الصلاة (قبل الأذان، نافذة ساعة بعد الأذان). |
| 4 | طلبات التصحيح (شاشات + ربط) ثم الملاحظات (شاشات + ربط). |
| 5 | إرسال FCM من الخادم/Edge عند الأحداث (حضور، موافقة، تصحيح، ملاحظة). |
| 6 | طلب تسجيل صلاة من ولي الأمر. |
| 7 | مسجد أساسي + ثانويان (حدّ + واجهة). |
| 8 | Skeleton، رسائل خطأ، توحيد العبارات. |
| 9 | النبض الفوري والهالة الديناميكية ورسائل التشجيع. |
| 10 | الوضع المحلي والمزامنة (Offline). |

---

## 7. مراجع سريعة

- **الدراسة الشاملة:** `docs/study_roles_integration.md`
- **التدفقات:** `docs/app_flows_simple.md`
- **اختبار الحضور:** `docs/checklist_attendance_lifecycle.md`
- **الخطة المختصرة:** `docs/roadmap_next.md`
- **تحديث هذه الخطة:** عند إنجاز بند → نقله إلى "مكتمل" في القسم 0 أو في جدول المرحلة المعنية، مع تاريخ إن رُغب.

---

*آخر تحديث للخطة: بعد استقرار دور المشرف، طلبات الانضمام بموافقة الإمام، وعرض الأسماء عبر RPC.*
