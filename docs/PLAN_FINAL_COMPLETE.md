# الخطة النهائية المتكاملة — صلاتي حياتي

**وثيقة واحدة نهائية** تجمع الحالة الفعلية، ما سنفعله بالخطة القادمة (مرتباً)، ورؤية تسويقية وتجربة مستخدم، بمنظور سينيور ديفيلوبر وفنان بالتسيوق والـ UX.  
محدّثة بعد دمج: **موقع المسجد (الإمام)** و**عرض الابن للباركود / ربط جهاز الابن** ضمن الخطة الفعلية؛ **أقرب مسجد** مؤجّل لما بعد.

---

## 0. الرؤية والتسيوق وتجربة المستخدم (لماذا وكيف)

- **القيمة للمستخدم:** ولي الأمر يطمئن على حضور أبنائه في المسجد دون أن يكون هو من يسجّل؛ المسجد يملك أداة تحضير سريعة ودقيقة؛ الطفل يتحمّس للنقاط والسلاسل والمسابقات.
- **الرسالة:** "صلاتي حياتي" — ربط البيت بالمسجد عبر حضور الصلاة، بشفافية وبساطة.
- **مبدأ التصميم:** أقل احتكاك ممكن: المشرف يمسح أو يختار من قائمة؛ ولي الأمر يفتح التطبيق فيرى حضور اليوم فوراً؛ الطفل إن كان عنده جوال يرى باركوده من عنده دون استعارة تلفون الأب.
- **ما نؤجّله عمداً:** اعتراف المسجد المعقد، أقرب مسجد، إعلانات، مسجد أساسي/ثانوي (واجهة) — حتى نغلق الثغرات الأساسية ونجعل التجربة سلسة في المسار الرئيسي.

---

## 1. الخلاصة التنفيذية (صفحة واحدة)

| العنصر | الحالة |
|--------|--------|
| **الباكند** | Migrations 001–023 ✅ (جداول، RLS، triggers، مسابقات، RPCs) |
| **التصحيحات** | ريپو + بلوك + قائمة (مشرف/إمام) ✅ — **شاشة إنشاء طلب لولي الأمر** ❌ |
| **الملاحظات** | ريپو + بلوك + إرسال + صندوق ولي الأمر ✅ |
| **المسابقات** | ريپو + بلوك + إدارة (إمام/مشرف) ✅ — **شاشة المسابقة النشطة لولي الأمر** ❌ |
| **تحقق وقت الحضور** | AttendanceValidationService غير مبنٍ ❌ |
| **موقع المسجد** | الموديل يحمل lat/lng؛ **لا واجهة للإمام لتعيين الموقع** ❌ |
| **عرض الابن للباركود** | غير مبنٍ ❌ (الابن لا يملك طريقة لعرض باركوده من جواله) |
| **Realtime** | حضور، مساجد، mosque_children ✅ — تصحيحات وملاحظات ❌ |

**ما سنفعله بالخطة القادمة (بالترتيب):**

1. **حرج:** تحقق وقت الحضور (AttendanceValidationService) + شاشة طلب تصحيح لولي الأمر + إلغاء حضور خاطئ + فصل صلاحيات المسابقة (الإمام فقط).
2. **قريب (ضمن الخطة):** الإمام يحدد موقع المسجد (واجهة إعدادات/إنشاء مسجد + ربط PrayerTimes) + **عرض الابن للباركود / ربط جهاز الابن**.
3. **تالي:** شاشة المسابقة النشطة لولي الأمر، Realtime للتصحيحات والملاحظات، رسائل خطأ موحدة، pull-to-refresh، skeleton.
4. **مؤجّل:** أقرب مسجد لولي الأمر، اعتراف المسجد، إعلانات، مسجد أساسي/ثانوي (واجهة)، Offline، FCM من الخادم.

---

## 2. فهرس الأجزاء

1. **الحالة الفعلية (مختصر)** — ما لدينا اليوم من بنية وشاشات وثغرات.
2. **الخطة القادمة — مراحل مفصّلة** — حرج → قريب → تالي → تحسينات → مؤجّل.
3. **تفاصيل تنفيذية** — ملفات، migrations، تبعيات، نقاط UX لكل بند.
4. **رحلة المستخدم (لمسة UX)** — ولي أمر، إمام، مشرف، ابن.
5. **قرارات مصيرية ومخاطر** — مرجع سريع.
6. **المراجع** — وثائق مرتبطة.

---

# الجزء الأول: الحالة الفعلية (مختصر)

- **DB:** Migrations 001–023 (جداول، RLS، trigger نقاط/سلاسل 020، مسابقات 022، timezone في mosques، RPCs 023).
- **موديلات:** User, Child, Mosque (مع lat/lng), Attendance, CorrectionRequest, Note, Competition، إلخ ✅؛ Announcement/Reward/Badge غير مكتملة واجهة.
- **ريپوهات:** Auth, Mosque, Child, Supervisor, Correction, Notes, Competition ✅؛ طلب تصحيح من ولي الأمر (createRequest, getMyRequests) جاهز في الريپو والبلوك لكن **لا شاشة ولا زر**.
- **خدمات:** PointsService, PrayerTimesService (مكة ثابتة), RealtimeService (attendance, mosques, mosque_children) ✅؛ **AttendanceValidationService غير مبنٍ**؛ أوقات الصلاة لا تستخدم موقع المسجد.
- **الشاشات:** سوبر أدمن (طلبات مساجد)، إمام/مشرف (تحضير، طلاب، تصحيحات، ملاحظات، مسابقات)، ولي أمر (أطفالي، بطاقة الطفل، ملاحظات)؛ **ناقص:** شاشة إنشاء طلب تصحيح، شاشة المسابقة النشطة لولي الأمر، **واجهة موقع المسجد للإمام**، **أي تدفق لعرض الابن للباركود**.

الثغرات الحرجة مجمعة في القسم التالي ضمن "المرحلة الحرجة".

---

# الجزء الثاني: الخطة القادمة — مراحل مفصّلة

## المرحلة 1 — حرج (يجب إنجازها أولاً)

| # | البند | الوصف المختصر |
|---|------|----------------|
| 1.1 | **AttendanceValidationService** | خدمة `canRecordNow(prayer, date, mosqueId)`؛ لا قبل الأذان، نافذة ساعة بعد الأذان؛ ربطها في `SupervisorRepository.recordAttendance` قبل INSERT. |
| 1.2 | **شاشة إنشاء طلب تصحيح لولي الأمر** | زر من بطاقة الطفل (أو قائمة أطفالي) → شاشة: اختيار صلاة، تاريخ، ملاحظة، مسجد إن تعدد → استدعاء CorrectionBloc CreateCorrectionRequest. التحقق من ربط الطفل بمسجد. |
| 1.3 | **إلغاء حضور خاطئ** | RPC `cancel_attendance` (صلاحيات: recorded_by أو owner المسجد، نافذة 24 ساعة)؛ دالة في SupervisorRepository؛ حدث في ScannerBloc. Trigger 020 يعيد الحساب عند DELETE. |
| 1.4 | **فصل صلاحيات المسابقة** | create/activate/deactivate للإمام فقط؛ المشرف قراءة (getActive, getLeaderboard). تحقق من الدور في CompetitionRepository و/أو RLS. |

## المرحلة 2 — قريب (ضمن الخطة الحالية)

| # | البند | الوصف المختصر |
|---|------|----------------|
| 2.1 | **الإمام يحدد موقع المسجد** | واجهة للإمام: إعدادات المسجد (أو عند إنشاء المسجد) تحتوي حقول **الموقع (lat/lng)** — إما خريطة صغيرة أو إدخال خط عرض/طول أو "استخدام موقعي الحالي". حفظ في mosques؛ MosqueModel يعرض الحقول (موجودة). ربط PrayerTimesService: عند فتح التحضير استخدام `getTimesForMosque(mosqueId)` من إحداثيات المسجد؛ fallback مكة أو موقع الجهاز. |
| 2.2 | **عرض الابن للباركود / ربط جهاز الابن** | الهدف: أن يفتح الابن التطبيق من جواله ويرى **شخصيته والباركود فقط** (ليسهل على المشرف المسح دون استعارة تلفون الأب). الخيار الموصى به: ولي الأمر من بطاقة الطفل يفعّل "ربط جهاز الابن" → يظهر **كود ربط** (مثلاً 6 أحرف/أرقام) أو رابط. الابن يفتح التطبيق → يختار "لدي كود ربط" ويدخل الكود → التطبيق يربط هذا الجهاز بهذا الطفل (تخزين محلي أو جدول child_linked_devices). عند فتح التطبيق من الجهاز المربوط: عرض شاشة واحدة "عرض الابن": الاسم، الباركود، (اختياري) حضور اليوم ونقاطي. لا حساب منفصل للابن — الربط مرتبط بحساب ولي الأمر. تفاصيل تنفيذية في القسم 3. |

## المرحلة 3 — تالي (بعد إغلاق الحرجة والقريبة)

| # | البند | الوصف المختصر |
|---|------|----------------|
| 3.1 | **شاشة المسابقة النشطة لولي الأمر** | مسار مثل `/parent/competition` أو من الرئيسية: عرض المسابقة الحالية لمسجد أحد أطفاله + ترتيب أطفاله. |
| 3.2 | **Realtime للتصحيحات والملاحظات** | اشتراك correction_requests و notes في RealtimeService؛ تحديث القوائم فوراً دون سحب. |
| 3.3 | **عرض طلبات التصحيح التي أرسلها ولي الأمر** | شاشة أو تبويب "طلباتي" يعرض getMyRequests مع الحالة (قيد المراجعة، موافق، مرفوض). |
| 3.4 | **رسائل خطأ واضحة** | توحيد AppFailure وعرضها في الواجهة (كود مسجد خاطئ، خارج نافذة الحضور، طلب مرفوض، إلخ). |
| 3.5 | **Pull-to-refresh و Skeleton** | في قوائم الحضور، التصحيحات، الملاحظات، المسابقات؛ تحميل أنيق بدل spinner فقط. |

## المرحلة 4 — تحسينات (قبل/بعد الرفع حسب الوقت)

- Pagination في القوائم الكبيرة.
- Caching بسيط (قائمة الطلاب، إعدادات المسجد).
- تحقق الأدوار في الكود (Defense in Depth) بجانب RLS.
- FCM من الخادم (حضور، موافقة مسجد، طلب تصحيح، ملاحظة).

## مؤجّل (لاحقاً — لا ضمن الخطة الحالية)

- **أقرب مسجد لولي الأمر:** عند ربط الطفل بمسجد، اقتراح أقرب مساجد حسب موقع ولي الأمر (يحتاج مساجد ذات إحداثيات أولاً).
- **اعتراف/تحقق المسجد:** سير تحقق (تواصل، مراجعة سوبر أدمن) — يضيف تعقيداً؛ نؤجله حتى نستقر الأساس.
- **الإعلانات:** موديل + ريپو + شاشات (v2).
- **مسجد أساسي + ثانوي (واجهة):** الحقل موجود في DB؛ واجهة ربط الطفل لاحقاً.
- **Offline للمسجد:** تخزين حضور محلي ومزامنة.
- **الجوائز والشارات (واجهة):** عرض rewards و badges للطفل.

---

# الجزء الثالث: تفاصيل تنفيذية (ملفات، تبعيات، UX)

## 1.1 AttendanceValidationService

- **ملف جديد:** `lib/app/core/services/attendance_validation_service.dart`
- **الدالة:** `({required Prayer prayer, required DateTime date, String? mosqueId}) → (bool allowed, String? reason)`
- **القواعد:** الآن ≥ وقت أذان الصلاة؛ الآن ≤ أذان + نافذة (من mosques.attendance_window_minutes أو افتراضي 60).
- **المصدر:** أوقات الصلاة من PrayerTimesService بإحداثيات المسجد (بعد 2.1) أو fallback مكة.
- **الربط:** استدعاء من `SupervisorRepository.recordAttendance` قبل INSERT؛ إن غير مسموح → return Left(AttendanceWindowClosedFailure()) أو ما شابه مع رسالة واضحة.
- **التسجيل:** في injection_container.
- **UX:** رسالة للمشرف مثل "لا يمكن تسجيل الظهر الآن — وقت التسجيل من أذان الظهر حتى ساعة بعد الأذان".

## 1.2 شاشة إنشاء طلب تصحيح لولي الأمر

- **المسار المقترح:** `/parent/children/:id/request-correction` أو ديالوغ من بطاقة الطفل.
- **العناصر:** اختيار الصلاة، التاريخ (date picker)، ملاحظة اختيارية، مسجد (إن كان الطفل في أكثر من مسجد).
- **التحقق:** الطفل مرتبط بمسجد (mosque_children)； إن لم يكن → "اربط ابنك بمسجد أولاً".
- **الاستدعاء:** CorrectionBloc.add(CreateCorrectionRequest(...)); الريپو createRequest موجود.
- **UX:** تأكيد بعد الإرسال "تم إرسال الطلب؛ الإمام/المشرف سيراجعه".

## 1.3 إلغاء حضور خاطئ

- **DB:** RPC `cancel_attendance(p_attendance_id UUID)` — تحقق أن المستدعي recorded_by أو owner المسجد؛ نافذة 24 ساعة (قابلة للإعداد لاحقاً)； DELETE من attendance (trigger 020 يعيد الحساب).
- **ريپو:** SupervisorRepository.cancelAttendance(String attendanceId).
- **Bloc:** ScannerBloc event CancelAttendance؛ في واجهة التحضير أو قائمة حضور اليوم زر "إلغاء" بجانب السجل إن كان مسجّله المشرف الحالي.
- **UX:** "تم إلغاء التسجيل؛ تم تحديث نقاط الطفل".

## 1.4 فصل صلاحيات المسابقة

- **CompetitionRepository:** قبل create/activate/deactivate التحقق من أن المستخدم owner المسجد (أو role imam). أو استدعاء RPC يتحقق في DB.
- **RLS:** إن لزم، تحديث سياسات INSERT/UPDATE على competitions بحيث فقط owner المسجد يقدر.
- **واجهة:** إخفاء أزرار "إنشاء مسابقة" و"تفعيل/إيقاف" عن المشرف؛ عرض الترتيب والمسابقة النشطة فقط.

## 2.1 الإمام يحدد موقع المسجد

- **واجهة:** شاشة إعدادات المسجد (للإمام) أو خطوة في إنشاء المسجد: حقل عنوان + **موقع**. الخيارات: (أ) زر "استخدام موقعي الحالي" (Geolocator)؛ (ب) خريطة صغيرة (اختياري)؛ (ج) إدخال lat/lng يدوياً. حفظ في mosques (lat, lng؛ timezone يمكن استنتاجها من الموقع أو اختيار يدوي).
- **Backend:** جدول mosques يحمل lat, lng, timezone (من 022). إن لم تكن الأعمدة موجودة، migration بسيط.
- **MosqueModel:** قراءة lat, lng, timezone من JSON (موجود جزئياً).
- **PrayerTimesService:** دالة `getTimesForMosque(String mosqueId)` — تجلب المسجد، تستخدم lat/lng، وتعيد أوقات الصلاة. عند فتح شاشة التحضير استدعاء getTimesForMosque(mosqueId) وتحديث العرض والتحقق (AttendanceValidationService يستخدمها أيضاً).
- **UX:** "موقع المسجد يُستخدم لحساب أوقات الصلاة بدقة في التحضير".

## 2.2 عرض الابن للباركود / ربط جهاز الابن

- **الهدف:** الابن يفتح التطبيق ويرى اسمه + الباركود (وربما حضور اليوم ونقاطه) دون حساب ولي أمر كامل.
- **التدفق الموصى به:**
  1. ولي الأمر من بطاقة الطفل → "ربط جهاز الابن" → يولد **كود ربط** (مثلاً 6 أحرف عشوائية) صالح لمدة 24–72 ساعة، ويُخزّن في جدول (مثلاً `child_link_codes`: child_id, code, expires_at) أو في Supabase مع RLS مناسب.
  2. الابن يفتح التطبيق → شاشة دخول: خيار "لدي كود ربط" → إدخال الكود → التحقق من الكود واسترجاع child_id → تخزين محلي (secure storage) أن هذا الجهاز "مربوط" بهذا الطفل.
  3. عند فتح التطبيق لاحقاً: إن وُجد ربط محلي، توجيه مباشر إلى **شاشة عرض الابن** (بدون تسجيل دخول ولي أمر): الاسم، الباركود الكامل (للمسح)، واختياري حضور اليوم ونقاطي.
  4. خيار "فسخ الربط" من نفس الشاشة (يحذف الربط المحلي فقط؛ ولي الأمر يمكنه إبطال الكود من جهته لاحقاً إن أردنا).
- **البيانات:** عرض الباركود يحتاج قراءة child (id, name, qr_code أو ما يحدد الباركود). يمكن endpoint بسيط: `getChildForDisplay(String linkCode)` يرجع بيانات العرض فقط بعد التحقق من الكود.
- **الأمان:** الكود لمرة استخدام أو محدود المدة؛ لا نعرّض بيانات حساسة (مثل ربط مسجد أو تعديل بيانات).
- **ملفات مقترحة:** ChildRepository أو خدمة جديدة: generateLinkCode(childId), validateLinkCode(code); شاشة Parent: عرض الكود؛ شاشة ChildView (عرض الابن فقط)； مسار مثل /child-view أو فحص عند بدء التطبيق.
- **UX:** "ابنك يقدر يفتح التطبيق ويدخل الكود فيشوف باركوده من عنده — بدون استعارة تلفونك".

---

# الجزء الرابع: رحلة المستخدم (لمسة UX)

- **ولي الأمر:** يسجّل، يضيف أطفاله، يربطهم بمسجد (كود). يفتح التطبيق فيرى حضور اليوم فوراً؛ يضغط على الطفل فيرى البطاقة وزر "طلب تصحيح" وزر "ربط جهاز الابن". إن ربط جهاز الابن، الابن يفتح من جواله ويدخل الكود ويشوف باركوده.
- **الإمام:** ينشئ مسجداً ويحدد **الموقع** (لأوقات الصلاة)، يدير المشرفين والطلاب والمسابقات (وحده من يفعّل المسابقات)، يراجع طلبات التصحيح. التحضير يستخدم أوقات الصلاة حسب موقع المسجد.
- **المشرف:** ينضم بدعوة، يفتح التحضير؛ لا يقدر يسجّل صلاة قبل أذانها أو بعد نافذة الساعة — يظهر له رسالة واضحة. يرى المسابقة والترتيب فقط (لا إنشاء ولا تفعيل).
- **الابن (بعد الربط):** يفتح التطبيق → إن كان الجهاز مربوطاً يرى فوراً "عرض الابن": اسمي، باركودي، حضور اليوم؛ يعرض الباركود للمشرف للمسح.

---

# الجزء الخامس: قرارات مصيرية ومخاطر

- **توقيت prayer_date و"اليوم":** توقيت المسجد (mosques.timezone أو من lat/lng).
- **أوقات الصلاة:** إحداثيات المسجد (lat/lng) عند التحضير؛ الإمام يحدد الموقع.
- **تسجيل الحضور:** لا قبل الأذان؛ من الأذان حتى نهاية النافذة (ساعة افتراضياً). الاستثناء الوحيد لتسجيل متأخر: طلب تصحيح من ولي الأمر.
- **المسابقة:** الإمام وحده ينشئ ويفعّل ويوقف؛ المشرف قراءة فقط.
- **ربط جهاز الابن:** لا حساب منفصل؛ كود ربط مؤقت وربط محلي بالجهاز؛ عرض قراءة فقط (باركود، حضور، نقاط).

المخاطر التفصيلية في **foundation_first_plan.md** و **MASTER_PLAN_CRITICAL_REVIEW.txt**.

---

# الجزء السادس: المراجع

| الوثيقة | الاستخدام |
|---------|-----------|
| **STUDY_COMPLETE_WHAT_WE_HAVE_AND_WHAT_NEXT.md** | الحالة الفعلية المفصّلة، جداول الموديلات والريپوهات والمسارات. |
| **foundation_first_plan.md** | قرارات بنية تحتية، نقد، تفصيل تحقق الحضور. |
| **MASTER_PLAN_CRITICAL_REVIEW.txt** | نقد الأدوار، موجات تنفيذ، migrations وملفات. |
| **product_ux_notes.md** | ربط جهاز الابن، من لا يسجّل، أدوار. |
| **HOW_TO_TEST_EVERYTHING.md** | اختبار يدوي للمسارات. |
| **checklist_attendance_lifecycle.md** | التحقق من دورة الحضور. |

---

*هذه الوثيقة هي **الخطة النهائية المتكاملة** — مرجع واحد لما لدينا وما سنفعله بالخطة القادمة. تُحدَّث عند إنجاز بنود أو حسم قرارات.*
