# دراسة شاملة: مواقيت الصلاة (Aladhan API) وموقع المسجد

> **الهدف:** استبدال حزمة adhan بـ Aladhan API، تحسين الخريطة عند إنشاء المسجد، واستغلال موقع المسجد في كل ما يخص المواقيت والتحقق.  
> **التاريخ:** فبراير 2026

---

## 1. ملخص القرارات

| القرار | التفصيل |
|--------|---------|
| **مواقيت الصلاة** | استبدال حزمة `adhan` بـ **Aladhan API** (api.aladhan.com) — مجاني، لا مفتاح مطلوب. |
| **طريقة الحساب للأردن** | **Muslim World League (method=3)** — مناسبة للأردن ومعتمدة عالمياً. |
| **مصدر الإحداثيات** | **موقع المسجد (lat/lng)** مصدر الحقيقة: التحقق من الحضور، وعرض «الصلاة القادمة» لولي الأمر/المشرف/الإمام حسب مسجدهم أو موقع المستخدم. |
| **الخريطة عند إنشاء مسجد** | شاشة **كاملة تقريباً**؛ تبدأ من **موقع المستخدم الحالي**؛ الإمام **يجب** أن يضغط بالضبط على مكان المسجد (لا ربط تلقائي بموقعه). |
| **من يشوف الصلاة القادمة؟** | ولي الأمر، المشرف، الإمام، سوبر أدمن — كلهم يشوفون الموعد القادم بشكل صحيح حسب السياق (مسجد أو موقع المستخدم). |

---

## 2. دراسة: ماذا نستفيد من موقع المسجد (lat/lng)؟

لتجنب الازدواجية وربط كل الميزات بمعلومة واحدة:

| الاستخدام | الوصف | الحالة الحالية / المطلوب |
|-----------|--------|---------------------------|
| **مواقيت الصلاة للمسجد** | حساب أوقات الصلاة حسب إحداثيات المسجد (دقة حسب الموقع الفعلي). | حالياً: افتراضي مكة أو موقع عام. المطلوب: استخدام lat/lng المسجد عند عرض المواقيت في لوحة الإمام/المشرف وعند التحقق من الحضور. |
| **التحقق من وقت الحضور** | هل حان أذان الصلاة؟ هل ما زلنا ضمن نافذة الحضور؟ → يُحسب من **موقع المسجد** (لأن الحضور يُسجّل في ذلك المسجد). | موجود في `AttendanceValidationService` لكنه يعتمد على حزمة adhan. المطلوب: نفس المنطق مع أوقات من Aladhan API حسب مسجد التحضير. |
| **عرض «الصلاة القادمة» لولي الأمر** | ولي الأمر قد يكون عنده أطفال في أكثر من مسجد؛ الأفضل عرض مواقيت حسب **مسجد الطفل** أو حسب **موقع ولي الأمر الحالي** (لراحته). | حالياً: خدمة واحدة بإحداثيات افتراضية. المطلوب: إما حسب مسجد الطفل المرتبط بالبطاقة، أو حسب موقع المستخدم (مع Aladhan API). |
| **عرض «الصلاة القادمة» للمشرف/الإمام** | المواقيت يجب أن تكون حسب **موقع المسجد** الذي يعمل فيه المشرف/الإمام. | نفس الفكرة: جلب أوقات من API بإحداثيات المسجد. |
| **سوبر أدمن** | يمكن عرض مواقيت حسب **موقع المستخدم** أو مدينة افتراضية (مثل عمان). | جلب من API حسب موقع أو إحداثيات ثابتة للأردن. |
| **خريطة المساجد / المسافة** | (لاحقاً) مسافة ولي الأمر من المسجد، أقرب مساجد، إلخ. | يعتمد على وجود lat/lng المسجد — موجود. |

**الخلاصة:** موقع المسجد (lat/lng) يصبح **مصدر الحقيقة** لـ: (1) مواقيت الصلاة في سياق ذلك المسجد، (2) التحقق من وقت الحضور، (3) عرض «الصلاة القادمة» للمشرف والإمام. لولي الأمر وسوبر أدمن نحدد: إما حسب مسجد معين أو حسب موقع المستخدم عبر API.

---

## 3. خطة مواقيت الصلاة — Aladhan API

### 3.1 الـ API

- **Base URL:** `https://api.aladhan.com/v1/`
- **Endpoint أوقات اليوم:** `GET /timings?latitude={lat}&longitude={lng}&method={method}`  
  أو بتاريخ: `GET /timings/{date}?latitude=...&longitude=...&method=...`  
  (التاريخ بصيغة `dd-mm-yyyy`).
- **لا يتطلب API Key** — مجاني للاستخدام المعقول.
- **طريقة الحساب للأردن:** `method=3` (Muslim World League) — مناسبة للأردن.

### 3.2 الاستجابة (مختصر)

```json
{
  "data": {
    "timings": {
      "Fajr": "05:45",
      "Dhuhr": "12:50",
      "Asr": "16:00",
      "Maghrib": "18:27",
      "Isha": "19:46"
    },
    "date": { "gregorian": { "date": "20-02-2026" } }
  }
}
```

نحوّل النص إلى `DateTime` (اليوم الحالي + الوقت) للمقارنة مع الوقت الحالي وحساب «الصلاة القادمة».

### 3.3 التصميم المقترح في التطبيق

| المكون | المسؤولية |
|--------|-----------|
| **AladhanApiClient (أو خدمة)** | استدعاء HTTP لـ `/timings` و `/timings/{date}`، تحويل JSON إلى أوقات (DateTime أو نموذج داخلي). |
| **PrayerTimesService** | واجهة موحّدة كما هي الآن: `getTodayPrayerTimes()`, `getNextPrayer()`, `getPrayerTimesForDate()`, إلخ. بدلاً من adhan نستخدم نتائج الـ API. نمرّر الإحداثيات (من المسجد أو من موقع المستخدم) في كل طلب أو نحدّث «الموقع الحالي» للخدمة. |
| **التخزين المؤقت (Cache)** | تخزين أوقات اليوم (أو اليوم + تاريخ محدد) حسب (lat, lng, date) لتقليل الطلبات. انتهاء الصلاحية: منتصف الليل أو بعد آخر صلاة. |
| **مصدر الإحداثيات** | للإمام/المشرف: مسجد الحالية (من سياق الشاشة). لولي الأمر: إما مسجد الطفل المعروض أو موقع المستخدم (geolocator). لسوبر أدمن: موقع المستخدم أو إحداثيات ثابتة (عمان). |

### 3.4 من يشوف الصلاة القادمة وبأي شكل

| الدور | مصدر الإحداثيات | الشكل |
|-------|------------------|--------|
| **ولي الأمر** | مسجد الطفل (أو موقع المستخدم إن لم يكن مرتبطاً بمسجد). | نفس الويدجت/النص الحالي: «الصلاة القادمة: الظهر 12:50» + المتبقي. |
| **المشرف** | مسجد المشرف (من سياق التحضير). | في شاشة التحضير والـ dashboard: الصلاة القادمة حسب مسجد المسجد. |
| **الإمام** | مسجد الإمام. | في اللوحة: الصلاة القادمة حسب مسجده. |
| **سوبر أدمن** | موقع المستخدم أو عمان (ثابت). | في لوحة الأدمن: الصلاة القادمة بشكل صحيح. |

الواجهة الحالية (نص + وقت متبقي) تبقى؛ المتغيّر هو مصدر البيانات (API بدل adhan) ومصدر الإحداثيات (موقع المسجد أو المستخدم).

### 3.5 التحقق من الحضور (AttendanceValidationService)

- المدخلات: الصلاة، التاريخ، **إحداثيات المسجد** (من مسجد التحضير)، نافذة الدقائق.
- الخطوات: جلب أوقات ذلك اليوم من Aladhan API بإحداثيات المسجد، استخراج وقت الأذان للصلاة المطلوبة، التحقق: الآن >= أذان؟ الآن <= أذان + نافذة؟
- لا اعتماد على حزمة adhan بعد التبديل.

---

## 4. خطة الخريطة عند إنشاء المسجد

| المطلب | التنفيذ |
|--------|---------|
| **الخريطة تكاد تكون كامل الشاشة** | عند إنشاء مسجد: فتح **شاشة كاملة** (وليس حوار صغير) لاختيار الموقع — أو شاشة بارتفاع كبير جداً (أغلب الشاشة) بحيث الخريطة هي المحتوى الرئيسي. |
| **البداية من موقع المستخدم** | عند فتح الشاشة: جلب **الموقع الحالي (GPS)** وتمركز الخريطة عليه ووضع علامة «أنت هنا». الإمام يتحرك على الخريطة ويضغط **على مكان المسجد بالضبط**. |
| **المسجد غير ملزق بدره** | لا نضع تلقائياً موقع المسجد = موقع المستخدم. المستخدم **يجب** أن يختار النقطة بنقرة واضحة (علامة حمراء) ثم يؤكد. |
| **تحسين كل ما يخص الخريطة** | وضوح العلامات (موقعك أزرق، موقع المسجد أحمر)، نص توجيهي («اضغط على مكان المسجد»)، زر تأكيد واضح، إمكانية التكبير/التصغير والتحريك بسلاسة. |

تنفيذياً:
- في **إنشاء مسجد**: استدعاء **شاشة كاملة** لاختيار الموقع (نفس منطق Map Picker لكن full screen)، البداية من `_myLocation` إن وُجد، وإرجاع (lat, lng) فقط عند «تأكيد الموقع».
- في **إعدادات المسجد** (لاحقاً): يمكن الإبقاء على الحوار أو فتح الشاشة الكاملة أيضاً للاتساق.

---

## 5. ترتيب التنفيذ المقترح

1. **إزالة اعتماد adhan** من المشروع (بعد استبدال كل الاستخدامات).
2. **إنشاء عميل Aladhan API** + **تعديل PrayerTimesService** لاستخدام الـ API (مع cache بسيط حسب التاريخ والإحداثيات).
3. **تعديل AttendanceValidationService** لاستخدام أوقات من PrayerTimesService (التي أصبحت تعتمد على API) مع إحداثيات المسجد.
4. **ربط الإحداثيات حسب الدور:** الإمام/المشرف = مسجد الحالية؛ ولي الأمر = مسجد الطفل أو موقع المستخدم؛ سوبر أدمن = موقع أو عمان.
5. **الخريطة عند إنشاء مسجد:** شاشة كاملة، بداية من موقع المستخدم، مع توجيه واضح أن يضغط على مكان المسجد ويؤكد.
6. **مراجعة كل الشاشات** التي تعرض «الصلاة القادمة» والتأكد من تمرير الإحداثيات الصحيحة (مسجد أو مستخدم).

---

## 6. ملخص الفوائد

- **معلومة واحدة (موقع المسجد):** تُستخدم في المواقيت، التحقق من الحضور، وفي المستقبل للمسافة والخريطة.
- **مواقيت موحّدة ومعتمدة:** Aladhan API + Muslim World League — مناسبة للأردن وواضحة للمستخدمين.
- **تجربة واضحة للإمام:** خريطة كبيرة تبدأ من موقعه، مع ضرورة النقر على مكان المسجد فعلياً — لا التباس بين «موقعي» و«موقع المسجد».

---

*انتهت الدراسة. خطة التنفيذ التفصيلية في `tasks/prayer_times_and_map_plan.md`.*
