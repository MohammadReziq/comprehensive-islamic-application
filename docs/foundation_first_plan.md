# خطة البنية التحتية أولاً — صلاتي حياتي

**الفكرة:** نجهّز كل شيء في الباكند والطبقات (جداول، RLS، موديلات، ريپو، خدمات) **قبل** التركيز على الشاشات. نجمّع كل الأفكار والمتطلبات لكل دور، ثم ننفّذ الطبقة التحتية بحيث التطبيق يصير **تطبيق صلاة متكامل للمسابقات** مع ترابط قوي بين كل الأدوار.

---

## 0. نقد لاذع — ما الذي سينكسر على أرض الواقع؟

هذا القسم يوضح **ثغرات حقيقية** في الخطة والبنية الحالية؛ لو لم نعالجها، سنصطدم بها عند النشر أو عند أول استخدام مكثّف.

### 0.1 نقاط الضعف في الوثيقة الأصلية

| المشكلة | لماذا خطيرة |
|---------|-------------|
| **الوثيقة لم تذكر المناطق الزمنية (Timezone)** | `prayer_date` من نوع DATE: هل هو تاريخ الجهاز المحلي؟ لو المشرف في الرياض وولي الأمر في مصر، "اليوم" قد يختلف عند منتصف الليل. أوقات الصلاة أيضاً مرتبطة بموقع ثابت (مكة) في الكود — مسجد في تركيا سيرى أوقاتاً خاطئة. |
| **لا يوجد تعريف واضح لـ "تنفيذ التصحيح"** | عند موافقة الإمام على طلب تصحيح: هل نُدخل سجل حضور جديد في `attendance`؟ إذا نعم، من يحدّث نقاط/سلسلة الطفل — نفس الـ trigger؟ وإذا رفضنا الطلب، هل نغيّر الحالة فقط؟ ماذا لو ولي الأمر يطلب تصحيح صلاة "موجودة أصلاً" (سجّل حضور ثم يطلب إضافة نفس الصلاة)؟ قواعد العمل غير مكتوبة. |
| **حساب السلسلة (streak) غير مُعرّف في الخطة** | الـ trigger أو التطبيق يجب أن يحسب `current_streak` و `best_streak` من جدول `attendance`. السلسلة = أيام متتالية من آخر تاريخ حضور. هل نعتبر "اليوم" بتوقيت UTC أم بتوقيت المسجد؟ هل صلاة واحدة في اليوم تكفي لاستمرار السلسلة؟ الخطة تقول "تحديث النقاط والسلاسل" لكن **الخوارزمية** غير موثّقة. |
| **طلبات التصحيح: تكرار غير مُمنوع** | جدول `correction_requests` لا يحتوي UNIQUE على (child_id, prayer, prayer_date). ولي الأمر يقدر يرسل ١٠ طلبات لنفس الصلاة ونفس اليوم — ازدحام وارتباك للمشرف. |
| **الملاحظات (notes): ثغرة RLS** | السياسة الحالية "Notes: supervisor sends" تتحقق فقط من `sender_id = auth user`. أي مستخدم مسجّل يقدر يضيف ملاحظة ويضع نفسه مرسلاً. المطلوب: **المرسل يجب أن يكون عضواً في المسجد** (من mosque_members) حتى لا يستطيع ولي الأمر انتحال شخصية مشرف. |
| **المسابقة والنقاط: علاقة غير محددة** | الخطة تقول "ربط attendance بـ competition_id لاحقاً أو نعتبر النقاط عالمية". على أرض الواقع: لو النقاط عالمية والمسابقة "للعرض فقط"، ترتيب المسابقة يُحسب من مجموع حضور الفترة — لكن لو سجّلنا حضوراً بعد نهاية المسابقة بالخطأ، هل يدخل في المسابقة؟ بدون تعريف واضح سنختلف عند أول باگ. |
| **لا ذكر للـ Offline والتناقضات** | الوثيقة الأخرى تذكر وضع عدم الاتصال. لو المشرف سجّل حضوراً بدون نت ثم رفع لاحقاً، `prayer_date` قد يكون "أمس" على السيرفر. والـ trigger سيُشغّل عند الإدراج المتأخر — هل نحدّث السلسلة بناءً على prayer_date أم على recorded_at؟ قرار مصيري. |
| **لا فحص لمنع التصحيح لصلاة مُسجّلة مسبقاً** | ولي الأمر يطلب "إضافة حضور الفجر ١٠/١" بينما المشرف سجّل الفجر فعلاً. المنطق الصحيح: رفض الطلب أو اعتباره "تعديل" وليس "إضافة". يحتاج فحص في الريپو: قبل إنشاء طلب تصحيح، تحقق من عدم وجود سجل حضور لنفس الطفل/صلاة/تاريخ. |
| **الإعلانات: من يعدّل أو يحذف؟** | الجدول والـ RLS يسمحان بإنشاء وقراءة. لا سياسة UPDATE/DELETE — لو الإمام أخطأ في نص إعلان، لا يوجد آلية تعديل أو حذف موثّقة. |
| **مؤشرات (Indexes) ناقصة** | استعلام "طلبات التصحيح المعلقة لهذا المسجد" يحتاج تصفية بـ mosque_id + status. لا يوجد index مركّب على (mosque_id, status) في الوصف — استعلامات ثقيلة مع نمو البيانات. |

### 0.2 مخاطر عند التشغيل الفعلي

- **مشرفان يسجّلان نفس الطفل لنفس الصلاة في نفس اللحظة:** الـ UNIQUE(child_id, prayer, prayer_date) يمنع التكرار — جيد. لكن لو واجهة التطبيق لا تعرض "تم التسجيل مسبقاً" فوراً، المستخدم قد يعيد المحاولة ويستلم خطأ غامضاً — تجربة مستخدم سيئة.
- **إمام يغيّر مسابقة نشطة بعد بدء التسجيل:** لو ربطنا attendance بـ competition_id لاحقاً، السجلات القديمة ستبقى بدون مسابقة أو نضطر لـ backfill. قرار: إما نربط من أول يوم نضيف فيه المسابقات، أو نعتبر "المسابقة النشطة وقت recorded_at" ونحسب الترتيب ديناميكياً من الفترة فقط.
- **ولي أمر يربط طفله بمسجدين (أساسي + ثانوي) وكلاهما يسجّلون حضوراً:** جدول attendance يسمح بسجل واحد لكل (child, prayer, date). أول من يسجّل يربح — المسجد الثاني سيفشل أو نحتاج منطق "أي مسجد يُسجّل أولاً". الخطة الحالية لا تذكر هذا.
- **حذف أو "تراجع" عن حضور:** لو اكتشف المشرف أنه سجّل بالخطأ، لا يوجد آلية موثّقة لـ "إلغاء حضور". حذف سجل من attendance يخالف النقاط والسلاسل ما لم نُعد حسابهما. يحتاج إما RPC "إلغاء حضور" يحدّث الطفل ويعيد الحساب، أو منع الحذف واعتماد "طلب تصحيح" فقط.

### 0.3 مرجع سريع: خطر ← أين المُعالجة في الوثيقة

| الخطر / الثغرة | القسم الذي يعالجه |
|-----------------|-------------------|
| المناطق الزمنية وأوقات الصلاة | §7 قرار 1 و 2؛ §8.3 توقيت المسجد |
| تنفيذ التصحيح وسيناريوهات الرفض | §7 قرار 5 و 6؛ §8.2 CorrectionRepository |
| حساب السلسلة وتعريف "اليوم" | §7 قرار 3 و 4 و 10؛ §8.1 trigger |
| تكرار طلبات التصحيح | §7 قرار 6؛ §8.1 و §8.2 |
| ثغرة RLS للملاحظات | §7 قرار 9؛ §8.1 Notes RLS |
| مسابقة ونقاط وحذف حضور | §7 قرار 7 و 8؛ §8.1 و §8.2 |
| Index أداء قوائم التصحيح | §8.1؛ §9 |

---

## 1. الموجود حالياً (ملخص سريع)

### 1.1 الباكند (Supabase)

| الجدول / المورد | الحالة | ملاحظات |
|------------------|--------|---------|
| `users` | ✅ | أدوار: super_admin, parent, imam, supervisor |
| `children` | ✅ | total_points, current_streak, best_streak موجودة |
| `mosques` | ✅ | code, invite_code, status |
| `mosque_members` | ✅ | owner / supervisor |
| `mosque_children` | ✅ | type (primary/secondary), local_number |
| `attendance` | ✅ | child_id, mosque_id, prayer, prayer_date, points_earned |
| `correction_requests` | ✅ | RLS موجود؛ لا يوجد ريپو/شاشات بعد |
| `notes` | ✅ | RLS موجود؛ لا يوجد ريپو/شاشات بعد |
| `announcements` | ✅ | RLS موجود؛ لا استخدام بعد |
| `badges` | ✅ | لا ريپو ولا ربط بعد |
| `rewards` | ✅ | لا ريپو ولا ربط بعد |
| **مسابقات (competitions)** | ❌ | **غير موجود** — المسابقة لها وقت محدد والإمام يحدده |

### 1.2 الموديلات (Models)

| الموديل | الملف | الحالة |
|---------|-------|--------|
| UserModel | user_model.dart | ✅ |
| ChildModel | child_model.dart | ✅ |
| MosqueModel | mosque_model.dart | ✅ |
| AttendanceModel | attendance_model.dart | ✅ |
| MosqueMemberModel, MosqueJoinRequestModel | other_models.dart | ✅ |
| MosqueStudentModel | mosque_student_model.dart | ✅ |
| CorrectionRequest | — | ❌ غير موجود |
| Note | — | ❌ غير موجود |
| Announcement | — | ❌ غير موجود |
| Reward, Badge | — | ❌ غير موجود (أو جزء من other_models) |
| Competition | — | ❌ غير موجود |

### 1.3 الريپو (Repositories)

| الريپو | المسؤولية | الحالة |
|--------|-----------|--------|
| AuthRepository | تسجيل دخول، ملف المستخدم | ✅ |
| MosqueRepository | إنشاء مسجد، انضمام بدعوة، طلبات الانضمام، أعضاء، أكواد | ✅ |
| ChildRepository | أطفالي، إضافة طفل، ربط بمسجد، حضور أطفالي | ✅ |
| SupervisorRepository | طلاب المسجد، تسجيل حضور، إحصائيات اليوم، getChildById | ✅ |
| CorrectionRepository | إنشاء/قراءة/تحديث طلبات التصحيح | ❌ |
| NotesRepository | إرسال ملاحظة، قراءة ملاحظات أطفالي | ❌ |
| AnnouncementsRepository | إنشاء إعلان (إمام/مشرف)، قراءة إعلانات المسجد | ❌ |
| CompetitionRepository | إنشاء مسابقة، فترات، تفعيل/إيقاف (إمام) | ❌ |
| Rewards/Badges (قراءة) | يمكن داخل ChildRepository أو ريپو منفصل | ❌ |

### 1.4 الخدمات (Services)

| الخدمة | المسؤولية | الحالة |
|--------|-----------|--------|
| PointsService | حساب نقاط الحضور، مكافآت السلاسل، المستويات، تقييم الشارات | ✅ |
| PrayerTimesService | أوقات الصلاة، الصلاة القادمة، الصلاة الحالية | ✅ |
| RealtimeService | اشتراك attendance, mosques, mosque_children | ✅ |
| **AttendanceValidationService** | التحقق: لا تسجيل قبل الأذان، نافذة ساعة بعد الأذان | ❌ |
| **تحديث النقاط والسلاسل** | بعد تسجيل حضور: تحديث children.total_points, current_streak, best_streak | ⚠️ غير مضمون (لا trigger في DB؛ الريپو لا يحدّث الطفل) |
| NotificationService (FCM) | إرسال من الخادم عند الأحداث | ⚠️ جزئي / لاحقاً |

---

## 2. ما الناقص ليكون التطبيق متكاملاً (حسب الأدوار)

### 2.1 سوبر أدمن
- **موجود:** قراءة/تحديث طلبات المساجد (موافقة/رفض).
- **ناقص (إن رغبت):** إحصائيات عامة (عدد المساجد، المستخدمين، إلخ) — اختياري.

### 2.2 الإمام (مدير المسجد)
- **موجود:** مسجد، أكواد، مشرفون، طلبات انضمام، التحضير، الطلاب، إحصائيات اليوم.
- **ناقص:**
  - **مسابقات:** إنشاء مسابقة بفترة (تاريخ بداية، تاريخ نهاية)، تفعيل مسابقة واحدة "نشطة" للمسجد، وإيقافها. كل الحضور والنقاط خلال الفترة تُربط بالمسابقة (أو نحدد لاحقاً إن النقاط عالمية أم per-competition).
  - **طلبات التصحيح:** عرض قائمة طلبات التصحيح للمسجد، الموافقة/الرفض وتنفيذ التصحيح (إضافة/تعديل حضور).
  - **الملاحظات:** قراءة ملاحظات المرسلة من المشرفين (إن رغبت).
  - **إعلانات:** إنشاء إعلان للمسجد (موجود جدول + RLS، يحتاج ريپو فقط).
  - **التحقق من وقت الحضور:** قبل حفظ الحضور: لا قبل الأذان، ونافذة ساعة بعد الأذان (خدمة + استدعاء من ريپو التحضير).

### 2.3 المشرف (مُشرِف)
- **موجود:** طلاب المسجد، تسجيل حضور، إحصائيات اليوم، ملف الطالب.
- **ناقص:**
  - **طلبات التصحيح:** عرض طلبات التصحيح للمسجد، تنفيذ التصحيح (موافقة + تعديل حضور) أو رفض.
  - **الملاحظات:** إرسال ملاحظة لولي الأمر عن طفل (جدول + RLS جاهز، يحتاج ريپو + موديل).
  - **قراءة إعلانات المسجد** (إن وُجد ريپو).
  - **التحقق من وقت الحضور** (نفس خدمة الإمام).

### 2.4 ولي الأمر
- **موجود:** أطفالي، ربط بمسجد، حضور اليوم، تفاصيل الطفل.
- **ناقص:**
  - **طلبات التصحيح:** إنشاء طلب تصحيح (وصف، صلاة، تاريخ) — جدول + RLS جاهز، يحتاج ريپو + موديل.
  - **الملاحظات:** قراءة ملاحظات المشرف عن أطفالي.
  - **المسابقة النشطة:** إن كانت المسابقة مرتبطة بفترة — عرض "المسابقة الحالية" ونقاط الطفل خلالها (يعتمد تصميم المسابقات).
  - **الجوائز/الشارات:** قراءة rewards و badges للطفل (اختياري في المرحلة الأولى).

---

## 3. خريطة الترابط بين الأدوار (بدون شاشات)

```
سوبر أدمن ──► mosques (موافقة/رفض) ──► الإمام يرى لوحته
                    │
الإمام ──► مسجد، أكواد، مشرفون، مسابقات (فترة)، إعلانات
    │         │
    │         ├──► المشرف: انضمام بدعوة، تسجيل حضور، تصحيحات، ملاحظات
    │         │
    │         └──► ولي الأمر: ربط طفل بكود المسجد
    │
    └──► الحضور (attendance) ←── يُسجّل من الإمام/المشرف
              │
              ├──► تحديث نقاط/سلاسل الطفل (يجب ضمانه في DB أو من التطبيق)
              ├──► ولي الأمر يرى حضور اليوم
              └──► (لاحقاً) مسابقة نشطة: احتساب نقاط الفترة

طلبات التصحيح: ولي الأمر يطلب ──► الإمام/المشرف يراجع وينفّذ
الملاحظات: المشرف يرسل ──► ولي الأمر يقرأ
```

---

## 4. خطة التنفيذ — البنية التحتية فقط (بدون شاشات)

### المرحلة أ: الباكند والموديلات

| # | المهمة | التفصيل |
|---|--------|---------|
| A1 | **جدول المسابقات** | migration: `competitions` (id, mosque_id, name_ar, start_date, end_date, is_active, created_by, created_at). RLS: الإمام يقرأ/يكتب مسابقات مسجده. (اختياري: ربط attendance بـ competition_id لاحقاً أو نعتبر النقاط عالمية والمسابقة للعرض فقط ضمن الفترة.) |
| A2 | **تحديث نقاط الطفل بعد الحضور** | إما (1) DB: trigger أو function بعد INSERT في attendance تُحدّث children.total_points و current_streak و best_streak، أو (2) من التطبيق: بعد recordAttendance نستدعي RPC أو نحدّث الطفل. يُفضّل (1) لضمان اتساق البيانات. |
| A3 | **موديلات Flutter** | إنشاء/إكمال: CorrectionRequestModel, NoteModel, AnnouncementModel, CompetitionModel. إن لم تكن Reward/Badge مستخدمة بعد يمكن تأجيلها. |

### المرحلة ب: الريپو والخدمات (بدون واجهات)

| # | المهمة | التفصيل |
|---|--------|---------|
| B1 | **AttendanceValidationService** | دالة: هل يمكن تسجيل حضور لهذه الصلاة الآن؟ (لا قبل وقت الأذان، ونافذة ساعة بعد الأذان). تستخدم PrayerTimesService. يُستدعى من SupervisorRepository قبل recordAttendance. |
| B2 | **تحديث الريپو عند التسجيل** | إن لم نضع trigger في DB: بعد recordAttendance استدعاء تحديث نقاط/سلسلة الطفل (RPC أو update children). إن وُجد trigger يُلغى هذا. |
| B3 | **CorrectionRepository** | إنشاء طلب (parent)، جلب طلبات المسجد (imam/supervisor)، تحديث حالة (موافقة/رفض) وتنفيذ التصحيح (إضافة سجل حضور أو تعديل). يعتمد CorrectionRequestModel. |
| B4 | **NotesRepository** | إرسال ملاحظة (مشرف/إمام)، جلب ملاحظات أطفالي (parent). يعتمد NoteModel. |
| B5 | **AnnouncementsRepository** | إنشاء إعلان (إمام/مشرف)، جلب إعلانات المسجد (الجميع). يعتمد AnnouncementModel. |
| B6 | **CompetitionRepository** | إنشاء مسابقة (إمام)، جلب مسابقات المسجد، تفعيل/إيقاف مسابقة (is_active). جلب المسابقة النشطة للمسجد. يعتمد CompetitionModel. |

### المرحلة ج: Realtime والإشعارات (اختياري في البنية الأولى)

| # | المهمة | التفصيل |
|---|--------|---------|
| C1 | Realtime لـ correction_requests و notes | إضافة في RealtimeService: subscribeCorrectionRequests(mosqueId), subscribeNotesForParent(childIds أو parentId). لاستخدامها لاحقاً في الشاشات. |
| C2 | FCM من الخادم | Edge Function أو Cron: عند INSERT في attendance / mosques (موافقة) / correction_requests / notes → إرسال إشعار. يمكن تأجيله بعد استقرار الشاشات. |

---

## 5. ترتيب مقترح للتنفيذ (طبقة تحتية فقط)

1. **A2 + B2** — ضمان تحديث نقاط/سلاسل الطفل عند الحضور (trigger أو RPC + تحديث من التطبيق).
2. **A3 (جزء)** — موديلات: CorrectionRequest, Note, Announcement.
3. **B1** — AttendanceValidationService + ربطها في SupervisorRepository.recordAttendance.
4. **B3** — CorrectionRepository (كامل من ناحية بيانات).
5. **B4** — NotesRepository.
6. **B5** — AnnouncementsRepository.
7. **A1 + A3 (Competition) + B6** — مسابقات: migration، موديل، ريپو.
8. **C1** — Realtime للتصحيحات والملاحظات (حسب الحاجة عند بناء الشاشات).

بهذا الترتيب تصبح كل البيانات والعمليات جاهزة: تصحيحات، ملاحظات، إعلانات، مسابقات، وتحقق أوقات الحضور. بعدها نركّز على الشاشات دون نقص في الطبقة التحتية.

---

## 6. ملخص: ما الذي يحصل عليه كل دور (من الطبقة التحتية)

| الدور | ما يحتاجه من البيانات/العمليات (جاهز أو سيُبنى) |
|-------|-----------------------------------------------|
| **سوبر أدمن** | قراءة/تحديث mosques (موافقة/رفض). ✅ |
| **الإمام** | مسجد، أعضاء، طلبات انضمام، أكواد، طلاب، حضور، **مسابقات (CRUD + تفعيل)**، **طلبات تصحيح (قراءة + مراجعة)**، **إعلانات (إنشاء)**، تحقق وقت الحضور. |
| **المشرف** | طلاب المسجد، تسجيل حضور (مع تحقق الوقت)، **طلبات تصحيح (قراءة + تنفيذ)**، **ملاحظات (إرسال)**، **إعلانات (قراءة)**، تحقق وقت الحضور. |
| **ولي الأمر** | أطفالي، ربط بمسجد، حضور اليوم، **طلب تصحيح (إنشاء)**، **ملاحظات (قراءة)**، (اختياري) مسابقة نشطة وجوائز/شارات. |

---

---

## 7. قرارات مصيرية ومناطق رمادية (يجب حسمها قبل التنفيذ)

| # | القرار | الخيارات | التوصية |
|---|--------|----------|---------|
| 1 | **منطقة زمنية لـ prayer_date و"اليوم"** | (أ) UTC (ب) توقيت المسجد (ج) توقيت الجهاز | **(ب)** تخزين prayer_date بـ DATE بدون وقت؛ حساب "اليوم" في التطبيق بتوقيت المسجد (نخزّن timezone أو lat/lng للمسجد ونستخدمها). واجهة التحضير تستخدم نفس التوقيت. |
| 2 | **أوقات الصلاة حسب المسجد** | (أ) مكة ثابتة (ب) إحداثيات المسجد لكل مسجد | **(ب)** جدول mosques فيه lat/lng — PrayerTimesService تأخذ إحداثيات المسجد الحالي عند التحضير. |
| 3 | **تعريف السلسلة (streak)** | (أ) يوم فيه صلاة واحدة على الأقل (ب) كل الصلوات الخمس (ج) صلوات المسجد فقط | **(أ)** يوم واحد فيه أي حضور = اليوم "مُحسوب" للسلسلة. الخوارزمية: من آخر تاريخ حضور، عد الأيام المتتالية إلى الوراء. |
| 4 | **تحديث النقاط/السلسلة: أين؟** | (أ) Trigger في DB بعد INSERT attendance (ب) RPC يستدعيها التطبيق بعد التسجيل (ج) من التطبيق مباشرة (update children) | **(أ)** trigger يضمن اتساقاً حتى مع Realtime وOffline sync. الـ trigger يقرأ prayer_date و child_id ويُعيد حساب total_points و current_streak و best_streak من جدول attendance. |
| 5 | **عند موافقة طلب التصحيح** | (أ) إدراج سجل في attendance فقط (الـ trigger يحدّث الطفل) (ب) إدراج + تحديث reviewed_at و reviewed_by في correction_requests | **(أ+ب)** إدراج حضور ثم UPDATE correction_requests (status=approved, reviewed_by, reviewed_at). التحقق قبل الموافقة: لا يوجد حضور لنفس (child, prayer, date). |
| 6 | **منع تكرار طلبات التصحيح** | (أ) UNIQUE(child_id, prayer, prayer_date) في correction_requests (ب) فحص في الريپو فقط (ج) UNIQUE + فحص "لا يوجد حضور أصلاً" | **(ج)** إضافة UNIQUE أو فحص في التطبيق: طلب واحد مفتوح لكل (child, prayer, date). وفي إنشاء الطلب: رفض إن وُجد سجل حضور لنفس الثلاثية. |
| 7 | **ربط المسابقة بالحضور** | (أ) عمود competition_id في attendance (ب) حساب ترتيب المسابقة ديناميكياً من (prayer_date بين start و end) بدون عمود | **(أ)** إذا أردنا تقارير وفلترة واضحة. عند إدراج حضور: إن وُجدت مسابقة نشطة للمسجد في ذلك اليوم، نملأ competition_id. السجلات القديمة تبقى competition_id = NULL أو نعمل backfill لاحقاً. |
| 8 | **إلغاء حضور خاطئ** | (أ) لا حذف؛ فقط "طلب تصحيح" من المشرف (ب) RPC "إلغاء حضور" يحذف السجل ويُعيد حساب نقاط/سلسلة الطفل | **(ب)** RPC أو endpoint محدد: يحذف سجل attendance ويستدعي نفس منطق إعادة الحساب (أو trigger على DELETE). صلاحية: فقط من recorded_by أو عضو مسجد خلال نافذة زمنية (مثلاً 24 ساعة). |
| 9 | **Notes: من يرسل؟** | تقييد INSERT بمن هو عضو في المسجد (mosque_members) | تعديل RLS: WITH CHECK (sender_id = auth AND sender_id IN (SELECT user_id FROM mosque_members WHERE mosque_id = notes.mosque_id)). |
| 10 | **Offline: prayer_date vs recorded_at** | عند رفع حضور مُسجّل offline، السلسلة تُحسب من prayer_date أم recorded_at؟ | **prayer_date** — السلسلة تعتمد "أي يوم صلّى" وليس "متى رُفع السجل". الـ trigger يستخدم prayer_date دائماً. |

---

## 8. تفصيل تنفيذي مُحدّث (بنود أدق)

### 8.1 الباكند — Migrations جديدة أو تعديلات

| الملف/المهمة | المحتوى |
|---------------|----------|
| **تحديث نقاط/سلسلة (trigger)** | دالة PL/pgSQL: من جدول attendance لطفل معيّن، احسب total_points (مجموع points_earned)، current_streak (أيام متتالية من آخر تاريخ)، best_streak (أعلى سلسلة). تُستدعى من trigger AFTER INSERT OR DELETE ON attendance. |
| **competitions** | CREATE TABLE: id, mosque_id, name_ar, start_date, end_date, is_active (واحد فقط نشط per mosque)، created_by, created_at. RLS: قراءة/كتابة لـ owner المسجد. |
| **attendance.competition_id** | ALTER TABLE attendance ADD COLUMN competition_id UUID REFERENCES competitions(id). عند INSERT حضور: اختياريًا نملأه من المسابقة النشطة للمسجد في prayer_date. |
| **correction_requests** | إضافة فحص أو UNIQUE: منع أكثر من طلب pending لنفس (child_id, prayer, prayer_date). أو constraint + فحص في التطبيق. |
| **Index** | CREATE INDEX idx_correction_requests_mosque_status ON correction_requests(mosque_id, status). |
| **Notes RLS** | تعديل سياسة INSERT: المرسل يجب أن يكون في mosque_members لنفس mosque_id. |
| **Announcements** | سياسات UPDATE/DELETE لـ sender أو owner المسجد (اختياري للمرحلة الأولى). |

### 8.2 الريپو — قواعد عمل صريحة

| الريپو | قواعد يجب تطبيقها في الكود |
|--------|----------------------------|
| **CorrectionRepository.createRequest** | قبل INSERT: التحقق من عدم وجود سجل حضور لـ (child_id, prayer, prayer_date). التحقق من عدم وجود طلب pending لنفس الثلاثية. ربط الطفل بمسجد (child في mosque_children لهذا mosque_id). |
| **CorrectionRepository.approveRequest** | التحقق من status = pending. التحقق من عدم وجود حضور مسبق. INSERT في attendance (مع points من PointsService)، ثم UPDATE correction_requests (status=approved, reviewed_by, reviewed_at). |
| **SupervisorRepository.recordAttendance** | استدعاء AttendanceValidationService قبل INSERT. إن فشل التحقق → رفض مع رسالة واضحة. |
| **NotesRepository.send** | التحقق من أن المرسل عضو في المسجد (لديك بالفعل من RLS بعد التعديل). |
| **CompetitionRepository** | عند "تفعيل" مسابقة: التأكد من إيقاف أي مسابقة نشطة أخرى لنفس المسجد (UPDATE is_active = false ثم تفعيل الجديدة). |

### 8.3 الخدمات — تفاصيل

| الخدمة | المدخلات والمخرجات |
|--------|---------------------|
| **AttendanceValidationService.canRecordNow(prayer, date, mosqueId?)** | يُستدعى بـ prayer و date (واختياريًا mosque للموقع). يرجع: (allowed: bool, reason: String). القواعد: الآن >= وقت أذان الصلاة؛ الآن <= وقت الأذان + 1 ساعة (قابل للإعداد). استخدام PrayerTimesService بإحداثيات المسجد إن وُجدت. |
| **حساب السلسلة (في DB أو خدمة)** | الدالة تأخذ child_id وتُرجع (current_streak, best_streak) من attendance. تُستخدم في الـ trigger أو في RPC إعادة الحساب عند الحذف. |

### 8.4 موديلات — حقول مطلوبة

| الموديل | حقول أساسية |
|---------|-------------|
| **CorrectionRequestModel** | id, childId, parentId, mosqueId, prayer, prayerDate, status, note, reviewedBy, reviewedAt, createdAt. (اختياري: childName من join). |
| **NoteModel** | id, childId, senderId, mosqueId, message, isRead, createdAt. (اختياري: senderName, childName). |
| **AnnouncementModel** | id, mosqueId, senderId, title, body, createdAt. |
| **CompetitionModel** | id, mosqueId, nameAr, startDate, endDate, isActive, createdBy, createdAt. |

---

## 9. ملخص: ما لا ننساه (Checklist محدّث)

- **المسابقة لها وقت محدد والإمام يحدده** → جدول `competitions` + فترة (start/end) + مسابقة نشطة واحدة فقط + ربط اختياري attendance.competition_id.
- **ترابط الأدوار:** حضور ← ولي الأمر؛ طلب تصحيح ← إمام/مشرف ينفّذ؛ ملاحظة ← ولي الأمر يقرأ. مع قواعد صريحة لتنفيذ التصحيح (إدراج حضور + تحديث الطلب).
- **التحقق من وقت الحضور:** لا قبل الأذان، نافذة ساعة بعد الأذان؛ استخدام توقيت/موقع المسجد إن أمكن.
- **النقاط والسلاسل:** trigger بعد INSERT/DELETE على attendance؛ السلسلة من prayer_date؛ إعادة حساب عند الحذف (إلغاء حضور).
- **طلبات التصحيح:** منع تكرار طلب لنفس (طفل، صلاة، تاريخ)؛ قبل الإنشاء التحقق من عدم وجود حضور؛ عند الموافقة إدراج حضور ثم تحديث الطلب.
- **الملاحظات:** تشديد RLS بحيث المرسل عضو في المسجد فقط.
- **المنطقة الزمنية والتوقيت:** حسم "اليوم" وتوقيت الصلاة حسب المسجد (إحداثيات/توقيت).
- **إلغاء حضور:** آلية موثّقة (RPC أو صلاحيات محدودة) مع إعادة حساب النقاط والسلاسل.
- **فهرسة correction_requests:** index (mosque_id, status) لأداء قوائم الطلبات.

---

## 10. مراجع وربط

- **الدراسة الشاملة:** `docs/study_roles_integration.md`
- **الخطة التفصيلية للشاشات والتسلسل:** `docs/plan_detailed_next.md`
- **اختبار دورة الحضور:** `docs/checklist_attendance_lifecycle.md`
- **تحديث هذه الوثيقة:** عند حسم أي قرار مصيري أو إنجاز بند، حدّث القسم المعني وتاريخ التحديث أدناه.

---

*آخر تحديث: بعد إضافة النقد اللاذع، قرارات مصيرية، وتفصيل تنفيذي. ربط مع plan_detailed_next.md عند التنفيذ.*
