# دراسة متكاملة — ما لدينا وما هو قادم | صلاتي حياتي

وثيقة مرجعية واحدة تجمع **الحالة الفعلية** للتطبيق (بعد كل ما تم بناؤه) و**ما هو قادم** مع أولويات ومخاطر وقرارات مفتوحة.  
محدّثة لتاريخ تنفيذ المسابقات، التصحيحات، الملاحظات، الـ migrations 020–023، والـ Router والدراور.

---

## خلاصة تنفيذية (صفحة واحدة)

| العنصر | الحالة |
|--------|--------|
| **الباكند** | Migrations 001–023 (جداول، RLS، triggers نقاط/سلاسل، مسابقات، RPCs) ✅ |
| **التصحيحات** | ريپو + بلوك + شاشة قائمة (مشرف/إمام) ✅ — **شاشة إنشاء طلب لولي الأمر** ❌ |
| **الملاحظات** | ريپو + بلوك + إرسال (مشرف/إمام) + صندوق ولي الأمر (مع اسم الطفل من DB) ✅ |
| **المسابقات** | ريپو + بلوك + شاشة إدارة (إمام/مشرف) ✅ — **شاشة المسابقة النشطة لولي الأمر** ❌ |
| **تحقق وقت الحضور** | AttendanceValidationService غير مبنٍ؛ recordAttendance لا يتحقق قبل الأذان/نافذة الساعة ❌ |
| **Realtime** | حضور، مساجد، mosque_children ✅ — تصحيحات وملاحظات ❌ |
| **أولوية قادمة** | (1) شاشة طلب تصحيح لولي الأمر (2) AttendanceValidationService (3) المسابقة النشطة لولي الأمر |

---

## فهرس الأجزاء

1. **ما لدينا اليوم** — Migrations، موديلات، ريپوهات، خدمات، شاشات ومسارات، ثغرات حالية.
2. **ما هو قادم** — مراحل مُرتّبة (قريبة، تالية، تحسينات، مؤجّل).
3. **خريطة الأدوار والترابط** — من يفعل ماذا ومن يرى ماذا.
4. **قرارات مصيرية ومخاطر** — مرجع سريع وربط مع foundation_first_plan.
5. **المراجع** — وثائق مرتبطة.

---

# الجزء الأول: ما لدينا اليوم (الحالة الفعلية)

## 1. البنية التحتية — Supabase (Migrations 001–023)

| # | المورد | الحالة | ملاحظة |
|---|--------|--------|--------|
| 001 | الجداول الأساسية، RLS، triggers تسجيل | ✅ | users, children, mosques, mosque_members, mosque_children, attendance, correction_requests, notes, announcements, badges, rewards |
| 002–006 | إصلاحات سياسات، super_admin، دعوة مشرفين | ✅ | |
| 007 | Realtime: نشر attendance, mosques | ✅ | |
| 008 | دور supervisor في user_role | ✅ | |
| 009–011 | طلبات انضمام مسجد، سياسات join_requests | ✅ | |
| 012–017 | RPC أسماء (مشرفين، طالبي انضمام) بدون recursion | ✅ | |
| 018 | قراءة حضور المسجد لأعضاء المسجد (مشرف يرى الحضور) | ✅ | |
| 019 | Realtime لـ mosque_children | ✅ | |
| **020** | **Trigger نقاط وسلاسل (recalc_child_stats)** | ✅ | بعد INSERT/DELETE على attendance يُحدّث children (total_points, current_streak, best_streak) |
| **021** | **إصلاح RLS (notes: مرسل من أعضاء المسجد)** | ✅ | تشديد أمان الملاحظات |
| **022** | **جدول competitions + attendance.competition_id + mosques.timezone** | ✅ | مسابقة نشطة واحدة per مسجد، RLS للإمام وأعضاء وأولياء الأمور |
| **023** | **Indexes، partial unique، RPC (activate_competition، approve_correction_request)** | ✅ | أداء وقواعد عمل آمنة |

**خلاصة الباكند:** كل الجداول والـ RLS والـ triggers والـ RPCs اللازمة لدورة الحضور، التصحيحات، الملاحظات، والمسابقات **موجودة ومطبّقة** (على افتراض تنفيذ 020–023 على المشروع).

---

## 2. الموديلات (Models)

| الموديل | الملف | الحالة |
|---------|-------|--------|
| UserModel | user_model.dart | ✅ |
| ChildModel | child_model.dart | ✅ |
| MosqueModel | mosque_model.dart | ✅ |
| AttendanceModel | attendance_model.dart | ✅ |
| MosqueMemberModel, MosqueJoinRequestModel | other_models.dart | ✅ |
| MosqueStudentModel | mosque_student_model.dart | ✅ |
| **CorrectionRequestModel** | correction_request_model.dart | ✅ |
| **NoteModel** | note_model.dart | ✅ (مع childName من JOIN) |
| **CompetitionModel** (+ LeaderboardEntry) | competition_model.dart | ✅ |
| AnnouncementModel | — | ❌ مؤجل لـ v2 |
| Reward / Badge (موديلات) | — | ❌ غير مستخدمة في الواجهة بعد |

---

## 3. الريپوهات (Repositories)

| الريپو | المسؤولية | الحالة |
|--------|-----------|--------|
| AuthRepository | تسجيل دخول، ملف المستخدم | ✅ |
| MosqueRepository | إنشاء مسجد، انضمام بدعوة، طلبات انضمام، أعضاء، أكواد | ✅ |
| ChildRepository | أطفالي، إضافة طفل، ربط بمسجد، حضور أطفالي | ✅ |
| SupervisorRepository | طلاب المسجد، تسجيل حضور، إحصائيات اليوم، getChildById، findChildByQrCode/localNumber | ✅ |
| **CorrectionRepository** | createRequest (مع فحص حضور مسبق + طلب pending)، getPendingForMosque، getMyRequests، approveRequest (RPC)، rejectRequest | ✅ |
| **NotesRepository** | sendNote، getNotesForMyChildren (مع JOIN children لاسم الطفل)، markAsRead | ✅ |
| **CompetitionRepository** | create، list، getActive، activate (RPC)، deactivate، getLeaderboard | ✅ |
| AnnouncementsRepository | — | ❌ مؤجل v2 |
| Rewards/Badges (قراءة) | — | ❌ غير مبنٍ |

---

## 4. الخدمات (Services)

| الخدمة | المسؤولية | الحالة |
|--------|-----------|--------|
| PointsService | نقاط الحضور، مكافآت السلاسل، المستويات، تقييم الشارات | ✅ |
| PrayerTimesService | أوقات الصلاة، الصلاة القادمة، الموقع (مكة افتراضي) | ✅ |
| RealtimeService | اشتراك attendance، mosques، mosque_children | ✅ |
| **AttendanceValidationService** | التحقق: لا قبل الأذان، نافذة ساعة بعد الأذان | ❌ **غير مبنٍ** — recordAttendance لا يستدعيه |
| تحديث النقاط/السلاسل | بعد الحضور | ✅ **عبر trigger 020** (لا يعتمد على التطبيق) |
| NotificationService (FCM) | توكن وإعدادات محليّة | ⚠️ جزئي — إرسال من الخادم غير مربوط |
| ConnectivityService / OfflineSyncService | اتصال وتخزين محلي | ⚠️ موجود في الكود؛ التكامل مع التحضير غير مكتمل |

---

## 5. الشاشات والمسارات (حسب الدور)

### سوبر أدمن
- طلبات المساجد (موافقة/رفض)، دراور، تسجيل خروج، **الملف الشخصي (تبويب)**.  
- **كل المطلوب لهذا الدور متوفر.**

### إمام
- بوابة المسجد → لوحة المدير (بعد الموافقة).
- لوحة المدير: مسجد، أكواد، طلبات انضمام، مشرفون، حضور اليوم، إجراءات (تحضير، طلاب، **طلبات التصحيح**، **الملاحظات**، **المسابقات**).
- التحضير (سكانر)، الطلاب (قائمة + ضغط → ملف الطالب)، **طلبات التصحيح** (قائمة + موافقة/رفض)، **الملاحظات** (إرسال ملاحظة)، **المسابقات** (إنشاء، تفعيل/إيقاف، ترتيب).
- دراور + شريط سفلي (لوحة المدير | الملف الشخصي).  
- **الناقص الوحيد:** تحقق وقت الحضور (AttendanceValidationService) قبل التسجيل.

### مشرف
- بوابة المسجد (انضم بدعوة) → لوحة المشرف.
- نفس الإجراءات: تحضير، طلاب، طلبات التصحيح، ملاحظات، **المسابقات** (عرض وترتيب؛ لا إنشاء).
- دراور + شريط سفلي.  
- **الناقص:** تحقق وقت الحضور قبل التسجيل.

### ولي الأمر
- الرئيسية: ترحيب، حضور اليوم (مع Realtime)، أطفالي، **ملاحظات المشرف** (من الدراور → صندوق الملاحظات).
- أطفالي → إضافة طفل، بطاقة الطفل (QR، نسخ)، ربط بمسجد.
- **لا توجد شاشة لإنشاء طلب تصحيح** — الريپو والبلوك جاهزان لكن لا زر ولا مسار في الواجهة.
- **لا شاشة "المسابقة النشطة"** لولي الأمر (عرض ترتيب أبنائه في المسابقة الحالية).
- دراور + شريط سفلي.  
- **الناقص:** شاشة/زر "طلب تصحيح" من بطاقة الطفل أو قائمة أطفالي، وشاشة المسابقة النشطة (اختياري).

---

## 6. Router وربط الشاشات

| المسار | الشاشة | من يصل إليها |
|--------|--------|---------------|
| /home | HomeScreen | ولي أمر (بعد تسجيل الدخول) |
| /parent/children, /parent/children/add, /parent/children/:id/card | أطفالي، إضافة، بطاقة الطفل | من دراور/أزرار ولي الأمر |
| **/parent/notes** | NotesInboxScreen (مع جلب أطفال ثم ملاحظات) | من دراور ولي الأمر ✅ |
| /admin | AdminMosqueRequestsScreen | سوبر أدمن |
| /mosque, /mosque/create, /mosque/join | بوابة المسجد، إنشاء، انضمام | إمام/مشرف |
| /imam/dashboard, /supervisor/dashboard | لوحتا الإمام والمشرف | بعد بوابة المسجد |
| /supervisor/scan, /supervisor/students, /supervisor/child/:id | التحضير، الطلاب، ملف الطالب | من الدراور والإجراءات |
| **/supervisor/corrections/:mosqueId**، **/imam/corrections/:mosqueId** | CorrectionsListScreen | من دراور وإجراءات مشرف/إمام ✅ |
| **/supervisor/notes/send/:mosqueId** | SendNoteScreen | من دراور وإجراءات مشرف/إمام ✅ |
| **/imam/competitions/:mosqueId**، **/supervisor/competitions/:mosqueId** | ManageCompetitionScreen | من دراور وإجراءات إمام/مشرف ✅ |
| /parent/notes | ملاحظات ولي الأمر | من دراور ولي الأمر ✅ |

**لا توجد صفحة مبنية ومربوطة بالـ Router بدون رابط في الواجهة** (بعد إضافة المسابقات للمشرف وملاحظات المشرف لولي الأمر).

---

## 7. ملخص الثغرات الحالية (ما يزال ناقصاً أو غير مكتمل)

| البند | الوصف | الأولوية |
|-------|--------|----------|
| **شاشة إنشاء طلب تصحيح لولي الأمر** | ريپو + بلوك جاهزان؛ لا واجهة (زر من بطاقة الطفل أو قائمة أطفالي → شاشة اختيار صلاة/تاريخ/ملاحظة → إرسال). | عالية |
| **AttendanceValidationService + ربطه في recordAttendance** | منع التسجيل قبل الأذان وخارج نافذة الساعة؛ الخطة موثّقة في foundation_first_plan. | عالية |
| **المسابقة النشطة لولي الأمر** | شاشة تعرض "المسابقة الحالية" للمسجد وترتيب أطفال المستخدم (من competition_id أو من الفترة). | متوسطة |
| **Realtime للتصحيحات والملاحظات** | اشتراك correction_requests و notes لظهور طلبات/ملاحظات جديدة فوراً دون سحب. | متوسطة |
| **أوقات الصلاة حسب المسجد** | استخدام lat/lng المسجد (من 022) في PrayerTimesService عند التحضير؛ حالياً مكة ثابتة. | متوسطة |
| **إلغاء حضور خاطئ** | RPC أو آلية موثّقة لحذف سجل حضور مع إعادة حساب النقاط/السلاسل (trigger على DELETE موجود في 020). | متوسطة |
| **FCM من الخادم** | إرسال إشعار عند: حضور، موافقة مسجد، طلب تصحيح، ملاحظة. | منخفضة / لاحقاً |
| **الإعلانات** | AnnouncementModel + AnnouncementsRepository + شاشات (مؤجل v2). | منخفضة |
| **مسجد أساسي + ثانوي (واجهة)** | حدّ مسجد أساسي وثانويان؛ واجهة ربط الطفل (النوع موجود في mosque_children). | منخفضة |
| **Offline للمسجد** | تخزين حضور محلي ومزامنة عند العودة (البنية مذكورة في الخدمات). | لاحقاً |
| **الجوائز والشارات (واجهة)** | قراءة rewards و badges للطفل وعرضها (جداول موجودة). | لاحقاً |

---

# الجزء الثاني: ما هو قادم (مُرتّب حسب الأولوية)

## المرحلة القريمة (إغلاق الثغرات الأساسية)

1. **شاشة إنشاء طلب تصحيح لولي الأمر**  
   - من بطاقة الطفل: زر "طلب تصحيح" → شاشة (أو ديالوغ): اختيار الصلاة، التاريخ، ملاحظة اختيارية، مسجد (إن كان الطفل مرتبطاً بأكثر من مسجد).  
   - استدعاء CorrectionBloc → CreateCorrectionRequest.  
   - التحقق من الربط بمسجد (child في mosque_children) وعرض رسالة واضحة إن فشل.

2. **AttendanceValidationService**  
   - إنشاء خدمة: `canRecordNow(prayer, date, { mosqueId })` → (allowed, reason?).  
   - القواعد: الوقت ≥ وقت أذان الصلاة؛ الوقت ≤ أذان + ساعة (ثابت أو من إعدادات).  
   - استدعاؤها من `SupervisorRepository.recordAttendance` قبل الـ insert؛ إن فشل → رفض مع رسالة للمستخدم.

3. **ربط أوقات الصلاة بالمسجد (اختياري في نفس المرحلة)**  
   - استخدام `mosques.timezone` أو lat/lng من 022 في PrayerTimesService عند فتح التحضير للمسجد الحالي.

## المرحلة التالية (تجربة مستخدم وإكمال الأدوار)

4. **شاشة المسابقة النشطة لولي الأمر**  
   - مسار مثل `/parent/competition` أو من لوحة الرئيسية: "المسابقة الحالية" إن وُجدت مسابقة نشطة لمسجد أحد أطفاله.  
   - عرض اسم المسابقة، الفترة، وترتيب أطفاله (نقاط خلال الفترة من attendance المرتبط بالمسابقة أو من competition_id).

5. **Realtime لطلبات التصحيح والملاحظات**  
   - في RealtimeService: subscribe لـ correction_requests (مرشّح mosque_id) و notes (مرشّح child_id لأطفال المستخدم).  
   - في الشاشات المعنية: عند الحدث إعادة جلب القائمة أو تحديث الـ Bloc.

6. **إلغاء حضور (للإمام/المشرف)**  
   - RPC أو endpoint: حذف سجل attendance مع استدعاء إعادة الحساب (أو الاعتماد على trigger DELETE في 020).  
   - صلاحيات: recorded_by أو عضو مسجد خلال نافذة زمنية (مثلاً 24 ساعة).

## تحسينات ووضع إنتاج

7. **رسائل خطأ واضحة (AppFailure → واجهة)**  
   - توحيد عرض الأخطاء (كود مسجد خاطئ، طلب تصحيح مرفوض، عدم إمكانية التسجيل خارج النافذة، إلخ).

8. **Pull-to-refresh**  
   - في قوائم: حضور اليوم، طلبات التصحيح، الملاحظات، المسابقات (مُطبّق جزئياً؛ استكمال حيث ناقص).

9. **Skeleton / تحميل أنيق**  
   - بدل spinner فقط في الشاشات الرئيسية وقوائم التصحيحات والملاحظات.

10. **FCM من الخادم (Edge Function أو Cron)**  
    - عند أحداث محددة (حضور، موافقة مسجد، طلب تصحيح، ملاحظة) → إرسال إشعار للمستخدمين المعنيين.

## مؤجّل أو لاحق

- **الإعلانات:** جدول + RLS جاهز؛ موديل + ريپو + شاشات (v2).  
- **مسجد أساسي + ثانوي (واجهة):** حدّ وواجهة ربط الطفل.  
- **الوضع المحلي (Offline) للمسجد:** تخزين ومزامنة.  
- **الجوائز والشارات (عرض لولي الأمر).**  
- **طلب تسجيل صلاة من ولي الأمر** (كطلب "إضافة حضور" منفصل أو كنوع من طلبات التصحيح).

---

# الجزء الثالث: خريطة الأدوار والترابط

```
سوبر أدمن ──► mosques (موافقة/رفض) ──► الإمام يرى لوحته
                    │
الإمام ──► مسجد، أكواد، مشرفون، مسابقات، إعلانات (مؤجل)، طلبات تصحيح، ملاحظات
    │         │
    │         ├──► المشرف: انضمام بدعوة، تحضير، طلاب، تصحيحات، ملاحظات، مسابقات (عرض)
    │         │
    │         └──► ولي الأمر: ربط طفل بكود المسجد
    │
    └──► الحضور (attendance) ←── يُسجّل من الإمام/المشرف
              │
              ├──► Trigger 020 يحدّث نقاط/سلاسل الطفل
              ├──► ولي الأمر يرى حضور اليوم (مع Realtime)
              └──► مسابقة نشطة: competition_id في attendance (022)

طلبات التصحيح: ولي الأمر يطلب (واجهة ناقصة) ──► الإمام/المشرف يراجع وينفّذ (واجهة جاهزة)
الملاحظات: المشرف/الإمام يرسل ──► ولي الأمر يقرأ (صندوق الملاحظات من الدراور)
المسابقات: الإمام ينشئ ويفعّل ──► المشرف يرى الترتيب ──► ولي الأمر (شاشة المسابقة النشطة ناقصة)
```

---

# الجزء الرابع: قرارات مصيرية ومخاطر (مرجع سريع)

- **توقيت prayer_date و"اليوم":** التوصية في foundation_first_plan: توقيت المسجد؛ mosques.timezone موجود في 022.  
- **أوقات الصلاة:** التوصية: إحداثيات المسجد (lat/lng) عند التحضير.  
- **السلسلة:** يوم واحد فيه أي حضور = يوم محسوب؛ الـ trigger 020 يحسب من prayer_date.  
- **تنفيذ التصحيح:** الموافقة عبر RPC approve_correction_request (إدراج حضور + تحديث الطلب)؛ الـ trigger يحدّث الطفل.  
- **منع تكرار طلبات التصحيح:** فحص في الريپو (حضور مسبق + طلب pending)؛ partial unique في 023 إن وُجد.  
- **إلغاء حضور:** حذف سجل + إعادة حساب (trigger على DELETE في 020)؛ صلاحيات محدودة.  
- **Realtime للتصحيحات/الملاحظات:** اختياري لتحسين التجربة؛ لا يمنع عمل التطبيق بدونه.

المخاطر التفصيلية والقرارات موثّقة في **foundation_first_plan.md** (القسم 0 و 7 و 8).

---

# الجزء الخامس: المراجع والربط

| الوثيقة | الاستخدام |
|---------|-----------|
| **foundation_first_plan.md** | البنية التحتية، نقد لاذع، قرارات مصيرية، تفصيل تنفيذي. |
| **plan_detailed_next.md** | خطة مراحل (Realtime، تصحيحات، ملاحظات، إشعارات، إلخ) — يُحدَّث مع الإنجاز. |
| **HOW_TO_TEST_EVERYTHING.md** | دليل اختبار يدوي (دورة الحضور، Realtime، المسابقات، التصحيحات، الملاحظات، المسارات). |
| **checklist_attendance_lifecycle.md** | خطوات التحقق من دورة الحضور كاملة. |
| **study_roles_integration.md** | دراسة تكامل الأدوار (إن وُجدت). |
| **app_flows_simple.md** | التدفقات المبسطة. |

---

*هذه الدراسة تجمع ما لدينا وما هو قادم في مكان واحد؛ يُحدَّث عند إنجاز بنود أو حسم قرارات.*
