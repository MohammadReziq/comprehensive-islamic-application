# ملاحظات تجربة المستخدم ومنطق الأدوار

## 0. مسار التطبيق وهرم الأدوار (للمشاركة والشرح)

**خياران عند إنشاء الحساب فقط:** ولي أمر، أو إمام. لا يظهر "مشرف" ولا "سوبر أدمن".

| المستوى | من هو؟ | كيف يدخل؟ | ماذا يفعل؟ |
|---------|--------|-----------|------------|
| **سوبر أدمن** | صاحب التطبيق | حساب خاص (خارج شاشة التسجيل العادية) | **يحدد القبول:** يوافق أو يرفض طلبات المساجد. الإمام ينشئ مسجد → بانتظار الموافقة → السوبر أدمن يقبل أو يرفض. |
| **إمام (مدير المسجد)** | من يدير المسجد | يختار "إمام / مشرف" عند التسجيل | ينشئ مسجد (أو ينضم بكود)، ينتظر موافقة السوبر أدمن، ثم **يحدد المشرفين:** يدعيهم بكود الدعوة. |
| **مشرف** | من يسجّل التحضير في المسجد | **لا يسجّل كـ "مشرف"** — الإمام يرسله كود دعوة، يفتح التطبيق وينضم بـ "انضمام لمسجد" ويدخل الكود فيصير مشرفاً على ذلك المسجد. | يسجّل حضور الطلاب (QR، رقم، اسم). |
| **ولي أمر** | من يتابع أطفاله | يختار "ولي أمر" عند التسجيل | يضيف أطفاله، يربطهم بمسجد، يتابع الحضور والنقاط والجوائز. |
| **طفل** | الابن/الابنة | لا حساب — له بطاقة أو رقم فقط | المشرف يمسح حضوره؛ ولي الأمر يتابع من تطبيقه. |

**خلاصة للمسار:**
- **التسجيل:** ولي أمر ← أو ← إمام. ما نظهر سوبر أدمن ولا مشرف.
- **السوبر أدمن:** يتحكم بالقبول (طلبات المساجد). خارج مسار التسجيل العادي.
- **المشرفون:** يحددهم الإمام (بدعوة بكود). ما في داعي نظهرهم في خيارات التسجيل — من يضيفهم هو الإمام.

---

## 1. التسجيل بـ Google

**السؤال:** ما بقدر حدا يعمل حساب جديد باستخدام قوقل مباشرة — هل هيك تجربة مستخدم جيدة؟

**الجواب:** **لا.** من الأفضل دعم تسجيل الدخول/التسجيل بـ Google لأن:
- كثير من المستخدمين يفضّلون "سجّل بدخول قوقل" بدل إدخال إيميل وكلمة سر.
- تقليل الاحتكاك يزيد إكمال التسجيل.

**ما تم:** كان يظهر خطأ "Database error" عند "saving new user" لأن الـ Trigger في Supabase كان يفشل. تم إنشاء migration `002_fix_google_signup_trigger.sql` لمعالجة ذلك (دعم Google + إيميل، UPSERT لتجنب تكرار السجل، تعيين search_path).

**المطلوب منك:**
1. Supabase Dashboard → SQL Editor → New query.
2. انسخ **كل** محتوى `supabase/migrations/002_fix_google_signup_trigger.sql` والصقه.
3. Run. يجب أن تظهر "Success".
4. جرّب إنشاء حساب من التطبيق (إيميل أو Google). إذا استمر الخطأ: Supabase → Logs → Postgres أو Auth وابحث عن الرسالة الفعلية للخطأ.

---

## 2. ولي أمر vs إمام — ومن يسجّل؟

**السؤال:** لو حدا قرر يتنبع بدون أبوه أو يكون تابع لحساب أبوه، هل نعبره ولي أمر؟ كيف الطريقة المنطقية؟

**المنطق الحالي في التطبيق:**

| الدور    | من هو؟ | ماذا يفعل؟ |
|----------|--------|------------|
| **ولي أمر** | من يتابع أطفاله (أب، أم، أو كلاهما) | يسجّل دخول، يضيف أطفاله، يتابع الحضور والنقاط والجوائز. |
| **إمام/مشرف** | من يدير التحضير في المسجد | يسجّل دخول، ينشئ/ينضم لمسجد، يسجّل حضور الطلاب (QR أو يدوي). |
| **الطفل** | الابن/الابنة في المسجد | **لا يملك حساباً في التطبيق.** له بطاقة QR أو رقم. المشرف يمسح الحضور. الأب يتابع من تطبيقه. |

**إجابة سؤالك:**
- **"حدا يتنبع بدون أبوه"** — إذا يقصد ابن كبير يريد يتابع نفسه: المنطق الحالي أن **الطفل لا يسجّل**. التصميم: ولي الأمر يضيف الابن كـ "طفل" ويرى حضوره. لو الابن الكبير يريد يفتح التطبيق بنفسه، خياران:
  1. **الوضع الحالي:** الأب يفتح حساب ولي أمر ويضيف ابنه. الابن لا يفتح التطبيق؛ الأب يتابع من جهازه. (منطقي للأطفال الصغار.)
  2. **مستقبلاً (ربط عائلة):** نضيف ميزة "ربط حساب الابن بولي الأمر" — الأب يربط رقم/جهاز ابنه بحيث الابن يفتح التطبيق ويرى **نفسه فقط** (أو مشاركة محدودة) وولي الأمر يتابع من حسابه. هذا يحل حالة "الابن يريد يتابع نفسه من تلفونه".
- **"يكون تابع لحساب أبوه"** — نعم، هذا بالضبط التصميم: التابع هو **الطفل** (ملف داخل حساب ولي الأمر)، وليس حساباً منفصلاً. لا نعبّر الابن كـ "ولي أمر" إلا إذا هو فعلاً أب ويريد يتابع أطفاله.

**خلاصة:** لا نجبر الابن يسجّل كـ "ولي أمر". إما لا حساب له (الأب يضيفه كطفل ويتابع)، أو لاحقاً نقدّم "ربط جهاز الابن بحساب ولي الأمر" بحيث الابن يفتح التطبيق ويرى بياناته فقط.

---

## 3. ربط ولي الأمر بتلفون ابنه — كيف نكلم التطبيق؟

**السؤال:** هل ممكن نجبره يسجّل بولي أمر؟ أو ولي الأمر ينربط مع تلفون ابنه على نفس الحساب؟ كيف تنصح حتى نكلم التطبيق؟

**التوصية للشرح والمنتج:**

1. **نكلم التطبيق هكذا:**
   - "التطبيق لاثنين: **ولي الأمر** (أب/أم) و **المسجد/المشرف**. الطفل **ما بيسجّل** — له بطاقة أو رقم، والمشرف يمسح حضوره، وولي الأمر يتابع من تطبيقه."
   - "لو ابنك عنده جوال ويريد يشوف حضوره: حالياً تتابعوه من حسابكم. لاحقاً يمكن نضيف أن يربط ابنه جهازه بحسابكم فيشوف نفسه من تطبيقكم."

2. **ما نعمل:**
   - لا نجبر الابن يسجّل كـ "ولي أمر" — هذا يربك الأدوار (ولي أمر = من يتابع أطفال، مو الطفل نفسه).

3. **ما يمكن نضيفه لاحقاً (ربط العائلة):**
   - ولي الأمر يضيف ابنه كـ "طفل" كالعادة.
   - خيار: "ربط جهاز الابن" — نعطي كود أو رابط الابن يدخله من جواله، فيربط جهازه بحساب ولي الأمر (قراءة فقط لبيانات هذا الطفل). عندها الابن يفتح التطبيق ويرى حضوره ونقاطه فقط، والأب يبقى يرى كل شيء من حسابه.

بهذا يكون الشرح واضح ومنطقي، وتجربة المستخدم لا تُجبر أحداً على دور غلط.
