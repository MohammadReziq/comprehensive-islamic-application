# تدفق محسّن خطوة بخطوة — تسجيل الدخول والتسجيل

> اقتراح عملي يقلل الخطوات ويؤخر اختيار الدور لما بعد الدخول، مع إبقاء الخيارين (قوقل / بريد) والتحقق من البريد.

---

## الهدف

- دخول أسرع وأخف (أقل قرارات قبل الدخول).
- اختيار الدور **بعد** الدخول في خطوة واحدة مع صور توضيحية.
- خياران واضحان: قوقل / بريد، مع التحقق من البريد عند التسجيل الجديد.

---

## التدفق المقترح خطوة بخطوة

### المرحلة 0: البداية (Splash / Onboarding)

| الخطوة | ماذا يرى المستخدم |
|--------|-------------------|
| 0.1 | Splash ثم (إن أول مرة) 1–2 شاشات Onboarding قصيرة: "تابع صلاة أبنائك" + زر "ابدأ". |
| 0.2 | زر "ابدأ" يوصله لـ **شاشة الدخول الموحدة**. |

*(اختياري لاحقاً: زر "اكتشف التطبيق" يفتح شاشة معاينة ثابتة ثم "إنشاء حساب / تسجيل الدخول".)*

---

### المرحلة 1: شاشة الدخول الموحدة (بدون Login/Register منفصلتين)

**شاشة واحدة** عنوانها مثلاً: **"تسجيل الدخول أو إنشاء حساب"**.

| # | العنصر | الوظيفة |
|---|--------|---------|
| 1.1 | **زر كبير:** "متابعة بـ Google" | ضغطة واحدة → إن كان حساب موجود يدخل، وإن أول مرة يُنشأ حساب ويدخل (بدون سؤال عن الدور هنا). |
| 1.2 | **فاصل:** "أو" |
| 1.3 | **حقل واحد:** "البريد الإلكتروني" + زر "متابعة" | المستخدم يدخل بريده فقط ويضغط "متابعة". |
| 1.4 | **تحت الحقل:** "لديك حساب؟ سجّل دخولك" أو "نسيت كلمة المرور؟" (نص صغير حسب الحاجة). |

**منطق "متابعة" بالبريد:**

- نرسل البريد لـ Backend (أو نستدعي دالة تتحقق من وجود المستخدم **بدون كشف** إن كان الحساب موجوداً أم لا، لأمان أفضل).
- **إن وُجد حساب بهذا البريد:** ننتقل لشاشة **"أدخل كلمة المرور"** (نفس الشاشة أو شاشة بسيطة) ثم دخول.
- **إن لم يُوجد:** ننتقل لشاشة **"إنشاء حساب"**:
  - الاسم + كلمة المرور + تأكيد كلمة المرور (الإيميل معروف من الخطوة السابقة).
  - زر "إنشاء حساب" → إرسال رمز التحقق إلى البريد → شاشة "أدخل الرمز" → بعد التحقق نجح → دخول.

*(بديل أبسط: الإبقاء على زرين منفصلين "تسجيل الدخول" و "إنشاء حساب" تحت حقل البريد، والمستخدم يختار؛ النظام يتحقق من البريد عند الإرسال ويوجّه حسب الحالة. هذا يقلل الحاجة لـ API "اكتشاف" ويبقى التدفق واضحاً.)*

---

### المرحلة 2: بعد أول دخول ناجح — خطوة الدور (Onboarding مرة واحدة)

| # | الشرط | ماذا يحدث |
|----|--------|------------|
| 2.1 | المستخدم دخل (قوقل أو بريد) **ولم يُحدد دوره بعد** (أو دوره = "غير محدد" / افتراضي). | نعرض **شاشة واحدة**: "اختر دورك". |
| 2.2 | محتوى الشاشة | عنوان + صورتان (أو بطاقتان) توضيحيتان: **ولي أمر** (أتابع صلاة أبنائي) و **إمام** (أدير مسجدي والمشرفين). |
| 2.3 | عند الاختيار | نحفظ الدور في الـ Backend (تحديث `users.role`) ثم ننتقل للوحة الرئيسية المناسبة (ولي أمر → Home، إمام → Mosque/Admin). |
| 2.4 | من سجّل من قبل ودوره مضبوط | لا نعرض شاشة الدور؛ نوجّهه مباشرة حسب دوره. |

بهذا **اختيار الدور يكون بعد الدخول**، في خطوة واحدة، مع صور توضيحية، دون شاشات إضافية معقدة.

---

### المرحلة 3: التحقق من البريد (للتسجيل الجديد بالبريد فقط)

| # | الخطوة |
|----|--------|
| 3.1 | بعد "إنشاء حساب" (اسم + إيميل + كلمة مرور) نرسل **رسالة تحقق** (رمز لمرة واحدة). |
| 3.2 | شاشة "أدخل الرمز المرسل إلى بريدك" + إعادة إرسال بعد مدة. |
| 3.3 | بعد إدخال الرمز الصحيح → تفعيل الحساب → نعتبره "دخل" ونطبّق **المرحلة 2** (اختيار الدور إن لم يكن مضبوطاً). |
| 3.4 | إن لم تصل الرسالة → نعرض توجيهاً: "تحقق من البريد غير المرغوب" / "استخدم بريداً حقيقياً". |

---

### المرحلة 4: المرات التالية (مستخدم مسجّل)

| # | السيناريو |
|----|-----------|
| 4.1 | الدخول بـ Google أو بالبريد + كلمة المرور كما في **المرحلة 1**. |
| 4.2 | التوجيه مباشرة حسب الدور (بدون شاشة اختيار دور مرة ثانية). |

---

## ملخص الخطوات من منظور المستخدم

1. **يفتح التطبيق** → Splash / Onboarding قصير → **شاشة واحدة للدخول.**
2. **يختار:** "متابعة بـ Google" **أو** يدخل بريده ثم "متابعة".
3. **إن بالبريد:**
   - إن كان له حساب → يدخل كلمة المرور → دخول.
   - إن لا → يكمّل الاسم وكلمة المرور → نرسل رمز التحقق → يدخل الرمز → تفعيل → دخول.
4. **بعد أول دخول (قوقل أو بريد):** إن دوره غير محدد → **شاشة واحدة "اختر دورك"** (ولي أمر / إمام) مع صور → نحفظ الدور → نوجّهه للوحة المناسبة.
5. **المرات التالية:** نفس شاشة الدخول ثم توجيه مباشر حسب الدور.

---

## ما يلزم في الكود (بدون تفاصيل تنفيذ)

- **شاشة دخول موحدة:** خيار "متابعة بـ Google" + حقل بريد + زر "متابعة" مع توجيه إما لـ "كلمة المرور" أو "إنشاء حساب" حسب وجود الحساب (مع مراعاة الأمان عند التحقق).
- **شاشة "اختر دورك":** تظهر بعد أول دخول عندما `role` غير مضبوط؛ تحتوي على خيارين (ولي أمر / إمام) مع صور أو أيقونات؛ عند الاختيار استدعاء تحديث الدور ثم الانتقال للوحة المناسبة.
- **منطق التوجيه:** بعد أي تسجيل دخول ناجح، إذا كان المستخدم "جديد" أو بدون دور → عرض شاشة الدور مرة واحدة فقط؛ وإلا توجيه فوري حسب الـ role.

---

## الخلاصة

- **شاشة دخول واحدة** (قوقل أو بريد) بدل فصل Login/Register في خطوتين منفصلتين من البداية.
- **اختيار الدور بعد الدخول** في خطوة واحدة مع صور توضيحية، دون إرباك المستخدم قبل أن يدخل.
- **التحقق من البريد** يبقى للتسجيل الجديد بالبريد فقط؛ مرونة الدخول (قوقل أو بريد) بعد التفعيل كما هي.

إذا رغبت، يمكن تفصيل أي مرحلة (مثلاً واجهات الشاشات أو سلوك الـ API) في ملف منفصل أو في نفس الملف كإضافة لاحقة.
