# صلاحيات المشرف والحضور

## المشكلة التي كانت موجودة

- **السلوك:** الإمام يسجّل حضور الطالب على الصلاة، والمشرف "ما ببين عنده" أن هذا الطالب مسؤول عنه أو أن الحضور مُسجّل.
- **السبب:** سياسات RLS على جدول `attendance` كانت تسمح بقراءة السجل فقط لـ:
  1. ولي أمر الطفل (لأطفاله)
  2. من سجّل الحضور (`recorded_by_id` = المستخدم الحالي)

بما أن الإمام هو من سجّل الحضور، كان `recorded_by_id` = الإمام، فالمشرف لا يطابق أي شرط ولا يرى الصف.

## الحل (تم تطبيقه في الكود)

- **Migration:** `supabase/migrations/018_attendance_mosque_members_read.sql`
- **الفكرة:** السماح لأي مستخدم موجود في `mosque_members` لمسجد معيّن بقراءة **كل** سجلات الحضور لهذا المسجد (`attendance.mosque_id`).
- **النتيجة:** المشرف والإمام (كلاهما في `mosque_members` لذلك المسجد) يرون كل الحضور المسجّل لمسجدهم، سواء سجّله الإمام أو المشرف.

## ما يجب فعله بعد التعديل

1. تطبيق الـ migration على قاعدة Supabase:
   - من Supabase Dashboard → SQL Editor → لصق محتوى `018_attendance_mosque_members_read.sql` وتشغيله،  
   **أو**
   - من الطرفية: `supabase db push` (إن كنت تستخدم Supabase CLI مرتبط بالمشروع).
2. إعادة اختبار دورة الحضور:
   - إمام يسجّل حضور طالب → دخول المشرف → التأكد أن المشرف يرى هذا الحضور في قائمة الطلاب/الحضور.

## مرجع سريع لصلاحيات الحضور بعد 018

| من؟        | قراءة الحضور |
|------------|----------------|
| ولي الأمر | حضور أطفاله فقط |
| من سجّل الحضور | السجلات التي سجّلها هو |
| عضو المسجد (إمام أو مشرف) | كل حضور ذلك المسجد |

بهذا يكون المشرف "بيبين له" أن الطالب مسؤول عنه وأن الحضور (سواء سجّله هو أو الإمام) ظاهر عنده.
