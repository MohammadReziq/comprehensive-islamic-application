# الخطة القادمة — ربط الأدوار والمسارات

## 1. ترتيب الأدوار (الإمام أعلى من المشرف)

### في قاعدة البيانات
- **جدول `users`:** الدور العام للحساب = `super_admin` | `parent` | `imam`.
- **جدول `mosque_members`:** دورك **داخل المسجد** = `owner` (مدير المسجد) | `supervisor` (مشرف).

الربط:
- من يسجّل كـ **إمام** وينشئ مسجد = يُسجّل في `mosque_members` بدور **owner** → هو **أعلى رتبة** في ذلك المسجد.
- من ينضم **بكود الدعوة** = يُسجّل في `mosque_members` بدور **supervisor** → تحت إشراف مدير المسجد (الإمام).

لا يوجد دور "مشرف" في جدول `users` — المشرف هو **parent** (أو أي مستخدم) صار له سجل في `mosque_members` بدور `supervisor`. الفرق الوحيد: **owner** = إمام/مدير المسجد، **supervisor** = مشرف عادي في المسجد.

### في التطبيق
- تم توضيح النص: **"إمام (مدير المسجد)"** بدل "إمام / مشرف" حتى لا يختلط مع المشرف العادي.
- **MosqueRole** كان واضحاً: `owner` = مدير المسجد، `supervisor` = مشرف. لا تغيير في الداتابيس مطلوب لهذا الترتيب.

---

## 2. ما هو مربوط حالياً (يعمل)

| المسار | الحالة |
|--------|--------|
| سوبر أدمن ← طلبات المساجد ← موافقة/رفض | ✅ |
| إمام ← إنشاء مسجد ← بانتظار الموافقة ← بعد القبول لوحة المشرف | ✅ |
| إمام/مشرف ← لوحة المشرف (تحضير، طلاب، تصحيحات، ملاحظات) | ✅ |
| إمام/مشرف ← التحضير (QR، رقم، قائمة) وتسجيل الحضور | ✅ |
| ولي الأمر ← أطفالي، إضافة طفل، بطاقة QR، ربط الطفل بمسجد (كود) | ✅ |
| ولي الأمر ← يشوف حضور/معلومات أطفاله | ⚠️ جزئي (الشاشات موجودة، الربط بالحضور الفعلي حسب ما يُسجّل) |

---

## 3. الخطة القادمة — ربط أفضل بالترتيب

### المرحلة أ — تأكيد الربط الحالي وتجربة كاملة
1. **تجربة دورة كاملة مرة واحدة:**
   - سوبر أدمن يوافق على مسجد إمام.
   - إمام يدخل → لوحة المشرف → يشارك كود الدعوة (من المسجد المعتمد).
   - مستخدم ثانٍ ينضم بكود الدعوة → يصير مشرفاً على نفس المسجد.
   - ولي أمر يضيف طفلاً ويربطه ب**كود المسجد** (كود المسجد العام، ليس كود الدعوة).
   - إمام أو مشرف يسجّل حضور ذلك الطفل من شاشة التحضير.
   - ولي الأمر يفتح "حضور اليوم" أو تفاصيل الطفل ويتأكد أن الحضور يظهر.
2. **إن وُجد ثغرة (مثلاً ولي الأمر لا يرى الحضور):** إصلاح الربط بين جدول الحضور وشاشة ولي الأمر (استعلامات + RLS إن لزم).

### المرحلة ب — تحسينات قصيرة
3. **عرض كود الدعوة وكود المسجد بوضوح للإمام:**  
   شاشة أو قسم في لوحة المشرف: "كود المسجد" (لربط الأطفال) و"كود الدعوة" (لدعوة المشرفين) مع زر نسخ/مشاركة.
4. **تفريق الإمام عن المشرف في الواجهة (اختياري):**  
   في لوحة المشرف، إذا كان المستخدم **owner** يظهر له قسم "المشرفون" أو "كود الدعوة"؛ إذا كان **supervisor** فقط لا يظهر له إدارة المشرفين (حتى لو الشاشة موحّدة حالياً).

### المرحلة ج — ميزات لاحقة (حسب الأولوية)
5. **طلبات التصحيح (Corrections):** ولي الأمر يرفع طلب تصحيح ← إمام/مشرف يراجعه (الجدول والـ RLS موجودان، يبقى الشاشات والربط).
6. **الملاحظات (Notes):** مشرف/إمام يرسل ملاحظة لولي الأمر عن الطفل (الجدول موجود، يبقى الواجهة والربط).
7. **إدارة المشرفين (للمدير فقط):** قائمة مشرفي المسجد، إزالة مشرف (حذف من `mosque_members`).
8. **Offline / مزامنة:** حفظ محلي للحضور وإعادة مزامنة عند الاتصال.

---

## 4. ملخص الترتيب والربط

- **الداتابيس:** لا حاجة لتعديل ترتيب الأدوار — **owner** أعلى من **supervisor** داخل المسجد، و**imam** في `users` = من يملك مسجداً (كـ owner). التعديل كان في **العرض فقط** (إمام = مدير المسجد).
- **الخطوة العملية التالية:** تشغيل **دورة كاملة** (موافقة → دعوة مشرف → ربط طفل → تحضير → ظهور الحضور لولي الأمر)، ومعالجة أي نقطة ربط ناقصة.
- بعدها: تحسين عرض الأكواد، ثم Corrections و Notes ثم إدارة المشرفين ثم Offline حسب الأولوية.

إذا حاب نبدأ بخطوة محددة (مثلاً "حضور اليوم لولي الأمر" أو "عرض كود الدعوة للإمام") حددها ونبني عليها الخطوة التالية في الكود.

**مرجع أوسع:** الدراسة الشاملة (التحديثات المباشرة Realtime، ما هو قادم صغيراً وكبيراً، وتطوير الوثيقة) في `docs/study_roles_integration.md`.
