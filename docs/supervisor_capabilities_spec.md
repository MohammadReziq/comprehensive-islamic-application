# كل ما يستطيع المشرف فعله — مواصفات حرفية لبناء صفحات المشرف

هذه الوثيقة تذكر **حرفياً** كل شيء يستطيع المشرف (المستخدم الذي له دور `supervisor` ويكون **عضوًا في مسجد** بدور `supervisor` في `mosque_members` وليس `owner`) أن يفعله في النظام، وما **لا** يستطيع فعله مقارنة بالإمام.

---

## 1. التوجيه والمسارات (Routes)

- بعد تسجيل الدخول: إذا كان `users.role = supervisor` يُوجّه إلى `/mosque`.
- في **بوابة المسجد** (`/mosque`): إذا كان المستخدم **مالك** مسجد معتمد → `/imam/dashboard`؛ وإلا → `/supervisor/dashboard`.
- المشرف يمكنه الانضمام لمسجد عبر كود الدعوة (إن لم يكن لديه مسجد معتمد يُوجّه للوحة المشرف ويُعرض له "انضم لمسجد").

### مسارات المشرف

| المسار | الاسم | الشاشة/الاستخدام |
|--------|--------|-------------------|
| `/mosque` | mosque | بوابة المسجد (انضمام بكوْد الدعوة) |
| `/mosque/join` | mosqueJoin | الانضمام بكوْد الدعوة |
| `/supervisor/dashboard` | supervisorDashboard | **لوحة المشرف** — الصفحة الرئيسية |
| `/supervisor/scan` | supervisorScan | التحضير — مسح QR / تسجيل الحضور |
| `/supervisor/students` | supervisorStudents | قائمة طلاب المسجد |
| `/supervisor/child/:id` | supervisorChildProfile | ملف طفل في المسجد |
| `/supervisor/corrections/:mosqueId` | supervisorCorrections | طلبات التصحيح (عرض، قبول، رفض) |
| `/supervisor/notes/send/:mosqueId` | supervisorNotesSend | إرسال ملاحظة لطلاب المسجد |
| `/supervisor/notes` | supervisorNotes | **حاليًا placeholder** — المقصود: قائمة الملاحظات المرسلة |
| `/supervisor/competitions/:mosqueId` | supervisorCompetitions | المسابقات (عرض فقط + ترتيب؛ لا إنشاء/تفعيل/إيقاف) |

---

## 2. لوحة المشرف (`/supervisor/dashboard`) — المحتوى والإجراءات

- **مصدر البيانات:** المسجد المعتمد الأول من `MosqueBloc` (مساجدي التي `status = approved`). إذا لا يوجد مسجد معتمد → عرض "انضم لمسجد".
- **ما يُعرض:**
  - بطاقة المسجد: الاسم، **كود المسجد** (لربط الأطفال — ولي الأمر يرى هذا الكود؛ المشرف لا يدير طلبات الانضمام ولا كود الدعوة).
  - الصلاة القادمة (من `PrayerTimesService`).
  - إحصائيات اليوم: حضور اليوم، عدد الطلاب (من `SupervisorRepository.getTodayAttendanceCount` وعدد الطلاب من قائمة المسجد).
  - أزرار إجراءات: التحضير، الطلاب، طلبات التصحيح، الملاحظات، المسابقات.
- **ما لا يُعرض للمشرف (مقارنة بالإمام):**
  - لا طلبات انضمام (موافقة/رفض).
  - لا قائمة المشرفين ولا إزالة مشرف.
  - لا إعدادات المسجد، لا نقاط الصلوات، لا تقرير حضور، لا أداء المشرفين.

- **القائمة الجانبية (Drawer):** لوحة المشرف، التحضير، الطلاب، طلبات التصحيح، الملاحظات، المسابقات، انضم لمسجد، تسجيل الخروج.
- **الشريط السفلي:** لوحة المشرف، الملف الشخصي.

---

## 3. المستودعات والعمليات — ما يستخدمه المشرف

### 3.1 المسجد (MosqueRepository) — قراءة فقط للمشرف

| العملية | المشرف |
|---------|--------|
| `getMyMosques()` | نعم — لمعرفة مسجده المعتمد. |
| إنشاء مسجد / موافقة طلبات انضمام / رفض / إزالة مشرف / تحديث إعدادات | **لا** — للإمام فقط. |

### 3.2 المشرف (SupervisorRepository)

| العملية | الوصف |
|---------|--------|
| `getMosqueStudents(mosqueId)` | طلاب المسجد (mosque_children + children، النشطون). |
| `getTodayAttendanceCount(mosqueId)` | عدد سجلات الحضور اليوم. |
| `recordAttendance(mosqueId, childId, prayer, date)` | تسجيل حضور طفل (مع نافذة زمنية ونقاط الصلوات من المسجد). |
| `getRecordedChildIdsForPrayer(...)` | من سجّل حضورهم لصلاة/تاريخ (لتجنب التكرار). |
| `findChildByQrCode(qrCode, mosqueId)` | البحث عن طفل بـ QR. |
| `findChildByLocalNumber(localNumber, mosqueId)` | طفل برقمه المحلي. |
| `findChildByName(name, mosqueId)` | البحث بالاسم. |
| `getChildById(childId)` | بيانات طفل (RLS: أطفال مسجدك فقط). |
| `cancelAttendance(attendanceId)` | **المشرف يلغي فقط ما سجّله بنفسه خلال 24 ساعة** (الـ RPC تتحقق من ذلك). |
| `getDailyStats(mosqueId, date?)` | إحصائيات يومية (حضور لكل صلاة، إجمالي الطلاب). |

### 3.3 طلبات التصحيح (CorrectionRepository)

| العملية | المشرف |
|---------|--------|
| `getPendingForMosque(mosqueId)` | نعم. |
| `approveRequest(requestId)` | **نعم** — RPC `approve_correction_request` تتحقق فقط من أن المستدعي **عضو في المسجد** (إمام أو مشرف). |
| `rejectRequest(requestId, reason?)` | نعم (تحديث الحالة و reviewed_by). |

### 3.4 المسابقات (CompetitionRepository)

| العملية | المشرف |
|---------|--------|
| `getActive(mosqueId)` | نعم. |
| `getAllForMosque(mosqueId)` | نعم. |
| `getLeaderboard(competitionId)` | نعم. |
| `create(...)` / `activate(...)` / `deactivate(...)` | **لا** — الـ repo يتحقق `_requireOwnerRole`؛ RLS تسمح للـ owner فقط بالـ INSERT/UPDATE. |

### 3.5 الملاحظات (NotesRepository)

| العملية | المشرف |
|---------|--------|
| `sendNote(childId, mosqueId, message)` | نعم. |
| `getMySentNotes()` | نعم — للمشرف لعرض "الملاحظات التي أرسلتها". |

---

## 4. الشاشات الحالية للمشرف

| الشاشة | الملف | الحالة |
|--------|--------|--------|
| لوحة المشرف | `supervisor_dashboard_screen.dart` | ✅ كاملة |
| التحضير (مسح QR) | `scanner_screen.dart` + `ScannerBloc` | ✅ |
| قائمة الطلاب | `students_screen.dart` | ✅ |
| ملف طفل | `child_profile_screen.dart` | ✅ |
| طلبات التصحيح | `CorrectionsListScreen` (مشتركة) | ✅ — نفس الشاشة مع mosqueId |
| إرسال ملاحظة | `SendNoteScreen` (مشتركة) | ✅ |
| قائمة الملاحظات المرسلة | `/supervisor/notes` | ⚠️ **Placeholder** — `SupervisorPlaceholderScreen(title: 'الملاحظات')` |
| المسابقات | `ManageCompetitionScreen` (مشتركة) | ⚠️ واجهة تعرض أزرار إنشاء/تفعيل/إيقاف — عند المشرف ستُرمى خطأ صلاحية عند الضغط؛ يفضّل شاشة "عرض فقط" أو إخفاء الأزرار للمشرف. |

---

## 5. صلاحيات قاعدة البيانات (RLS) — ملخص المشرف

- **mosques:** قراءة مساجد أنا عضو فيها.
- **mosque_members:** قراءة أعضاء مساجدي (لا إدراج/حذف للمشرف).
- **mosque_join_requests:** لا صلاحية للمشرف (الإمام فقط).
- **attendance:** إدراج (تسجيل الحضور)؛ إلغاء عبر RPC `cancel_attendance` — **المشرف يلغي فقط سجلاته خلال 24 ساعة**.
- **correction_requests:** SELECT و UPDATE (مراجعة) لطلبات مسجده؛ RPC `approve_correction_request` تسمح لأي عضو في المسجد (إمام أو مشرف).
- **competitions:** SELECT فقط (أعضاء المسجد يقرأون).
- **notes:** إدراج ملاحظة (مرسل = أنا).
- **announcements:** لا إنشاء للمشرف (السياسة "supervisor creates" أُسقِطت في migration 026).

---

## 6. قائمة إجراءات واحدة — ما يفعله المشرف حرفياً

1. الانضمام لمسجد عبر كود الدعوة.
2. عرض مسجده المعتمد وكود المسجد (للمرجع؛ لا يدير طلبات الانضمام).
3. عرض الصلاة القادمة وإحصائيات اليوم (حضور اليوم، عدد الطلاب).
4. فتح التحضير: مسح QR أو إدخال رقم الطالب وتسجيل الحضور.
5. عرض قائمة طلاب المسجد وملف كل طفل.
6. عرض طلبات التصحيح للمسجد والموافقة عليها (RPC) أو رفضها.
7. إرسال ملاحظة لولي أمر طفل في المسجد.
8. **(ناقص حاليًا)** عرض قائمة "الملاحظات التي أرسلتها" (ال route موجودة لكن الشاشة placeholder).
9. عرض قائمة المسابقات وترتيب المسابقة النشطة — **بدون** إنشاء أو تفعيل أو إيقاف (يُفضّل إخفاء هذه الأزرار في واجهة المشرف أو شاشة عرض فقط).
10. إلغاء حضور **فقط ما سجّله بنفسه** خلال 24 ساعة (من شاشة التحضير أو ملف الطفل حسب التصميم).

---

## 7. ما لا يفعله المشرف (مقارنة بالإمام)

- لا إنشاء مسجد ولا موافقة/رفض طلبات انضمام ولا إزالة مشرف.
- لا تحديث إعدادات المسجد ولا نقاط الصلوات.
- لا تقرير حضور ولا تقرير أداء المشرفين.
- لا إنشاء/تفعيل/إيقاف مسابقات.
- لا إلغاء حضور سجّله غيره أو قديم أكثر من 24 ساعة.
- لا إنشاء إعلانات (حسب الـ RLS الحالية).

---

## 8. ملاحظات للبناء وإعادة الاستخدام من صفحات الإمام

- **مصدر "مسجد المشرف":** نفس `MosqueBloc` — أول مسجد معتمد من `getMyMosques()`.
- **لا يوجد SupervisorBloc:** لوحة المشرف تعتمد `MosqueBloc` و `SupervisorRepository` مباشرة؛ لا حاجة لبلوك مشرف إلا إذا أردت تعقيدًا إضافيًا (مثلاً تخزين إحصائيات في state مركزي).
- **ما يمكن نسخه من الإمام:** بطاقة المسجد (بدون كود الدعوة وطلبات الانضمام)، بطاقة الصلاة القادمة، أزرار الإجراءات، تخطيط الشبكة إن رغبت؛ شاشة طلبات التصحيح مشتركة؛ إرسال الملاحظة مشترك.
- **ما يجب أن يكون مختلفًا للمشرف:** لوحة بدون طلبات انضمام/مشرفين/إعدادات/تقرير حضور/أداء مشرفين؛ شاشة المسابقات للمشرف = عرض فقط (أو إخفاء أزرار إنشاء/تفعيل/إيقاف)؛ شاشة الملاحظات = "ملاحظاتي المرسلة" بدل placeholder.

---

## 9. التحضير (Scan) — كيف يعمل المسح للإمام والمشرف

- **المسار:** كل من الإمام والمشرف يفتحان نفس الشاشة عبر `/supervisor/scan` (من لوحة الإمام أو لوحة المشرف → زر "التحضير").
- **الشاشة:** `ScannerScreen` — ثلاث طرق لتسجيل الحضور:
  1. **تبويب QR:** الكاميرا مفتوحة؛ توجيه الكاميرا على **QR code** الخاص بالطفل.
  2. **تبويب رقم:** إدخال الرقم المحلي للطالب في المسجد ثم "تسجيل الحضور".
  3. **تبويب قائمة:** البحث بالاسم والضغط على "حاضر" بجانب الطالب.

- **كيف يعمل المسح بالكاميرا على الـ QR:**
  - كل طفل له في قاعدة البيانات حقل `qr_code` (قيمة فريدة، غالباً UUID).
  - ولي الأمر يعرض/يطبع **بطاقة الطفل** من شاشة البطاقة (`ChildCardScreen`) التي تعرض **QR مصنوع من نفس القيمة** (`QrDisplay(data: child.qrCode)`).
  - عند المسح: التطبيق يقرأ النص المخزّن داخل الـ QR (نفس قيمة `qr_code`)، يبحث عن الطالب في **طلاب مسجدك** الذي يطابق هذا الـ `qr_code`، ثم يسجّل الحضور تلقائياً للصلاة المختارة (الصلاة القادمة).
  - **لا يحتاج المستخدم يضغط زر بعد المسح** — بمجرد قراءة الـ QR يتم التسجيل إن وُجد الطالب في المسجد.

- **ملاحظة:** إن لم يظهر للطفل QR في التطبيق، ولي الأمر يمكنه فتح "بطاقة الطفل" (إن وُجدت في القائمة أو من ملف الطفل) لعرض الـ QR وطباعته أو تصويره من شاشة ثانية ومسحه من جهاز التحضير.

بهذا يكون كل ما يستطيع المشرف فعله موثّقاً لاستخدامه عند بناء أو تحسين صفحات المشرف.
