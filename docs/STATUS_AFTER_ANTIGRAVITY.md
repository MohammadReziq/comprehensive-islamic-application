# وضع المشروع بعد انتهاء تجربة antigravity

تقرير سريع: أين وصلت الخطة، ما الذي لم يُكمّل، وهل تنفيذ 026 في SQL Editor آمن.

---

## 1. الموجة 1 — إصلاحات حرجة ✅ مكتملة تقريباً

| البند | الحالة | ملاحظة |
|-------|--------|--------|
| **1.1 AttendanceValidationService** | ✅ مكتمل | الملف موجود، مدمج في `SupervisorRepository.recordAttendance`، يستخدم lat/lng ونافذة المسجد من DB |
| **1.2 فصل صلاحيات المسابقة** | ✅ مكتمل | `CompetitionRepository` يتحقق من دور owner قبل create/activate/deactivate |
| **1.3 إلغاء حضور خاطئ** | ✅ مكتمل | Migration 024 (مع DROP)، `SupervisorRepository.cancelAttendance`، `ImamRepository.cancelAttendance`، استخدام من الإمام |
| **1.4 أوقات صلاة حسب المسجد** | ✅ مكتمل | Migration 025 (`attendance_window_minutes`)، `MosqueModel` يحمل lat/lng وattendanceWindowMinutes، التحقق يستخدم إحداثيات المسجد من DB |

---

## 2. الموجة 2 — أدوار ناقصة (جزئي)

| البند | الحالة | ملاحظة |
|-------|--------|--------|
| **2.1 طلب تصحيح لولي الأمر** | ⚠️ جزئي | الـ BLoC والريپو جاهزان (`CreateCorrectionRequest`). **الناقص:** مسار `/parent/children/:id/request-correction` وشاشة إنشاء الطلب وزر من بطاقة الطفل |
| **2.2 ImamRepository + ImamBloc** | ✅ مكتمل | موجودان ومستخدمان |
| **2.3 AdminRepository + AdminBloc** | ✅ مكتمل | موجودان |
| **2.4 الإعلانات** | ⚠️ جزئي | AnnouncementRepository + Bloc موجودان. **026:** تم تصحيح الـ migration ليتوافق مع الجدول الحالي (sender_id). تنفيذ 026 في SQL Editor يكمّل الـ RLS والأعمدة |

---

## 3. ما لم يُكمّل (يمكنك إكماله لاحقاً)

- **شاشة طلب التصحيح لولي الأمر:** مسار + شاشة (اختيار صلاة، تاريخ، ملاحظة) + زر من بطاقة الطفل أو قائمة أطفالي.
- **شاشة المسابقة النشطة لولي الأمر** (عرض ترتيب أطفاله).
- **عرض الابن للباركود / ربط جهاز الابن** (كود ربط + شاشة عرض الابن).
- **واجهة موقع المسجد للإمام** (إعدادات المسجد: lat/lng أو «موقعي الحالي»).
- Realtime للتصحيحات والملاحظات، تحسينات أخرى (رسائل خطأ موحدة، pull-to-refresh، إلخ).

---

## 4. تنفيذ 026 في SQL Editor — هل هو آمن؟

**نعم.** ملف `026_announcements.sql` الحالي في المشروع هو **النسخة المُصحّحة** (تعتمد على عمود `sender_id` الموجود من 001، وليس `created_by`). عندما:

1. **تنسخ محتوى الملف كاملاً (1–72)** وتلصقه في Supabase → SQL Editor وتشغّله:
   - يضيف الأعمدة `is_pinned` و`updated_at` إن لم تكونا موجودتين.
   - ينشئ الـ index إن لم يكن موجوداً.
   - يسقط السياسات القديمة للإعلانات وينشئ السياسات الجديدة (قراءة أعضاء المسجد + أولياء الأمور، إنشاء للإمام فقط، تعديل/حذف للمنشئ فقط).
   - يضيف الجدول لـ Realtime إن لم يكن مضافاً.

2. **لا يوجد تعارض مع «ما كتبه antigravity»:** التعديل الذي قمنا به هو على **نفس الملف 026** في الريبو. أنت لا تستبدل كود antigravity بكود آخر — الملف في المشروع هو النسخة المُصحّحة، وتشغيلها في SQL Editor يطبّق هذه التصحيحات على قاعدة البيانات فقط.

3. **إن كان التشغيل السابق لـ 026 فشل** عند سياسة `created_by`: فالجدول والسياسات القديمة ما زالت كما هي. تشغيل 026 الحالية يصلح السياسات فقط.

4. **إن لم تشغّل 026 من قبل:** تشغيلها الآن يضيف الأعمدة والسياسات وRealtime بشكل صحيح.

---

## 5. نسخ احتياطي (البقّاقات) الموصى بها

1. **الكود:**  
   `git add -A && git commit -m "..." && git push`  
   حتى يكون الريبو (بما فيه 026 المُصحّح) نسخة احتياطية.

2. **قاعدة البيانات:**  
   - Supabase Dashboard → **Project Settings** → **Database** → **Database Backups** (إن متوفر في خطتك).  
   - أو **SQL Editor** → تصدير schema إن أردت (مثلاً من أدوات خارجية أو من Supabase إن وُجد خيار export).

3. **قبل تشغيل 026 في SQL Editor:**  
   اعمل commit للكود الحالي (يشمل 026) ثم شغّل 026. لو حصل أي خطأ غير متوقع، الريبو فيه النسخة الصحيحة من الـ migration ويمكنك إعادة التشغيل بعد مراجعة الخطأ.

---

*آخر تحديث: بعد انتهاء تجربة antigravity — الوضع مأخوذ من فحص الريبو الحالي.*
