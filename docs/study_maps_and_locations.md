# دراسة شاملة: الخرائط ومواقع المساجد — صلاتي حياتي

> **الهدف:** توضيح تأثير إضافة الخرائط على التطبيق، من يرى ماذا، وأي أعمال تأسيسية ننفذها الآن لِنُفعّلها لاحقاً.  
> **التاريخ:** فبراير 2026

---

## 1. الملخص التنفيذي

إضافة **تحديد موقع المسجد على الخريطة** (واختيارياً عرض المساجد على خريطة) ستؤثر على كل الأدوار بدرجات مختلفة. هذه الدراسة تجيب عن:

- هل يقدر أحد يفتح الخريطة ويشوف **كل المساجد**؟
- هل ولي الأمر يقدر يعرف **كم يبعد المسجد** عنه؟
- هل المشرف له دخل في شيء مثل **«أقرب المساجد لك»**؟
- أي **أعمال تأسيسية** نعملها الآن ونستفيد منها لاحقاً؟
- هل **سوبر أدمن** يقدر يوصل لكل المساجد وكل الخريطة وكل شيء؟

**الخلاصة المختصرة:** نعم — يمكن تصميم الصلاحيات بحيث سوبر أدمن يرى كل شيء على الخريطة؛ ولي الأمر يرى مساجد أطفاله (ومسافة إن وُجد موقعه)؛ المشرف يرى مسجده/مساجده؛ والإمام يحدد موقع مسجده. الأعمال التأسيسية (حفظ lat/lng، شاشة اختيار موقع، خريطة واحدة قابلة لإعادة الاستخدام) ننفذها الآن ونبني عليها لاحقاً (مسافات، عرض كل المساجد، إلخ).

---

## 2. من يرى ماذا؟ — جدول الصلاحيات والخرائط

| السؤال | ولي الأمر | المشرف | الإمام | سوبر أدمن |
|--------|------------|--------|--------|-----------|
| **يفتح خريطة ويشوف كل المساجد في الدولة؟** | ❌ لا (ما نعرض له كل المساجد على خريطة واحدة) | ❌ لا | ❌ لا | ✅ **نعم** — خريطة واحدة + كل المساجد |
| **يشوف مساجد أطفاله فقط على خريطة؟** | ✅ نعم (اختياري: خريطة «مساجد أطفالي») | — | — | — |
| **يعرف كم يبعد المسجد عنه؟** | ✅ نعم (إن أعطانا موقعه أو استخدم الموقع الحالي) | ✅ نعم (مثلاً «أقرب مساجد لك» أو مسجده) | يمكن (مسجده) | ✅ نعم |
| **يحدد موقع مسجده على الخريطة (تثبيت lat/lng)؟** | — | — | ✅ **نعم** (إعدادات المسجد) | ✅ نعم (يمكنه تعديل أي مسجد) |
| **يشوف قائمة/خريطة «أقرب المساجد لك»؟** | يمكن (ميزة لاحقة: اكتشاف مساجد للربط) | يمكن (إن سمحنا له بالانضمام لأكثر من مسجد) | — | ✅ نعم (كل المساجد) |
| **وصول كامل: كل المساجد + كل الخريطة + كل البيانات؟** | ❌ لا | ❌ لا | ❌ لا (مسجده فقط) | ✅ **نعم — كل شيء** |

---

## 3. التأثير التفصيلي حسب الدور

### 3.1 ولي الأمر (Parent)

| الميزة | الوصف | أولوية |
|--------|--------|--------|
| **مساجد أطفالي على خريطة** | عرض المساجد المرتبطين بها أطفاله فقط على خريطة (إن وُجدت إحداثيات). لا يعرض كل مساجد التطبيق. | متوسطة |
| **المسافة مني للمسجد** | «المسجد X على بعد ٢ كم منك» — يتطلب إما إذن الموقع الحالي أو عنوان ولي الأمر (نختاره لاحقاً). حساب المسافة: صيغة Haversine أو استخدام مكتبة من lat/lng. | متوسطة |
| **اكتشاف مساجد قريبة (لربط ابنه)** | ميزة لاحقة: «أقرب المساجد لك» عند إضافة طفل أو ربطه بمسجد — يعرض مساجد معتمدة قريبة مع المسافة. | منخفضة |

**الخلاصة:** ولي الأمر **لا** يرى كل المساجد على خريطة واحدة؛ يرى فقط ما يخص أطفاله (ومسافة إن وُجد موقعه). أي «خريطة كل المساجد» تكون لسوبر أدمن فقط.

---

### 3.2 المشرف (Supervisor)

| الميزة | الوصف | أولوية |
|--------|--------|--------|
| **مسجده على خريطة** | عرض موقع المسجد الذي ينتمي إليه (واحد أو أكثر إن سمحنا لاحقاً) على خريطة. | منخفضة |
| **أقرب المساجد لك** | مفيد إن سمحنا للمشرف بالانضمام لأكثر من مسجد: عرض قائمة أو خريطة «أقرب المساجد» بناءً على موقعه الحالي. حالياً المشرف مرتبط بمسجد واحد (كود الدعوة). | لاحق |
| **المسافة من المشرف للمسجد** | «المسجد على بعد X كم» — نفس آلية المسافة لولي الأمر. | منخفضة |

**الخلاصة:** المشرف **لا** يرى كل المساجد؛ يرى مسجده (ومساجده إن تعددت). «أقرب المساجد لك» ميزة تأتي لاحقاً عند دعم تعدد المساجد للمشرف أو اكتشاف مساجد.

---

### 3.3 الإمام (Imam)

| الميزة | الوصف | أولوية |
|--------|--------|--------|
| **تحديد موقع المسجد على الخريطة** | في إعدادات المسجد: زر «تحديد الموقع» يفتح خريطة؛ النقر يثبت النقطة ويحفظ `lat` و `lng` في جدول `mosques`. هذه **الأساس** لكل ما يلي. | **عالية — تنفذ أولاً** |
| **معاينة موقع المسجد** | في إعدادات المسجد أو في لوحة المدير: عرض موقع المسجد على خريطة صغيرة (قراءة فقط). | متوسطة |

**الخلاصة:** الإمام **لا** يرى كل المساجد؛ يحدد موقع **مسجده** فقط. كل المساجد على خريطة واحدة = سوبر أدمن فقط.

---

### 3.4 سوبر أدمن (Super Admin)

| الميزة | الوصف | أولوية |
|--------|--------|--------|
| **خريطة كل المساجد** | شاشة (أو تبويب) تعرض **كل المساجد** على خريطة واحدة — كل نقطة = مسجد معتمد/معلق/موقوف مع تمييز لوني إن أردنا. | عالية |
| **قائمة + خريطة** | تبويب المساجد الحالي (قائمة) يبقى؛ إضافة زر «عرض على الخريطة» يفتح خريطة بكل المساجد. | عالية |
| **تعديل موقع أي مسجد** | من تفاصيل المسجد: «تحديد الموقع على الخريطة» (نفس واجهة الإمام) لتحديث lat/lng لأي مسجد. | عالية |
| **إحصائيات وفلترة على الخريطة** | فلتر حسب الحالة (معتمد / قيد المراجعة / موقوف)؛ عداد لكل منطقة إن أردنا لاحقاً. | متوسطة |

**الخلاصة:** سوبر أدمن هو الوحيد الذي **يقدر يوصل لكل المساجد وكل الخريطة وكل شيء** — قائمة، خريطة شاملة بكل المساجد ومواقعهم، وتعديل بيانات أي مسجد بما فيها الموقع. **لا نهمل خطة الخريطة للسوبر أدمن** — تنفيذها ضمن المرحلة 2 من خطة الخرائط.

---

## 4. أعمال تأسيسية ننفذها الآن ونُفعّلها لاحقاً

هذه الخطوات ننفذها في المرحلة الأولى؛ كل ما يلي (مسافات، «أقرب المساجد»، واجهات إضافية) يبنى عليها.

| # | العمل التأسيسي | ماذا يعطي الآن | ماذا يُفعّل لاحقاً |
|---|----------------|----------------|---------------------|
| 1 | **التأكد من وجود `lat` و `lng` في DB و API** | نموذج المسجد يدعم الإحداثيات (موجود في المشروع). التأكد أن تحديث المسجد (إمام/أدمن) يمرّر ويخزن lat/lng. | كل ميزات الخريطة والمسافة تعتمد على هذه الحقول. |
| 2 | **شاشة اختيار موقع على الخريطة (Map Picker)** | ويدجت/شاشة واحدة قابلة لإعادة الاستخدام: خريطة + نقر لتثبيت نقطة + إرجاع `(lat, lng)`. | تُستخدم عند إنشاء مسجد، إعدادات المسجد (إمام)، وتعديل موقع مسجد (سوبر أدمن). |
| 3 | **ربط Map Picker بإعدادات المسجد (الإمام)** | الإمام يحدد موقع مسجده ويُحفظ في `mosques`. | مساجد أطفال ولي الأمر، «أقرب المساجد»، وخريطة سوبر أدمن تعرض نقاط حقيقية. |
| 4 | **خريطة عرض فقط (قابلة لإعادة الاستخدام)** | ويدجت يعرض نقاطاً على خريطة من قائمة `(lat, lng, label)`. | خريطة «مساجد أطفالي»، خريطة «كل المساجد» لسوبر أدمن، ومعاينة موقع المسجد. |
| 5 | **تسجيل تحديث الموقع في أحداث الإمام/أدمن** | حدث مثل `UpdateMosqueSettings` يدعم `lat` و `lng`؛ الـ repository و Supabase يخزنونها. | أي واجهة تقرأ المسجد ستحصل على إحداثيات صحيحة. |

بعد هذه التأسيسات يمكن لاحقاً دون تغيير جذري:

- حساب **المسافة** (Haversine أو مكتبة) بين مستخدم ومسجد.
- عرض **«أقرب المساجد»** لولي الأمر أو المشرف.
- **خريطة سوبر أدمن** بكل المساجد مع فلترة وإحصائيات.

---

## 5. سوبر أدمن: صلاحيات كاملة — تفصيل

سوبر أدمن هو الوحيد الذي:

1. **يرى كل المساجد** — قائمة (موجودة) + خريطة (جديدة).
2. **يفتح خريطة واحدة** تعرض كل المساجد (مع تمييز الحالة: معتمد / قيد المراجعة / موقوف) إن أردنا.
3. **يعدّل أي مسجد** — بما فيه الموقع (تحديد على الخريطة)، الاسم، العنوان، الحالة، إلخ.
4. **يرى إحصائيات النظام** — الإجماليات موجودة؛ يمكن إضافة إحصائيات جغرافية لاحقاً (عدد المساجد per منطقة).

**الخلاصة:** نعم — سوبر أدمن يقدر يوصل لكل المساجد وكل الخريطة وكل شيء؛ الخريطة الشاملة والتحرير الكامل للموقع مخصّصة له (وللإمام لمسجده فقط).

---

## 6. اعتبارات تقنية مختصرة

| الموضوع | التوصية |
|---------|---------|
| **مكتبة الخريطة** | `flutter_map` + `latlong2` — مجانية، بدون مفتاح API للاستخدام المعقول (OpenStreetMap). |
| **مصدر التايلات** | OpenStreetMap مع ضبط `TileLayer.userAgentPackageName` وفق وثائق flutter_map. |
| **حساب المسافة** | صيغة Haversine (دالة بسيطة من lat/lng) أو حزمة مثل `geolocator` للمسافة بين نقطتين. لا حاجة لـ API مدفوع. |
| **موقع المستخدم** | عند تفعيل «المسافة مني» أو «أقرب المساجد» نستخدم `geolocator` أو `location` مع طلب إذن الموقع من المستخدم. |
| **الخصوصية** | موقع المستخدم لا يُخزّن على الخادم إلا إن قررنا ميزة «عنوان المنزل» لاحقاً؛ حساب المسافة يمكن أن يكون على الجهاز فقط. |

---

## 7. خطة تنفيذ مقترحة (مراحل)

### المرحلة 1 — تأسيس (الآن)

1. إضافة `flutter_map` و `latlong2` إلى المشروع.
2. التأكد أن **تحديث إعدادات المسجد** (Imam + Backend) يدعم `lat` و `lng`.
3. بناء **شاشة/ويدجت اختيار موقع (Map Picker)**:
   - خريطة تفاعلية، نقر يضع علامة، زر «تأكيد» يرجع `(lat, lng)`.
4. ربط Map Picker بـ **إعدادات المسجد (الإمام)**:
   - زر «تحديد موقع المسجد على الخريطة» يفتح الـ Picker ثم يحفظ القيمة في `mosques`.

### المرحلة 2 — سوبر أدمن والخريطة الشاملة

5. ويدجت **خريطة عرض** تعرض قائمة نقاط (مساجد) مع تسميات.
6. في لوحة سوبر أدمن: إضافة **«عرض على الخريطة»** يعرض كل المساجد على الخريطة (من `getAllMosques()` مع فلتر lat/lng موجود).
7. من تفاصيل مسجد (سوبر أدمن): إمكانية **تعديل الموقع** عبر نفس Map Picker.

### المرحلة 3 — (لاحقاً) المسافات وولي الأمر

8. حساب **المسافة** بين نقطتين (Haversine).
9. لولي الأمر: عرض **مساجد أطفالي** على خريطة (إن وُجدت إحداثيات).
10. (اختياري) عرض **«المسجد X على بعد Y كم منك»** بعد طلب إذن الموقع.

### المرحلة 4 — (لاحقاً) اكتشاف مساجد

11. ميزة **«أقرب المساجد»** لولي الأمر عند ربط طفل بمسجد (أو للمشرف إن دعمنا تعدد المساجد).

---

## 8. ملخص الإجابات المباشرة

| سؤالك | الجواب |
|-------|--------|
| **هل بقدر حدا يفتح الخريطة ويشوف كل المساجد؟** | **سوبر أدمن فقط** — نعم. ولي الأمر/المشرف/الإمام لا يرون كل المساجد على خريطة واحدة. |
| **هل ولي الأمر يعرف كم يبعد المسجد عنه؟** | **نعم** — يمكن لاحقاً (بعد تثبيت موقع المسجد واختيارياً موقع ولي الأمر أو إذن الموقع الحالي). |
| **هل المشرف له دخل مثل «أقرب المساجد لك»؟** | **لاحقاً** — إن سمحنا له بأكثر من مسجد أو ميزة اكتشاف؛ حالياً يرى مسجده فقط. |
| **شو أعمال تأسيسية نعملها الآن ونُفعّلها بعدين؟** | حفظ lat/lng للمسجد، شاشة اختيار موقع (Map Picker)، ويدجت خريطة عرض؛ ربطها بإعدادات المسجد وسوبر أدمن. |
| **هل سوبر أدمن يقدر يوصل لكل المساجد وكل الخريطة وكل شيء؟** | **نعم** — قائمة + خريطة كل المساجد + تعديل أي مسجد (بما فيه الموقع). |

---

*انتهت الدراسة. يمكن استخدام هذا الملف كمرجع لخطة التنفيذ في `tasks/` أو في اجتماع التخطيط.*
