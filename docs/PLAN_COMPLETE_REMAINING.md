# خطة إكمال كل الناقص — صلاتي حياتي

كل ما تبقى من الخطة الأصلية (ما كان مذكوراً في PLAN_FINAL و STUDY و STATUS_AFTER_ANTIGRAVITY) — مرتب حسب الأولوية وقابل للت ticking. الميزات الجديدة غير المخططة ليست هنا.

---

## تم بالفعل (لا تحتاج عمل)

- [x] AttendanceValidationService + ربطه في recordAttendance
- [x] فصل صلاحيات المسابقة (الإمام فقط)
- [x] إلغاء حضور خاطئ (024 + RPC + SupervisorRepository + ImamRepository + ImamBloc)
- [x] أوقات صلاة حسب المسجد (025 + MosqueModel + التحقق يستخدم lat/lng من DB)
- [x] ImamRepository + ImamBloc
- [x] AdminRepository + AdminBloc
- [x] RealtimeService: دوال subscribe للتصحيحات والملاحظات والإعلانات (موجودة في الكود)

---

## المرحلة أ — إغلاق ثغرات ولي الأمر والإمام (أولوية عالية)

### أ.1 شاشة إنشاء طلب تصحيح لولي الأمر

- [x] إضافة مسار في الـ Router، مثلاً: `/parent/children/:id/request-correction` (أو من قائمة أطفالي بدون :id ثم اختيار الطفل).
- [x] إنشاء شاشة `RequestCorrectionScreen`: اختيار الصلاة، التاريخ (date picker)، ملاحظة اختيارية، مسجد (إن كان الطفل مرتبطاً بأكثر من مسجد). زر إرسال يستدعي `CorrectionBloc.add(CreateCorrectionRequest(...))`.
- [x] التحقق: الطفل مرتبط بمسجد (في mosque_children). إن لم يكن → رسالة "اربط ابنك بمسجد أولاً".
- [x] إضافة زر "طلب تصحيح" في بطاقة الطفل (`ChildCardScreen`) و/أو في قائمة أطفالي يوجّه للشاشة الجديدة.
- [x] تسجيل الشاشة والـ Bloc في الـ Router و injection إن لزم.

### أ.2 عرض طلبات التصحيح التي أرسلها ولي الأمر ("طلباتي")

- [x] إما شاشة مستقلة `/parent/corrections` أو تبويب داخل لوحة ولي الأمر يعرض قائمة طلباتي.
- [x] استدعاء `CorrectionBloc.add(LoadMyCorrections())` وعرض النتيجة (قيد المراجعة، موافق، مرفوض) من `CorrectionLoaded(list)`.
- [x] إضافة رابط في الدراور أو الرئيسية: "طلبات التصحيح" أو "طلباتي".

### أ.3 تنفيذ migration 026 (الإعلانات) على قاعدة البيانات

- [ ] نسخ محتوى `supabase/migrations/026_announcements.sql` كاملاً ولصقه في Supabase → SQL Editor وتشغيله (إضافة أعمدة، سياسات RLS، Realtime). مرة واحدة كافية.

---

## المرحلة ب — واجهة موقع المسجد + عرض الابن للباركود

### ب.1 الإمام يحدد موقع المسجد

- [ ] واجهة للإمام: إعدادات المسجد (أو خطوة عند إنشاء المسجد) تحتوي على **الموقع**:
  - خيار "استخدام موقعي الحالي" (Geolocator) وحفظ lat/lng في mosques،
  - أو إدخال lat/lng يدوياً،
  - أو خريطة صغيرة (اختياري).
- [ ] حفظ عبر MosqueRepository / ImamRepository (تحديث mosques بـ lat, lng). الـ MosqueModel يدعم الحقول مسبقاً.
- [ ] التأكد أن التحضير (و AttendanceValidationService) يستخدم إحداثيات المسجد من DB (حالياً يُجلب في recordAttendance ويُمرَّر لـ canRecordNow — لا حاجة لتغيير إن كان يعمل).

### ب.2 عرض الابن للباركود / ربط جهاز الابن

- [ ] من بطاقة الطفل (ولي الأمر): زر "ربط جهاز الابن" يفتح شاشة أو ديالوغ يعرض **كود ربط** (مثلاً 6 أحرف) صالح مدة محددة.
- [ ] في الـ Backend: إما جدول مؤقت (مثلاً `child_link_codes`: child_id, code, expires_at) أو توليد كود وتخزينه في Supabase مع RLS مناسب؛ دالة للتحقق من الكود وإرجاع child_id (أو بيانات العرض فقط).
- [ ] في التطبيق: شاشة دخول أو بداية للتطبيق تحتوي خيار "لدي كود ربط" → إدخال الكود → التحقق → تخزين محلي (مثلاً flutter_secure_storage) أن هذا الجهاز مربوط بـ child_id معيّن.
- [ ] عند فتح التطبيق: إن وُجد ربط محلي، توجيه لشاشة **عرض الابن**: الاسم، الباركود، (اختياري) حضور اليوم ونقاطي. بدون تسجيل دخول ولي أمر.
- [ ] خيار "فسخ الربط" من شاشة الابن (يحذف الربط المحلي فقط).

---

## المرحلة ج — المسابقة النشطة + Realtime في الواجهات

### ج.1 شاشة المسابقة النشطة لولي الأمر

- [ ] مسار مثل `/parent/competition` (أو من الرئيسية: "المسابقة الحالية").
- [ ] جلب المسابقة النشطة لمسجد أحد أطفال المستخدم (من CompetitionRepository أو ChildRepository إن وُجدت دالة مناسبة)، وترتيب أطفاله (getLeaderboard أو ما يعادل).
- [ ] عرض اسم المسابقة، الفترة، وترتيب أطفال المستخدم.

### ج.2 ربط Realtime في الشاشات

- [ ] في شاشة قائمة التصحيحات (للإمام/المشرف): استدعاء `RealtimeService.subscribeCorrectionRequests(mosqueId, onEvent)` وعند الحدث إعادة تحميل القائمة أو تحديث الـ Bloc (مثلاً LoadPendingCorrections).
- [ ] في صندوق الملاحظات (ولي الأمر): استدعاء `RealtimeService.subscribeNotesForChildren(childIds, onEvent)` وعند الحدث إعادة جلب الملاحظات أو تحديث الـ Bloc.
- [ ] (اختياري) التأكد من تفعيل Realtime لجدول correction_requests و notes في Supabase (Publication).

---

## المرحلة د — إلغاء الحضور من الواجهة + الإعلانات واجهة

### د.1 زر/إجراء إلغاء حضور (للإمام والمشرف)

- [ ] في قائمة حضور اليوم أو في مكان مناسب للإمام: زر "إلغاء" بجانب سجل حضور يستدعي `ImamBloc.add(CancelAttendanceByImam(attendanceId))` وعرض رسالة نجاح/خطأ.
- [ ] للمشرف: إن وُجد عرض لقائمة الحضور الذي سجّله، زر إلغاء يستدعي `SupervisorRepository.cancelAttendance` (أو حدث في ScannerBloc إن كان المنطق هناك). الـ RPC يرفض تلقائياً إن انتهت الـ 24 ساعة أو لم يكن المسجّل.

### د.2 واجهات الإعلانات

- [ ] للإمام: شاشة أو قسم "إعلانات المسجد" — إنشاء إعلان (عنوان، نص)، تعديل، حذف. استدعاء AnnouncementRepository + AnnouncementBloc.
- [ ] للمشرف و/أو ولي الأمر: شاشة أو قسم "إعلانات المسجد" — قراءة إعلانات المسجد (قائمة). ربط مع AnnouncementBloc و Realtime إن رغبت.

---

## المرحلة هـ — تحسينات الجودة (حسب الوقت)

### هـ.1 رسائل خطأ واضحة

- [ ] توحيد عرض AppFailure في الواجهة (toast أو snackbar أو نص في الشاشة) برسالة مفهومة (كود مسجد خاطئ، انتهت مهلة التسجيل، طلب مرفوض، إلخ).
- [ ] التأكد أن كل استدعاءات الريپو التي ترمي AppFailure تُعرض للمستخدم ولا تُبلع.

### هـ.2 Pull-to-refresh

- [ ] في قوائم: حضور اليوم، طلبات التصحيح (إمام/مشرف)، ملاحظات ولي الأمر، المسابقات — إضافة سحب للتحديث (RefreshIndicator) وإعادة تحميل البيانات.

### هـ.3 Skeleton / تحميل أنيق

- [ ] في الشاشات الرئيسية وقوائم التصحيحات والملاحظات: استبدال أو استكمال الـ spinner بهيكل تحميل (shimmer/skeleton) إن وُجد مكوّن في المشروع.

### هـ.4 (اختياري) Pagination و Caching و Defense in depth

- [ ] Pagination في القوائم الكبيرة (مثلاً طلبات التصحيح، المستخدمين للأدمن) إن ظهرت حاجة.
- [ ] Caching بسيط لقائمة الطلاب أو إعدادات المسجد إن رغبت.
- [ ] تحقق من دور المستخدم في الكود (مثلاً قبل استدعاء عمليات حساسة) بجانب RLS.

---

## مؤجّل (خارج نطاق "إكمال الخطة الحالية")

- أقرب مسجد لولي الأمر  
- اعتراف/تحقق المسجد  
- مسجد أساسي + ثانوي (واجهة ربط الطفل)  
- Offline للمسجد  
- FCM من الخادم  
- الجوائز والشارات (واجهة)

---

## ملخص سريع — ترتيب التنفيذ المقترح

1. **أ.1 + أ.2** — طلب تصحيح لولي الأمر (شاشة إنشاء + شاشة طلباتي).  
2. **أ.3** — تشغيل 026 في SQL Editor.  
3. **ب.1** — واجهة موقع المسجد للإمام.  
4. **ب.2** — ربط جهاز الابن + شاشة عرض الابن.  
5. **ج.1** — شاشة المسابقة النشطة لولي الأمر.  
6. **ج.2** — ربط Realtime في شاشات التصحيحات والملاحظات.  
7. **د.1 + د.2** — إلغاء حضور من الواجهة + واجهات الإعلانات.  
8. **هـ.1 – هـ.4** — تحسينات الجودة حسب الوقت.

---

*هذه الوثيقة مرجع واحد لإكمال كل ما تبقى من الخطة؛ يُحدَّث عند إنجاز بنود.*
